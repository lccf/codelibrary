var collie=collie||{};!function(){collie.version="1.1.1",collie.Class=function(o,oParent){var F,$init=null,checkDirectCall=function(){return!0};if("$init"in o&&($init=o.$init,delete o.$init),"undefined"==typeof oParent)F=function(){var args=arguments;return this instanceof F?(args.length&&args[0]===checkDirectCall&&(args=args[1]),void(null!==$init&&$init.apply(this,args))):new F(checkDirectCall,args)};else{F=function(){var args=arguments;return this instanceof F?(args.length&&args[0]===checkDirectCall&&(args=args[1]),oParent.apply(this,args),void(null!==$init&&$init.apply(this,args))):new F(checkDirectCall,args)};var Parent=function(){};Parent.prototype=oParent.prototype,F.$super=oParent.prototype,F.prototype=new Parent,F.prototype.constructor=F}for(var i in o)o.hasOwnProperty(i)&&"prototype"!==i&&(F.prototype[i]=o[i]);return F},collie.util=new(collie.Class({$init:function(){this._sCSSPrefix=null,this._htDeviceInfo=null,this._bSupport3d=null,this._bSupportCSS3=null,this._htBoundary={left:0,right:0,top:0,bottom:0}},getDisplayObjectById:function(nId){return collie.DisplayObject.htFactory[nId]},getDisplayObjectByName:function(sName){for(var i in collie.DisplayObject.htFactory)if(collie.DisplayObject.htFactory[i].get("name")===sName)return collie.DisplayObject.htFactory[i];return!1},getDeviceInfo:function(sAgent){if(null!==this._htDeviceInfo&&"undefined"==typeof sAgent)return this._htDeviceInfo;var aMat=null,bIsDesktop=!1,bSupportCanvas="undefined"!=typeof CanvasRenderingContext2D,bIsAndroid=!1,bIsIOS=!1,bIsIE=!1,bHasChrome=/chrome/i.test(sAgent)?!0:!1,bHiggs=/Higgs/i.test(sAgent)?!0:!1,sAgent=sAgent||navigator.userAgent,nVersion=0;return/android/i.test(sAgent)?(bIsAndroid=!0,aMat=sAgent.toString().match(/android ([0-9]\.[0-9])\.?([0-9]?)/i),aMat&&aMat[1]&&(nVersion=(parseFloat(aMat[1])+(aMat[2]?.01*aMat[2]:0)).toFixed(2))):/(iphone|ipad|ipod)/i.test(sAgent)?(bIsIOS=!0,aMat=sAgent.toString().match(/([0-9]_[0-9])/i),aMat&&aMat[1]&&(nVersion=parseFloat(aMat[1].replace(/_/,".")))):(bIsDesktop=!0,/(MSIE)/i.test(sAgent)&&(bIsIE=!0,aMat=sAgent.toString().match(/MSIE ([0-9])/i),aMat&&aMat[1]&&(nVersion=parseInt(aMat[1],10)))),this._htDeviceInfo={supportCanvas:bSupportCanvas,desktop:bIsDesktop,android:bIsAndroid?nVersion:!1,ios:bIsIOS?nVersion:!1,ie:bIsIE?nVersion:!1,chrome:bHasChrome,higgs:bHiggs},this._htDeviceInfo},getCSSPrefix:function(sName,bJavascript){var sResult="";if(null===this._sCSSPrefix&&(this._sCSSPrefix="","undefined"!=typeof document.body.style.webkitTransform?this._sCSSPrefix="-webkit-":"undefined"!=typeof document.body.style.MozTransform?this._sCSSPrefix="-moz-":"undefined"!=typeof document.body.style.OTransform?this._sCSSPrefix="-o-":"undefined"!=typeof document.body.style.msTransform&&(this._sCSSPrefix="-ms-")),sResult=this._sCSSPrefix+(sName?sName:""),bJavascript){var aTmp=sResult.split("-");sResult="";for(var i=0,len=aTmp.length;len>i;i++)aTmp[i]&&(sResult+=sResult?aTmp[i].substr(0,1).toUpperCase()+aTmp[i].substr(1):aTmp[i]);("-moz-"===this._sCSSPrefix||"-o-"===this._sCSSPrefix)&&(sResult=sResult.substr(0,1).toUpperCase()+sResult.substr(1))}return sResult},getSupportCSS3:function(){return null===this._bSupportCSS3&&(this._bSupportCSS3="undefined"!=typeof document.body.style[collie.util.getCSSPrefix("transform",!0)]||"undefined"!=typeof document.body.style.transform),this._bSupportCSS3},getSupportCSS3d:function(){return null===this._bSupport3d&&(this._bSupport3d=("undefined"!=typeof document.body.style[collie.util.getCSSPrefix("perspective",!0)]||"undefined"!=typeof document.body.style.perspective)&&(!collie.util.getDeviceInfo().android||collie.util.getDeviceInfo().android>=4)),this._bSupport3d},toRad:function(nDeg){return nDeg*Math.PI/180},toDeg:function(nRad){return 180*nRad/Math.PI},approximateValue:function(nValue){return Math.round(1e7*nValue)/1e7},fixAngle:function(nAngleRad){var nAngleDeg=collie.util.toDeg(nAngleRad);return nAngleDeg-=360*Math.floor(nAngleDeg/360),collie.util.toRad(nAngleDeg)},getDistance:function(x1,y1,x2,y2){return Math.sqrt(Math.pow(x2-x1,2)+Math.pow(y2-y1,2))},getBoundary:function(aPoints){for(var nMinX=aPoints[0][0],nMaxX=aPoints[0][0],nMinY=aPoints[0][1],nMaxY=aPoints[0][1],i=1,len=aPoints.length;len>i;i++)nMinX=Math.min(nMinX,aPoints[i][0]),nMaxX=Math.max(nMaxX,aPoints[i][0]),nMinY=Math.min(nMinY,aPoints[i][1]),nMaxY=Math.max(nMaxY,aPoints[i][1]);return{left:nMinX,right:nMaxX,top:nMinY,bottom:nMaxY}},getBoundaryToPoints:function(htBoundary){return[[htBoundary.left,htBoundary.top],[htBoundary.right,htBoundary.top],[htBoundary.right,htBoundary.bottom],[htBoundary.left,htBoundary.bottom]]},queryString:function(){var htResult={};if(location.search)for(var aParam=location.search.substr(1).split("&"),i=0,len=aParam.length;len>i;i++){var aKeyValue=aParam[i].split("=");htResult[aKeyValue.shift()]=aKeyValue.join("=")}return htResult},cloneObject:function(oSource){var oReturn={};for(var i in oSource)oReturn[i]=oSource[i];return oReturn},pushWithSort:function(aTarget,oDisplayObject){for(var bAdded=!1,i=0,len=aTarget.length;len>i;i++)if(aTarget[i]._htOption.zIndex>oDisplayObject._htOption.zIndex){aTarget.splice(i,0,oDisplayObject),bAdded=!0;break}bAdded||aTarget.push(oDisplayObject)},addEventListener:function(el,sName,fHandler,bUseCapture){"string"==typeof el&&(el=document.getElementById(el)),"addEventListener"in el?el.addEventListener(sName,fHandler,bUseCapture):el.attachEvent("on"+sName,fHandler,bUseCapture)},removeEventListener:function(el,sName,fHandler,bUseCapture){"string"==typeof el&&(el=document.getElementById(el)),"removeEventListener"in el?el.removeEventListener(sName,fHandler,bUseCapture):el.detachEvent("on"+sName,fHandler,bUseCapture)},stopEventDefault:function(e){e=e||window.event,"preventDefault"in e&&e.preventDefault(),e.returnValue=!1},getPosition:function(el){"string"==typeof el&&(el=document.getElementById(el));var elDocument=el.ownerDocument||el.document||document,elHtml=elDocument.documentElement,elBody=elDocument.body,htPosition={};if("getBoundingClientRect"in el){var htBox=el.getBoundingClientRect();htPosition.x=htBox.left,htPosition.x+=elHtml.scrollLeft||elBody.scrollLeft,htPosition.y=htBox.top,htPosition.y+=elHtml.scrollTop||elBody.scrollTop,htPosition.width=htBox.width,htPosition.height=htBox.height}else{htPosition.x=0,htPosition.y=0,htPosition.width=el.offsetWidth,htPosition.height=el.offsetHeight;for(var o=el;o;o=o.offsetParent)htPosition.x+=o.offsetLeft,htPosition.y+=o.offsetTop;for(var o=el.parentNode;o&&"BODY"!==o.tagName;o=o.parentNode)"TR"===o.tagName&&(htPosition.y+=2),htPosition.x-=o.scrollLeft,htPosition.y-=o.scrollTop}return htPosition}})),collie.util.getDeviceInfo().ios&&window.addEventListener("load",function(){setTimeout(function(){document.body.scrollTop=0},300)}),Function.prototype.bind||(Function.prototype.bind=function(oThis){if("function"!=typeof this)throw new TypeError("Function.prototype.bind - what is trying to be bound is not callable");var aArgs=Array.prototype.slice.call(arguments,1),fToBind=this,fNOP=function(){},fBound=function(){return fToBind.apply(this instanceof fNOP?this:oThis,aArgs.concat(Array.prototype.slice.call(arguments)))};return fNOP.prototype=this.prototype,fBound.prototype=new fNOP,fBound});var CP=window.CanvasRenderingContext2D&&CanvasRenderingContext2D.prototype;CP&&CP.lineTo&&(CP._dashedLineProperty={index:0,length:0},CP.resetDashedLine=function(){this._dashedLineProperty={index:0,length:0}},CP.dashedLine=function(x,y,x2,y2,da,width){da||(da=[10,5]);for(var dx=x2-x,dy=y2-y,len=Math.sqrt(dx*dx+dy*dy),rot=Math.atan2(dy,dx),dc=da.length,di=this._dashedLineProperty.index||0,cx=this._dashedLineProperty.length||0,sx=0,sy=0;len>cx;)(0!==sx||0===cx)&&(cx+=da[di++%dc]*width),cx>len&&(this._dashedLineProperty.length=cx-len,cx=len),sx=x+cx*Math.cos(rot),sy=y+cx*Math.sin(rot),di%2===1?this.lineTo(sx,sy):this.moveTo(sx,sy);this._dashedLineProperty.index=di}),collie.raphaelDashArray={"":[0],none:[0],"-":[3,1],".":[1,1],"-.":[3,1,1,1],"-..":[3,1,1,1,1,1],". ":[1,3],"- ":[4,3],"--":[8,3],"- .":[4,3,1,3],"--.":[8,3,1,3],"--..":[8,3,1,3,1,3]}}(),collie.Effect=function(fEffect){if(this instanceof arguments.callee)throw new Error("You can't create a instance of this");var rxNumber=/^(\-?[0-9\.]+)(%|px|pt|em)?$/,rxRGB=/^rgb\(([0-9]+)\s?,\s?([0-9]+)\s?,\s?([0-9]+)\)$/i,rxHex=/^#([0-9A-F]{2})([0-9A-F]{2})([0-9A-F]{2})$/i,rx3to6=/^#([0-9A-F])([0-9A-F])([0-9A-F])$/i,getUnitAndValue=function(v){var sUnit,nValue=v;return rxNumber.test(v)?(nValue=parseFloat(v),sUnit=RegExp.$2||""):rxRGB.test(v)?(nValue=[parseInt(RegExp.$1,10),parseInt(RegExp.$2,10),parseInt(RegExp.$3,10)],sUnit="color"):rxHex.test(v=v.replace(rx3to6,"#$1$1$2$2$3$3"))&&(nValue=[parseInt(RegExp.$1,16),parseInt(RegExp.$2,16),parseInt(RegExp.$3,16)],sUnit="color"),{nValue:nValue,sUnit:sUnit}};return function(nStart,nEnd){var sUnit;if(arguments.length>1?(nStart=getUnitAndValue(nStart),nEnd=getUnitAndValue(nEnd),sUnit=nEnd.sUnit):(nEnd=getUnitAndValue(nStart),nStart=null,sUnit=nEnd.sUnit),nStart&&nEnd&&nStart.sUnit!=nEnd.sUnit)throw new Error("unit error");nStart=nStart&&nStart.nValue,nEnd=nEnd&&nEnd.nValue;var fReturn=function(p){var nValue=fEffect(p),getResult=function(s,d){return(d-s)*nValue+s+sUnit};if("color"==sUnit){var r=Math.max(0,Math.min(255,parseInt(getResult(nStart[0],nEnd[0]),10)))<<16;r|=Math.max(0,Math.min(255,parseInt(getResult(nStart[1],nEnd[1]),10)))<<8,r|=Math.max(0,Math.min(255,parseInt(getResult(nStart[2],nEnd[2]),10))),r=r.toString(16).toUpperCase();for(var i=0;6-r.length;i++)r="0"+r;return"#"+r}return getResult(nStart,nEnd)};return null===nStart&&(fReturn.setStart=function(s){if(s=getUnitAndValue(s),s.sUnit!=sUnit)throw new Error("unit eror");nStart=s.nValue}),fReturn}},collie.Effect.linear=collie.Effect(function(s){return s}),collie.Effect.easeInSine=collie.Effect(function(s){return 1==s?1:-Math.cos(s*(Math.PI/2))+1}),collie.Effect.easeOutSine=collie.Effect(function(s){return Math.sin(s*(Math.PI/2))}),collie.Effect.easeInOutSine=collie.Effect(function(s){return.5>s?.5*collie.Effect.easeInSine(0,1)(2*s):.5*collie.Effect.easeOutSine(0,1)(2*s-1)+.5}),collie.Effect.easeOutInSine=collie.Effect(function(s){return.5>s?.5*collie.Effect.easeOutSine(0,1)(2*s):.5*collie.Effect.easeInSine(0,1)(2*s-1)+.5}),collie.Effect.easeInQuad=collie.Effect(function(s){return s*s}),collie.Effect.easeOutQuad=collie.Effect(function(s){return-(s*(s-2))}),collie.Effect.easeInOutQuad=collie.Effect(function(s){return.5>s?.5*collie.Effect.easeInQuad(0,1)(2*s):.5*collie.Effect.easeOutQuad(0,1)(2*s-1)+.5}),collie.Effect.easeOutInQuad=collie.Effect(function(s){return.5>s?.5*collie.Effect.easeOutQuad(0,1)(2*s):.5*collie.Effect.easeInQuad(0,1)(2*s-1)+.5}),collie.Effect.easeInCubic=collie.Effect(function(s){return Math.pow(s,3)}),collie.Effect.easeOutCubic=collie.Effect(function(s){return Math.pow(s-1,3)+1}),collie.Effect.easeInOutCubic=collie.Effect(function(s){return.5>s?.5*collie.Effect.easeIn(0,1)(2*s):.5*collie.Effect.easeOut(0,1)(2*s-1)+.5}),collie.Effect.easeOutInCubic=collie.Effect(function(s){return.5>s?.5*collie.Effect.easeOut(0,1)(2*s):.5*collie.Effect.easeIn(0,1)(2*s-1)+.5}),collie.Effect.easeInQuart=collie.Effect(function(s){return Math.pow(s,4)}),collie.Effect.easeOutQuart=collie.Effect(function(s){return-(Math.pow(s-1,4)-1)}),collie.Effect.easeInOutQuart=collie.Effect(function(s){return.5>s?.5*collie.Effect.easeInQuart(0,1)(2*s):.5*collie.Effect.easeOutQuart(0,1)(2*s-1)+.5}),collie.Effect.easeOutInQuart=collie.Effect(function(s){return.5>s?.5*collie.Effect.easeOutQuart(0,1)(2*s):.5*collie.Effect.easeInQuart(0,1)(2*s-1)+.5}),collie.Effect.easeInQuint=collie.Effect(function(s){return Math.pow(s,5)}),collie.Effect.easeOutQuint=collie.Effect(function(s){return Math.pow(s-1,5)+1}),collie.Effect.easeInOutQuint=collie.Effect(function(s){return.5>s?.5*collie.Effect.easeInQuint(0,1)(2*s):.5*collie.Effect.easeOutQuint(0,1)(2*s-1)+.5}),collie.Effect.easeOutInQuint=collie.Effect(function(s){return.5>s?.5*collie.Effect.easeOutQuint(0,1)(2*s):.5*collie.Effect.easeInQuint(0,1)(2*s-1)+.5}),collie.Effect.easeInCircle=collie.Effect(function(s){return-(Math.sqrt(1-s*s)-1)}),collie.Effect.easeOutCircle=collie.Effect(function(s){return Math.sqrt(1-(s-1)*(s-1))}),collie.Effect.easeInOutCircle=collie.Effect(function(s){return.5>s?.5*collie.Effect.easeInCircle(0,1)(2*s):.5*collie.Effect.easeOutCircle(0,1)(2*s-1)+.5}),collie.Effect.easeOutInCircle=collie.Effect(function(s){return.5>s?.5*collie.Effect.easeOutCircle(0,1)(2*s):.5*collie.Effect.easeInCircle(0,1)(2*s-1)+.5}),collie.Effect.easeInBack=collie.Effect(function(s){var n=1.70158;return 1==s?1:s/1*(s/1)*((1+n)*s-n)}),collie.Effect.easeOutBack=collie.Effect(function(s){var n=1.70158;return 0===s?0:(s=s/1-1)*s*((n+1)*s+n)+1}),collie.Effect.easeInOutBack=collie.Effect(function(s){return.5>s?.5*collie.Effect.easeInBack(0,1)(2*s):.5*collie.Effect.easeOutBack(0,1)(2*s-1)+.5}),collie.Effect.easeInElastic=collie.Effect(function(s){var n,p=0,a=0;return 0===s?0:1==(s/=1)?1:(p||(p=.3),!a||1>a?(a=1,n=p/4):n=p/(2*Math.PI)*Math.asin(1/a),-(a*Math.pow(2,10*(s-=1))*Math.sin(2*(s-1)*Math.PI/p)))}),collie.Effect.easeOutElastic=collie.Effect(function(s){var n,p=0,a=0;return 0===s?0:1==(s/=1)?1:(p||(p=.3),!a||1>a?(a=1,n=p/4):n=p/(2*Math.PI)*Math.asin(1/a),a*Math.pow(2,-10*s)*Math.sin(2*(s-n)*Math.PI/p)+1)}),collie.Effect.easeInOutElastic=collie.Effect(function(s){var n,p=0,a=0;return 0===s?0:2==(s/=.5)?1:(p||(p=.3*1.5),!a||1>a?(a=1,n=p/4):n=p/(2*Math.PI)*Math.asin(1/a),1>s?-.5*a*Math.pow(2,10*(s-=1))*Math.sin(2*(s-n)*Math.PI/p):a*Math.pow(2,-10*(s-=1))*Math.sin(2*(s-n)*Math.PI/p)*.5+1)}),collie.Effect.easeOutBounce=collie.Effect(function(s){return 1/2.75>s?7.5625*s*s:2/2.75>s?7.5625*(s-=1.5/2.75)*s+.75:2.5/2.75>s?7.5625*(s-=2.25/2.75)*s+.9375:7.5625*(s-=2.625/2.75)*s+.984375}),collie.Effect.easeInBounce=collie.Effect(function(s){return 1-collie.Effect.easeOutBounce(0,1)(1-s)}),collie.Effect.easeInOutBounce=collie.Effect(function(s){return.5>s?.5*collie.Effect.easeInBounce(0,1)(2*s):.5*collie.Effect.easeOutBounce(0,1)(2*s-1)+.5}),collie.Effect.easeInExpo=collie.Effect(function(s){return 0===s?0:Math.pow(2,10*(s-1))}),collie.Effect.easeOutExpo=collie.Effect(function(s){return 1==s?1:-Math.pow(2,-10*s/1)+1}),collie.Effect.easeInOutExpo=collie.Effect(function(s){return.5>s?.5*collie.Effect.easeInExpo(0,1)(2*s):.5*collie.Effect.easeOutExpo(0,1)(2*s-1)+.5}),collie.Effect.easeOutInExpo=collie.Effect(function(s){return.5>s?.5*collie.Effect.easeOutExpo(0,1)(2*s):.5*collie.Effect.easeInExpo(0,1)(2*s-1)+.5}),collie.Effect._cubicBezier=function(x1,y1,x2,y2){return function(t){function sampleCurveX(t){return((ax*t+bx)*t+cx)*t}function sampleCurveY(t){return((ay*t+by)*t+cy)*t}function sampleCurveDerivativeX(t){return(3*ax*t+2*bx)*t+cx}function solveCurveX(x,epsilon){var t0,t1,t2,x2,d2,i;for(t2=x,i=0;8>i;i++){if(x2=sampleCurveX(t2)-x,Math.abs(x2)<epsilon)return t2;if(d2=sampleCurveDerivativeX(t2),Math.abs(d2)<1e-6)break;t2-=x2/d2}if(t0=0,t1=1,t2=x,t0>t2)return t0;if(t2>t1)return t1;for(;t1>t0;){if(x2=sampleCurveX(t2),Math.abs(x2-x)<epsilon)return t2;x>x2?t0=t2:t1=t2,t2=.5*(t1-t0)+t0}return t2}var cx=3*x1,bx=3*(x2-x1)-cx,ax=1-cx-bx,cy=3*y1,by=3*(y2-y1)-cy,ay=1-cy-by;return sampleCurveY(solveCurveX(t,.005))}},collie.Effect.cubicBezier=function(x1,y1,x2,y2){return collie.Effect(collie.Effect._cubicBezier(x1,y1,x2,y2))},collie.Effect.cubicEase=collie.Effect.cubicBezier(.25,.1,.25,1),collie.Effect.cubicEaseIn=collie.Effect.cubicBezier(.42,0,1,1),collie.Effect.cubicEaseOut=collie.Effect.cubicBezier(0,0,.58,1),collie.Effect.cubicEaseInOut=collie.Effect.cubicBezier(.42,0,.58,1),collie.Effect.cubicEaseOutIn=collie.Effect.cubicBezier(0,.42,1,.58),collie.Effect.overphase=collie.Effect(function(s){return s/=.652785,(Math.sqrt((2-s)*s)+.1*s).toFixed(5)}),collie.Effect.sinusoidal=collie.Effect(function(s){return-Math.cos(s*Math.PI)/2+.5}),collie.Effect.mirror=collie.Effect(function(s){return collie.Effect.sinusoidal(0,1)(.5>s?2*s:1-2*(s-.5))}),collie.Effect.pulse=function(nPulse){return collie.Effect(function(s){return-Math.cos(s*(nPulse-.5)*2*Math.PI)/2+.5})},collie.Effect.wave=function(nPeriod,nHeight){return collie.Effect(function(s){return(nHeight||1)*Math.sin(360*nPeriod*s*Math.PI/180).toFixed(5)})},collie.Effect.easeIn=collie.Effect.easeInCubic,collie.Effect.easeOut=collie.Effect.easeOutCubic,collie.Effect.easeInOut=collie.Effect.easeInOutCubic,collie.Effect.easeOutIn=collie.Effect.easeOutInCubic,collie.Effect.bounce=collie.Effect.easeOutBounce,collie.Effect.elastic=collie.Effect.easeInElastic,collie.Component=collie.Class({$init:function(){this._bInitOption=!1,this._htOption={},this._htOptionSetter={},this._htHandler={}},option:function(vName,vValue,bNotOverwrite){if("object"==typeof vName)if(this._bInitOption)for(var i in vName)this.option(i,vName[i],bNotOverwrite);else this._htOption=collie.util.cloneObject(vName),this._bInitOption=!0;else{if("string"!=typeof vName)return this._htOption;if(void 0===vValue)return this._htOption[vName];bNotOverwrite&&"undefined"!=typeof this._htOption[vName]||(this._htOption[vName]=vValue,void 0!==this._htOptionSetter[vName]&&this._htOptionSetter[vName](vValue),this._bInitOption=!0)}},get:function(sName){return this.option(sName)},set:function(sName,vValue,bNotOverwrite){return this.option(sName,vValue,bNotOverwrite),this},unset:function(sKey){this._htOption&&"undefined"!=typeof this._htOption[sKey]&&delete this._htOption[sKey]},optionSetter:function(sName,fSetter){this._htOptionSetter[sName]=fSetter},fireEvent:function(sName,oEvent){if("undefined"!=typeof this._htHandler[sName]&&this._htHandler[sName].length>0){oEvent=oEvent||{},oCustomEvent=new collie.ComponentEvent(sName,oEvent);for(var aHandler=this._htHandler[sName].concat(),bCanceled=!1,i=0,len=aHandler.length;len>i;i++)this._htHandler[sName][i](oCustomEvent),oCustomEvent.isStop()&&(bCanceled=!0);if(bCanceled)return!1}return!0},attach:function(vEvent,fHandler){if("string"!=typeof vEvent)for(var i in vEvent)this.attach(i,vEvent[i]);else{this._htHandler[vEvent]=this._htHandler[vEvent]||[];var aHandler=this._htHandler[vEvent];if(!fHandler)return this;for(var i=0,len=aHandler.length;len>i;i++)if(aHandler[i]===fHandler)return this;aHandler.push(fHandler)}return this},detach:function(vEvent,fHandler){if("string"!=typeof vEvent)for(var i in vEvent)this.detach(i,vEvent[i]);else if(void 0!==this._htHandler[vEvent]){var aHandler=this._htHandler[vEvent];if(fHandler){for(var i=0,len=aHandler.length;len>i;i++)if(aHandler[i]===fHandler){this._htHandler[vEvent].splice(i,1),this._htHandler[vEvent].length<1&&delete this._htHandler[vEvent];break}}else delete this._htHandler[vEvent]}},detachAll:function(sName){sName?void 0!==this._htHandler[sName]&&(this._htHandler[sName]=[]):this._htHandler={}}}),collie.ComponentEvent=collie.Class({$init:function(sName,oEvent){if(this.type=sName,this._bCanceled=!1,oEvent)for(var i in oEvent)this[i]=oEvent[i]},stop:function(){this._bCanceled=!0},isStop:function(){return this._bCanceled}}),collie.SpriteSheet=collie.Class({$init:function(){this._htSpriteSheet={}},add:function(sImageName,vSpriteName,nOffsetX,nOffsetY,nWidth,nHeight,nSpriteLength){if("object"==typeof vSpriteName)if(vSpriteName instanceof Array)for(var i=0,l=vSpriteName.length;l>i;i++)this.add.apply(this,[sImageName,i].concat(vSpriteName[i]));else for(var i in vSpriteName)this.add.apply(this,[sImageName,i].concat(vSpriteName[i]));else this._htSpriteSheet[sImageName]=this._htSpriteSheet[sImageName]||{},"undefined"!=typeof nWidth?collie.ImageManager.getImage(sImageName,function(el){this._addWithSpriteLength(el,sImageName,vSpriteName,nOffsetX,nOffsetY,nWidth,nHeight,nSpriteLength)}.bind(this)):this._htSpriteSheet[sImageName][vSpriteName]=[nOffsetX,nOffsetY]},_addWithSpriteLength:function(elImage,sImageName,sSpriteName,nOffsetX,nOffsetY,nWidth,nHeight,nSpriteLength){var aSpriteList=this._htSpriteSheet[sImageName][sSpriteName]=[],nImageWidth=elImage.width,nImageHeight=elImage.height;collie.Renderer.isRetinaDisplay()&&(nImageWidth/=2,nImageHeight/=2);var x=nOffsetX,y=nOffsetY;for(i=0;nSpriteLength>i&&(x>=nImageWidth&&(x=0,y+=nHeight),!(y>=nImageHeight));i++)aSpriteList.push([x,y]),x+=nWidth},remove:function(sImageName){this._htSpriteSheet[sImageName]&&delete this._htSpriteSheet[sImageName]},get:function(sImageName){return this._htSpriteSheet[sImageName]?this._htSpriteSheet[sImageName]:!1},reset:function(){this._htSpriteSheet={}}}),collie.ImageManager=collie.ImageManager||new(collie.Class({RETRY_COUNT:3,RETRY_DELAY:500,USE_PRERENDERING_DOM:!1,$init:function(){this._aImages=[],this._htImageNames={},this._htImageRetryCount={},this._htImageWhileLoading={},this._nCount=0,this._oSpriteSheet=new collie.SpriteSheet},_addImage:function(elImage,sName){var nLength=this._aImages.push({element:elImage,name:sName}),aCallback=this._htImageNames[sName];if(this._htImageNames[sName]=nLength-1,delete this._htImageRetryCount[sName],aCallback&&aCallback instanceof Array){for(var i=0,len=aCallback.length;len>i;i++)aCallback[i](elImage,sName);aCallback=null}this.fireEvent("process",{name:sName,url:elImage.src,count:nLength,total:this._nCount,ratio:Math.round(nLength/this._nCount*1e3)/1e3}),this._nCount===nLength&&this.fireEvent("complete")},_markImage:function(sName){this._htImageNames[sName]||(this._htImageNames[sName]=[]),this._htImageRetryCount[sName]||(this._htImageRetryCount[sName]=0)},_makeHash:function(){this._htImageNames={};for(var i=0,len=this._aImages.length;len>i;i++)this._htImageNames[this._aImages[i].name]=i},getImage:function(sName,fCallback){return sName||0===sName?(sName in this._htImageNames||this._markImage(sName),this._htImageNames[sName]instanceof Array?fCallback&&this._addMarkCallback(sName,fCallback):fCallback?void fCallback(this._aImages[this._htImageNames[sName]].element):this._aImages[this._htImageNames[sName]].element):!1},_addMarkCallback:function(sName,fCallback,fFail){if(sName in this._htImageNames&&this._htImageNames[sName]instanceof Array){if(fFail){var fError=function fError(oEvent){oEvent.name===sName&&(fFail(),this.detach("error",fError))};this.attach("error",fError)}return fCallback&&this._htImageNames[sName].push(fCallback),!0}return!1},removeImage:function(sName){if(!(sName in this._htImageNames))return!1;var elImage=this._aImages.splice(this._htImageNames[sName],1);this._makeHash(),elImage.onload=null,elImage.onerror=null,elImage.src=null,elImage=null,this._oSpriteSheet.remove(sName)},remove:function(sName){this.removeImage(sName)},add:function(){"object"==typeof arguments[0]?this.addImages.apply(this,arguments):this.addImage.apply(this,arguments)},addImages:function(htList,fCallback,fFail){var fOnComplete=null,fOnFail=null,nTotalCount=0,nCurrentCount=0,aFailedImages=[];for(var i in htList)nTotalCount++;fCallback&&null!==fCallback&&(fOnComplete=function(){nCurrentCount++,nCurrentCount>=nTotalCount&&fCallback(htList)}.bind(this)),fFail&&null!==fFail&&(fOnFail=function(el,sName,sURL){aFailedImages.push([el,sName,sURL]),aFailedImages.length+nCurrentCount>=nTotalCount&&fFail(aFailedImages)}.bind(this));for(var i in htList)this.addImage(i,htList[i],fOnComplete,fOnFail)},addImage:function(sName,sURL,fCallback,fFail){if(this.getImage(sName))return void(fCallback&&null!==fCallback&&fCallback(this.getImage(sName),sName,sURL));if(!(sName in this._htImageWhileLoading&&this._addMarkCallback(sName,fCallback,fFail))){this._nCount++,this._markImage(sName);var el=new Image;this.USE_PRERENDERING_DOM&&"dom"===collie.Renderer.getRenderingMode()&&collie.util.getSupportCSS3d()&&!collie.util.getDeviceInfo().android&&(el.style.webkitTransform="translateZ(0)",el.style.position="absolute",el.style.visibility="hidden",collie.Renderer.getElement().appendChild(el)),this._htImageWhileLoading[sName]=el,el.onload=function(){this._addImage(el,sName),fCallback&&null!==fCallback&&fCallback(el,sName,sURL),el.onerror=el.onload=null,this._deleteWhileLoading(sName)}.bind(this),el.onerror=function(){return this._htImageRetryCount[sName]<this.RETRY_COUNT?(this._htImageRetryCount[sName]++,this.fireEvent("retry",{count:this._aImages.length,total:this._nCount,name:sName,url:sURL,delay:this.RETRY_DELAY,retryCount:this._htImageRetryCount[sName]}),void setTimeout(function(){el.src="about:blank",el.src=sURL},this.RETRY_DELAY)):(fFail&&null!==fFail&&fFail(el,sName,sURL),this.fireEvent("error",{count:this._aImages.length,total:this._nCount,name:sName,url:sURL}),el.onerror=el.onload=null,void this._deleteWhileLoading(sName))}.bind(this),el.src=sURL}},_deleteWhileLoading:function(sName){delete this._htImageWhileLoading[sName]},abort:function(){for(var i in this._htImageWhileLoading)this._htImageWhileLoading[i].onload=this._htImageWhileLoading[i].onerror=null,this._htImageWhileLoading[i].src=null,this._htImageWhileLoading[i]=null;this._htImageWhileLoading={},this._htImageStartedLoading={}},reset:function(){this.abort(),this._aImages=[],this._htImageNames={},this._htImageRetryCount={},this._htImageWhileLoading={},this._nCount=0,this._oSpriteSheet.reset()},cancelGetImage:function(sName,fCallback){if(this._htImageNames[sName]instanceof Array)for(var i=0,len=this._htImageNames[sName].length;len>i;i++)if(this._htImageNames[sName][i]===fCallback)return void this._htImageNames[sName].splice(i,1)},addSprite:function(sImageName,vSpriteName,nOffsetX,nOffsetY){this._oSpriteSheet.add(sImageName,vSpriteName,nOffsetX,nOffsetY)},getSprite:function(sImageName){return this._oSpriteSheet.get(sImageName)},removeSprite:function(sImageName){this._oSpriteSheet.remove(sImageName)}},collie.Component)),collie.Matrix={multiple:function(a1,a2){for(var matrix=[],row2=0,len=a2.length;len>row2;row2++){for(var r=[],col2=0,len2=a2[0].length;len2>col2;col2++){for(var s=0,col1=0,len3=a1[0].length;len3>col1;col1++)s+=a1[row2][col1]*a2[col1][col2];r.push(s)}matrix.push(r)}return matrix},translate:function(nX,nY){return[[1,0,nX],[0,1,nY],[0,0,1]]},scale:function(nX,nY){return[[nX,0,0],[0,nY,0],[0,0,1]]},rotate:function(nAngle){var nRad=collie.util.toRad(nAngle),nCos=Math.cos(nRad),nSin=Math.sin(nRad);return[[nCos,-nSin,0],[nSin,nCos,0],[0,0,1]]},transform:function(a,nX,nY){var aResult=this.multiple(a,[[nX],[nY],[1]]);return{x:aResult[0][0],y:aResult[1][0]}}},collie.Transform={_htBoundary:{left:0,top:0,right:0,bottom:0},_bIsIEUnder8:collie.util.getDeviceInfo().ie&&collie.util.getDeviceInfo().ie<9,getBoundary:function(oDisplayObject,bWithPoints){var htInfo=oDisplayObject.get(),aPoints=[[0,0],[htInfo.width,0],[htInfo.width,htInfo.height],[0,htInfo.height]],aTransformedPoints=this.points(oDisplayObject,aPoints),htBoundary=collie.util.getBoundary(aTransformedPoints);return this._htBoundary.left=htBoundary.left,this._htBoundary.right=htBoundary.right,this._htBoundary.bottom=htBoundary.bottom,this._htBoundary.top=htBoundary.top,this._htBoundary.isTransform=this.isUseTransform(oDisplayObject),bWithPoints&&(this._htBoundary.points=aTransformedPoints),this._htBoundary},points:function(oDisplayObject,aPoints){var aMatrix;if(this._bIsIEUnder8||(aMatrix=this.getMatrixRecusively(oDisplayObject)),!aMatrix)return aPoints;for(var aPointsAfter=[],i=0,len=aPoints.length;len>i;i++){var htPoint=collie.Matrix.transform(aMatrix,aPoints[i][0],aPoints[i][1]);aPointsAfter.push([htPoint.x,htPoint.y])}return aPointsAfter},getMatrixRecusively:function(oDisplayObject){for(var self=oDisplayObject,aMatrix=null,nX=0,nY=0;self;){if(this.isUseTransform(self)){var aSelfMatrix=this.getMatrix(self,nX,nY);aMatrix=null!==aMatrix?collie.Matrix.multiple(aMatrix,aSelfMatrix):aSelfMatrix}nX-=self._htOption.x,nY-=self._htOption.y,self=self.getParent()}return aMatrix},getMatrix:function(oDisplayObject,nX,nY){"undefined"==typeof nX&&(nX=0),"undefined"==typeof nY&&(nY=0);var htOrigin=oDisplayObject.getOrigin(),htInfo=oDisplayObject.get(),aMatrix=collie.Matrix.translate(htOrigin.x+nX,htOrigin.y+nY);return 0!==htInfo.angle&&(aMatrix=collie.Matrix.multiple(aMatrix,collie.Matrix.rotate(htInfo.angle))),(1!==htInfo.scaleX||1!==htInfo.scaleY)&&(aMatrix=collie.Matrix.multiple(aMatrix,collie.Matrix.scale(htInfo.scaleX,htInfo.scaleY))),aMatrix=collie.Matrix.multiple(aMatrix,collie.Matrix.translate(-(htOrigin.x+nX),-(htOrigin.y+nY)))},isUseTransform:function(oDisplayObject){return 1!==oDisplayObject._htOption.scaleX||1!==oDisplayObject._htOption.scaleY||0!==oDisplayObject._htOption.angle}},collie.LayerCanvas=collie.Class({$init:function(oLayer){this._oLayer=oLayer,this._oEvent=oLayer.getEvent(),this._htDeviceInfo=collie.util.getDeviceInfo(),this._initCanvas()},_initCanvas:function(){var htSize=this._getLayerSize();this._elCanvas=document.createElement("canvas"),this._elCanvas.width=htSize.width,this._elCanvas.height=htSize.height,this._elCanvas.className="_collie_layer",this._elCanvas.style.position="absolute",this._elCanvas.style.left=this._oLayer.option("x")+"px",this._elCanvas.style.top=this._oLayer.option("y")+"px",collie.Renderer.isRetinaDisplay()&&(this._elCanvas.style.width=htSize.width/2+"px",this._elCanvas.style.height=htSize.height/2+"px"),this._oContext=this._elCanvas.getContext("2d")},_getLayerSize:function(nWidth,nHeight){return nWidth=nWidth||this._oLayer.option("width"),nHeight=nHeight||this._oLayer.option("height"),collie.Renderer.isRetinaDisplay()&&(nWidth*=2,nHeight*=2),{width:nWidth,height:nHeight}},getContext:function(){return this._oContext},getElement:function(){return this._elCanvas},clear:function(oContext){oContext=oContext||this.getContext(),!this._htDeviceInfo.android||this._htDeviceInfo.android<4.12&&this._htDeviceInfo.android>=4.2?oContext.clearRect(0,0,this._elCanvas.width+1,this._elCanvas.height+1):this._elCanvas.width=this._elCanvas.width},resize:function(nWidth,nHeight,bExpand){var htSize=this._getLayerSize(nWidth,nHeight);if(bExpand){this._elCanvas.style.width=nWidth+"px",this._elCanvas.style.height=nHeight+"px";var nRatioWidth=nWidth/this._oLayer.option("width"),nRatioHeight=nHeight/this._oLayer.option("height");this._oEvent.setEventRatio(nRatioWidth,nRatioHeight)}else{var nCanvasWidth="number"==typeof nWidth?htSize.width:this._elCanvas.width,nCanvasHeight="number"==typeof nHeight?htSize.height:this._elCanvas.height;this.clear(this._oContext),this._oLayer.setChanged(),this._elCanvas.width=nCanvasWidth,this._elCanvas.height=nCanvasHeight,collie.Renderer.isRetinaDisplay()&&(this._elCanvas.style.width=nCanvasWidth/2+"px",this._elCanvas.style.height=nCanvasHeight/2+"px")}}}),collie.LayerDOM=collie.Class({$init:function(oLayer){this._oLayer=oLayer,this._oEvent=oLayer.getEvent(),this._htOption=oLayer.option(),this._initElement(),this._rxDisplayObjectId=new RegExp(collie.DisplayObjectDOM.ID+"([0-9]+)")},_initElement:function(){this._el=document.createElement("div"),this._el.className="_collie_layer",this._el.style.position="absolute",this._el.style.left=this._htOption.x+"px",this._el.style.top=this._htOption.y+"px",this._el.style.width=this._htOption.width+"px",this._el.style.height=this._htOption.height+"px",this._el.style.overflow="hidden"},findDisplayObjectElement:function(el){for(;el&&1==el.nodeType;){if(this.isDisplayObjectElement(el)&&el.parentNode===this._el)return el;el=el.parentNode}return!1},isDisplayObjectElement:function(el){return"classList"in el?el.classList.contains(collie.DisplayObjectDOM.CLASSNAME):(" "+el.className+" ").indexOf(" "+collie.DisplayObjectDOM.CLASSNAME+" ")>-1},getElement:function(){return this._el},clear:function(){return!0},resize:function(nWidth,nHeight,bExpand){if(bExpand){var nRatioWidth=parseFloat(nWidth/this._oLayer.option("width")).toFixed(2),nRatioHeight=parseFloat(nHeight/this._oLayer.option("height")).toFixed(2);this._oEvent.setEventRatio(nRatioWidth,nRatioHeight),this._el.style[collie.util.getCSSPrefix("transform-origin",!0)]="0 0",collie.util.getSupportCSS3d()?this._el.style[collie.util.getCSSPrefix("transform",!0)]="scale3d("+nRatioWidth+", "+nRatioHeight+", 1)":collie.util.getSupportCSS3()?this._el.style[collie.util.getCSSPrefix("transform",!0)]="scale("+nRatioWidth+", "+nRatioHeight+")":this._el.style.filter="progid:DXImageTransform.Microsoft.Matrix(sizingMethod='auto expand',M11="+nRatioWidth+",M12=0,M21=0,M22="+nRatioHeight+");"
}else this._el.style.width=nWidth+"px",this._el.style.height=nHeight+"px"}}),collie.LayerEvent=collie.Class({THRESHOLD_CLICK:30,$init:function(oLayer){this._oLayer=oLayer,this._bHasTouchEvent=!!("ontouchstart"in window),this._fOnEvent=this._onEvent.bind(this),this._oMousedownObject=null,this._htEventRatio={width:1,height:1},this._bAttached=!1},attachEvent:function(){var el=this._oLayer.getParent();this._bHasTouchEvent?(collie.util.addEventListener(el,"touchstart",this._fOnEvent),collie.util.addEventListener(el,"touchend",this._fOnEvent),collie.util.addEventListener(el,"touchmove",this._fOnEvent),collie.util.addEventListener(el,"touchcancel",this._fOnEvent)):(collie.util.addEventListener(el,"mousedown",this._fOnEvent),collie.util.addEventListener(el,"mouseup",this._fOnEvent),collie.util.addEventListener(el,"mousemove",this._fOnEvent)),this._bAttached=!0},detachEvent:function(){var el=this._oLayer.getParent();this._bAttached&&(this._bHasTouchEvent?(collie.util.removeEventListener(el,"touchstart",this._fOnEvent),collie.util.removeEventListener(el,"touchend",this._fOnEvent),collie.util.removeEventListener(el,"touchmove",this._fOnEvent),collie.util.removeEventListener(el,"touchcancel",this._fOnEvent)):(collie.util.removeEventListener(el,"mousedown",this._fOnEvent),collie.util.removeEventListener(el,"mouseup",this._fOnEvent),collie.util.removeEventListener(el,"mousemove",this._fOnEvent)),this._bAttached=!1)},_onEvent:function(e){if(this._oLayer._htOption.useEvent)if(e=e||window.event,this._bHasTouchEvent)for(var i=0;i<e.changedTouches.length;i++)this._onSingleEvent(e,e.changedTouches[i]);else this._onSingleEvent(e,e)},_onSingleEvent:function(e,oEvent){var el=this._bHasTouchEvent?this._getEventTargetElement(e):e.target||e.srcElement,oDocument=el.ownerDocument||document,oBody=oDocument.body||oDocument.documentElement,nPageX=this._bHasTouchEvent?oEvent.pageX:oEvent.pageX||oEvent.clientX+oBody.scrollLeft-oDocument.body.clientLeft,nPageY=this._bHasTouchEvent?oEvent.pageY:oEvent.pageY||oEvent.clientY+oBody.scrollTop-oDocument.body.clientTop,sType=e.type,htPosition=this._oLayer.getParentPosition(),nRelatedX=nPageX-htPosition.x-this._oLayer._htOption.x,nRelatedY=nPageY-htPosition.y-this._oLayer._htOption.y;if(nRelatedX/=this._htEventRatio.width,nRelatedY/=this._htEventRatio.height,"touchcancel"===sType&&null!==this._htEventStartPos&&(nRelatedX=this._htEventStartPos["touchid_"+oEvent.identifier].x,nRelatedY=this._htEventStartPos["touchid_"+oEvent.identifier].y),sType=this._convertEventType(sType),("mousemove"===sType||"mousedown"===sType)&&collie.Renderer.isPreventDefault()&&collie.util.stopEventDefault(e),"mousedown"===sType){var currStartPos={x:nRelatedX,y:nRelatedY};this._bHasTouchEvent?(this._htEventStartPos||(this._htEventStartPos={}),this._htEventStartPos["touchid_"+oEvent.identifier]=currStartPos):this._htEventStartPos=currStartPos}this._fireEvent(e,sType,nRelatedX,nRelatedY);if("mouseup"===sType){var nThresholdX=this.THRESHOLD_CLICK,nThresholdY=this.THRESHOLD_CLICK,currStartPos=null;currStartPos=this._bHasTouchEvent?this._htEventStartPos["touchid_"+oEvent.identifier]:this._htEventStartPos,currStartPos&&currStartPos.x-nThresholdX<=nRelatedX&&nRelatedX<=currStartPos.x+nThresholdX&&currStartPos.y-nThresholdY<=nRelatedY&&nRelatedY<=currStartPos.y+nThresholdY&&this._fireEvent(e,"click",nRelatedX,nRelatedY),this._bHasTouchEvent?delete this._htEventStartPos["touchid_"+oEvent.identifier]:this._htEventStartPos=null}},_fireEvent:function(e,sType,nX,nY){var oDisplayObject=null,bIsNotStoppedBubbling=!0;if("mousemove"!==sType&&!collie.Renderer.isStopEvent(sType)){var aDisplayObjects=this._oLayer.getChildren();oDisplayObject=this._getTargetOnHitEvent(aDisplayObjects,nX,nY),oDisplayObject&&(bIsNotStoppedBubbling=this._bubbleEvent(oDisplayObject,sType,e,nX,nY),"mousedown"===sType&&this._setMousedownObject(oDisplayObject),"mouseup"===sType&&this._unsetMousedownObject(oDisplayObject))}return"mouseup"===sType&&null!==this._getMousedownObject()&&(oDisplayObject=this._getMousedownObject(),this._bubbleEvent(oDisplayObject,sType,e,nX,nY),this._unsetMousedownObject(oDisplayObject)),bIsNotStoppedBubbling&&this._oLayer.fireEvent(sType,{event:e,displayObject:oDisplayObject,x:nX,y:nY}),!!oDisplayObject},_getTargetOnHitEvent:function(vDisplayObject,nX,nY){var oTargetObject=null;if(!(vDisplayObject instanceof Array))return this._isPointInDisplayObjectBoundary(vDisplayObject,nX,nY)?vDisplayObject:!1;for(var i=vDisplayObject.length-1;i>=0;i--){if(vDisplayObject[i].hasChild()&&(oTargetObject=this._getTargetOnHitEvent(vDisplayObject[i].getChildren(),nX,nY)))return oTargetObject;if(oTargetObject=this._getTargetOnHitEvent(vDisplayObject[i],nX,nY))return oTargetObject}},_convertEventType:function(sType){var sConvertedType=sType;switch(sType){case"touchstart":sConvertedType="mousedown";break;case"touchmove":sConvertedType="mousemove";break;case"touchend":case"touchcancel":sConvertedType="mouseup";break;case"tap":sConvertedType="click"}return sConvertedType},_getEventTargetElement:function(e){for(var el=e.target;1!=el.nodeType;)el=el.parentNode;return el},_bubbleEvent:function(oDisplayObject,sType,e,nX,nY,oCurrentObject){return oDisplayObject.fireEvent(sType,{displayObject:oCurrentObject||oDisplayObject,event:e,x:nX,y:nY})===!1?!1:oDisplayObject.getParent()&&!this._bubbleEvent(oDisplayObject.getParent(),sType,e,nX,nY,oDisplayObject)?!1:!0},_isPointInDisplayObjectBoundary:function(oDisplayObject,nPointX,nPointY){if(!oDisplayObject._htOption.useEvent||!oDisplayObject._htOption.visible||!oDisplayObject._htOption.width||!oDisplayObject._htOption.height||"auto"===oDisplayObject._htOption.useEvent&&!oDisplayObject.hasAttachedHandler())return!1;var htHitArea=oDisplayObject.getHitAreaBoundary();if(htHitArea.left<=nPointX&&nPointX<=htHitArea.right&&htHitArea.top<=nPointY&&nPointY<=htHitArea.bottom){if(oDisplayObject._htOption.hitArea){var htPos=oDisplayObject.getRelatedPosition();nPointX-=htPos.x,nPointY-=htPos.y;var aHitArea=oDisplayObject._htOption.hitArea;return aHitArea=collie.Transform.points(oDisplayObject,aHitArea),this._isPointInPolygon(aHitArea,nPointX,nPointY)}return!0}return!1},_isPointInPolygon:function(aVertices,nX,nY){for(var bIntersects=!1,i=0,j=aVertices.length-1,len=aVertices.length;len>i;j=i++)aVertices[i][1]>nY!=aVertices[j][1]>nY&&nX<(aVertices[j][0]-aVertices[i][0])*(nY-aVertices[i][1])/(aVertices[j][1]-aVertices[i][1])+aVertices[i][0]&&(bIntersects=!bIntersects);return bIntersects},_oMousedownObjectCount:0,_setMousedownObject:function(oDisplayObject){this._oMousedownObject===oDisplayObject?this._oMousedownObjectCount++:this._oMousedownObjectCount=1,this._oMousedownObject=oDisplayObject},_unsetMousedownObject:function(oDisplayObject){this._oMousedownObject===oDisplayObject&&(this._oMousedownObjectCount<=1?(this._oMousedownObject=null,this._oMousedownObjectCount=0):this._oMousedownObjectCount--)},_getMousedownObject:function(){return this._oMousedownObject},setEventRatio:function(nWidth,nHeight){this._htEventRatio.width=nWidth||this._htEventRatio.width,this._htEventRatio.height=nHeight||this._htEventRatio.height},getEventRatio:function(){return this._htEventRatio}}),collie.Layer=collie.Class({type:"layer",$init:function(htOption){this.option({x:0,y:0,width:320,height:480,useEvent:!0,visible:!0,freeze:!1,renderingMode:"inherit"}),this._sAlignLeft=null,this._sAlignTop=null,void 0!==htOption&&("x"in htOption&&("left"===htOption.x||"right"===htOption.x||"center"===htOption.x)&&(this._sAlignLeft=htOption.x,htOption.x=0),"y"in htOption&&("top"===htOption.y||"bottom"===htOption.y||"center"===htOption.y)&&(this._sAlignTop=htOption.y,htOption.y=0),this.option(htOption)),this._renderingMode="inherit"===this._htOption.renderingMode?collie.Renderer.getRenderingMode():this._htOption.renderingMode,"canvas"!==this._renderingMode||collie.util.getDeviceInfo().supportCanvas||(this._renderingMode="dom"),this.drawCount=0,this.optionSetter("visible",this._setVisible.bind(this)),this._elParent=null,this._bChanged=!1,this._aDisplayObjects=[],this._bLoaded=!1,this._oEvent=new collie.LayerEvent(this),this._makeDrawing(),this._setVisible()},_makeDrawing:function(){this._oDrawing="dom"===this._renderingMode?new collie.LayerDOM(this):new collie.LayerCanvas(this)},getDrawing:function(){return this._oDrawing},getRenderingMode:function(){return this._renderingMode},getEvent:function(){return this._oEvent},getParent:function(){return this._elParent||!1},load:function(elParent,nZIndex){this.unload(),this._bLoaded=!0,this._elParent=this._elParent||elParent,this._elParent.style.width=Math.max(parseInt(this._elParent.style.width||0,10),this.option("width"))+"px",this._elParent.style.height=Math.max(parseInt(this._elParent.style.height||0,10),this.option("height"))+"px",this.getElement().style.zIndex=nZIndex,null!==this._sAlignLeft&&this.offset(this._sAlignLeft,null,!0),null!==this._sAlignTop&&this.offset(null,this._sAlignTop,!0),this._elParent.appendChild(this.getElement())},unload:function(){this.isLoaded()&&(this._oEvent.detachEvent(),this._elParent.removeChild(this.getElement()),this._elParent=null,this._bLoaded=!1)},attachEvent:function(){this._oEvent.attachEvent()},detachEvent:function(){this._oEvent.detachEvent()},_setVisible:function(){this.getElement()&&(this.getElement().style.display=this.option("visible")?"block":"none")},isLoaded:function(){return this._bLoaded},addChild:function(oDisplayObject){collie.util.pushWithSort(this._aDisplayObjects,oDisplayObject),oDisplayObject.setLayer(this),this.setChanged()},addChildren:function(aList){for(var i=0,len=aList.length;len>i;i++)this.addChild(aList[i])},removeChild:function(oDisplayObject,nIdx){if(oDisplayObject.unsetLayer(),"undefined"!=typeof nIdx)this._aDisplayObjects.splice(nIdx,1);else for(var i=0,len=this._aDisplayObjects.length;len>i;i++)if(this._aDisplayObjects[i]===oDisplayObject){this._aDisplayObjects.splice(i,1);break}this.setChanged()},removeChildren:function(aList){for(var i=aList.length-1;i>=0;i--)aList[i]&&this.removeChild(aList[i],i)},addTo:function(oRenderer){return oRenderer=oRenderer||collie.Renderer,oRenderer.addLayer(this),this},changeDisplayObjectZIndex:function(oDisplayObject){this.removeChild(oDisplayObject),this.addChild(oDisplayObject)},getChildren:function(){return this._aDisplayObjects},hasChild:function(){return this._aDisplayObjects&&this._aDisplayObjects.length>0},setChanged:function(){this._bChanged=!0},isChanged:function(){return this._bChanged},unsetChanged:function(){this._bChanged=!1},getContext:function(){return"getContext"in this._oDrawing?this._oDrawing.getContext():!1},getElement:function(){return"getElement"in this._oDrawing?this._oDrawing.getElement():!1},update:function(nFrameDuration){if(this.drawCount=0,this.isChanged()&&!this.option("freeze")){this.clear(),this.unsetChanged();for(var nWidth=this.option("width"),nHeight=this.option("height"),i=0,len=this._aDisplayObjects.length;len>i;i++)this._aDisplayObjects[i].update(nFrameDuration,0,0,nWidth,nHeight)}},clear:function(){this._oDrawing.clear()},resize:function(nWidth,nHeight,bExpand){bExpand||(this.option("width",nWidth||this._htOption.width),this.option("height",nHeight||this._htOption.height)),this._oDrawing&&this._oDrawing.resize(nWidth,nHeight,bExpand),this._elParent&&(this._elParent.style.width=Math.max(parseInt(this._elParent.style.width||0,10),nWidth||this.option("width"))+"px",this._elParent.style.height=Math.max(parseInt(this._elParent.style.height||0,10),nHeight||this.option("height"))+"px"),this.fireEvent("resize")},offset:function(nX,nY,bSkipResetInitAlign){var el=this.getElement();if("undefined"!=typeof nX&&null!==nX){switch(nX){case"left":nX=0;break;case"right":nX=parseInt(this._elParent.style.width,10)-this._htOption.width;break;case"center":nX=parseInt(this._elParent.style.width,10)/2-this._htOption.width/2}this.option("x",nX),el.style.left=nX+"px",bSkipResetInitAlign||(this._sAlignLeft=null)}if("undefined"!=typeof nY&&null!==nY){switch(nY){case"top":nY=0;break;case"bottom":nY=parseInt(this._elParent.style.height,10)-this._htOption.height;break;case"center":nY=parseInt(this._elParent.style.height,10)/2-this._htOption.height/2}this.option("y",nY),el.style.top=nY+"px",bSkipResetInitAlign||(this._sAlignTop=null)}},setParent:function(elParent){"string"==typeof elParent&&(elParent=document.getElementById(elParent)),this._bLoaded?(this._oEvent.detachEvent(),this._elParent.removeChild(this.getElement()),this._elParent=elParent,this._elParent.appendChild(this.getElement()),this._oEvent.attachEvent()):this._elParent=elParent},getParentPosition:function(){return null!==this._elParent?this._elParent===collie.Renderer.getElement()?collie.Renderer.getPosition():collie.util.getPosition(this._elParent):void 0},clone:function(bRecursive){var oLayer=new this.constructor(this._htOption);if(bRecursive&&this._aDisplayObjects.length)for(var i=0,l=this._aDisplayObjects.length;l>i;i++)this._aDisplayObjects[i].clone(!0).addTo(oLayer);return oLayer}},collie.Component),collie.DisplayObjectCanvas=collie.Class({$init:function(oDisplayObject){this._oDisplayObject=oDisplayObject,this._bUseCache=!1,this._oDebugHitArea=null,this._htEvent={},this._oLayer=null,this._htInfo=this._oDisplayObject.get(),this._bIsRetinaDisplay=null,this._htInfo.useCache&&this.loadCache()},loadCache:function(){this._bUseCache||(this._bUseCache=!0,this._elCache=document.createElement("canvas"),this._elCache.width=this._htInfo.width,this._elCache.height=this._htInfo.height,this._oContextCache=this._elCache.getContext("2d"))},unloadCache:function(){this._bUseCache&&(this._oContextCache=null,this._elCache=null,this._bUseCache=!1)},clearCache:function(){this._bUseCache&&(this._oContextCache.clearRect(0,0,this._elCache.width,this._elCache.height),this._elCache.width=this._htInfo.width*(this._bIsRetinaDisplay?2:1),this._elCache.height=this._htInfo.height*(this._bIsRetinaDisplay?2:1))},drawImage:function(oContext,sx,sy,sw,sh,dx,dy,dw,dh){var oSource=this._oDisplayObject.getImage(),nImageWidth=this._oDisplayObject._nImageWidth,nImageHeight=this._oDisplayObject._nImageHeight;if(collie.Renderer.isRetinaDisplay()){for(i=1,len=arguments.length;len>i;i++)arguments[i]*=2;nImageWidth*=2,nImageHeight*=2}try{oContext.drawImage(oSource,sx,sy,sw,sh,dx,dy,dw,dh)}catch(e){throw new Error("invalid drawImage value : "+sx+","+sy+","+sw+","+sh+","+dx+","+dy+","+dw+","+dh+","+this._oDisplayObject.getImage().src+", original : "+this._oDisplayObject.getImage().width+","+this._oDisplayObject.getImage().height+",source : "+oSource.width+","+oSource.height+", isCached : "+(null!==this._elImageCached?"true":"false"))}},load:function(){this._oLayer=this._oDisplayObject.getLayer(),this._oContext=this._oDisplayObject.getLayer().getContext(),this._bIsRetinaDisplay=collie.Renderer.isRetinaDisplay()},unload:function(){this._oLayer=null,this._oContext=null},draw:function(nFrameDuration,nX,nY,nLayerWidth,nLayerHeight,oContext){var bUseParentContext=oContext?!0:!1;oContext=oContext||this._oContext;var oTargetContext=this._bUseCache?this._oContextCache:oContext,oParentContext=oContext,htInfo=this._htInfo,htOrigin=(this._oDisplayObject.getDirty(),this._oDisplayObject.getOrigin()),nTargetWidth=htInfo.width,nTargetHeight=htInfo.height,nOriginX=htOrigin.x,nOriginY=htOrigin.y,nSavedX=nX,nSavedY=nY,nRatio=this._bIsRetinaDisplay?2:1,nSavedOpacity=0,bUseTransform=!1,oTransformContext=oContext;if(htInfo.useCache&&(oContext=this._oContextCache),this._bIsRetinaDisplay&&(nX*=2,nY*=2,nOriginX*=2,nOriginY*=2,nTargetWidth*=2,nTargetHeight*=2),(this._bUseCache||1!==htInfo.scaleX||1!==htInfo.scaleY||0!==htInfo.angle||1!==htInfo.opacity)&&(bUseTransform=!0,this._bUseCache&&(oTransformContext=bUseParentContext?oParentContext:this._oContext),oTransformContext.save(),oTransformContext.translate(nX+nOriginX,nY+nOriginY),1!==htInfo.opacity&&(nSavedOpacity=oTransformContext.globalAlpha,oTransformContext.globalAlpha=0===oTransformContext.globalAlpha?htInfo.opacity:oTransformContext.globalAlpha*htInfo.opacity),0!==htInfo.angle&&oTransformContext.rotate(collie.util.toRad(htInfo.angle)),(1!==htInfo.scaleX||1!==htInfo.scaleY)&&oTransformContext.scale(htInfo.scaleX,htInfo.scaleY),oTransformContext.translate(-nOriginX,-nOriginY),nX=nY=0),this._htEvent.displayObject=this,this._htEvent.context=oTargetContext,this._htEvent.x=nX,this._htEvent.y=nY,!this._bUseCache||this._oDisplayObject.isChanged()&&!this._oDisplayObject.isChanged(!0)){if(this.clearCache(),htInfo.backgroundColor&&(oTargetContext.fillStyle=htInfo.backgroundColor,oTargetContext.fillRect(nX,nY,nTargetWidth,nTargetHeight)),this._oDisplayObject.getImage()){var htImageSize=(this._oDisplayObject.getImage(),this._oDisplayObject.getImageSize());if(htInfo.backgroundRepeat&&"no-repeat"!==htInfo.backgroundRepeat){var nCountWidth="repeat"===htInfo.backgroundRepeat||"repeat-x"===htInfo.backgroundRepeat?Math.ceil(htInfo.width/htImageSize.width):1,nCountHeight="repeat"===htInfo.backgroundRepeat||"repeat-y"===htInfo.backgroundRepeat?Math.ceil(htInfo.height/htImageSize.height):1;if(nCountWidth>0||nCountHeight>0)for(var nLeftOffset=0;nCountWidth>nLeftOffset;nLeftOffset++)for(var nTopOffset=0;nCountHeight>nTopOffset;nTopOffset++){var nOffsetX=nLeftOffset*htImageSize.width+htImageSize.width,nOffsetY=nTopOffset*htImageSize.height+htImageSize.height,nPieceWidth=nOffsetX>htInfo.width?htImageSize.width-(nOffsetX-htInfo.width):htImageSize.width,nPieceHeight=nOffsetY>htInfo.height?htImageSize.height-(nOffsetY-htInfo.height):htImageSize.height;this.drawImage(oTargetContext,0,0,nPieceWidth,nPieceHeight,nX/nRatio+nLeftOffset*htImageSize.width,nY/nRatio+nTopOffset*htImageSize.height,nPieceWidth,nPieceHeight)}}else{var nDrawingWidth=Math.min(htImageSize.width,htInfo.width),nDrawingHeight=Math.min(htImageSize.height,htInfo.height);this.drawImage(oTargetContext,htInfo.offsetX,htInfo.offsetY,htInfo.fitImage?htImageSize.width:nDrawingWidth,htInfo.fitImage?htImageSize.height:nDrawingHeight,nX/nRatio,nY/nRatio,htInfo.fitImage?htInfo.width:nDrawingWidth,htInfo.fitImage?htInfo.height:nDrawingHeight)}}"onCanvasDraw"in this._oDisplayObject&&this._oDisplayObject.onCanvasDraw(this._htEvent)}if(htInfo.debugHitArea&&htInfo.hitArea&&null===this._oDebugHitArea&&(this._oDebugHitArea=new collie.Polyline({x:0,y:0,width:htInfo.width,height:htInfo.height,strokeColor:htInfo.debugHitArea===!0?"yellow":htInfo.debugHitArea,strokeWidth:3}).addTo(this._oDisplayObject),this._oDebugHitArea.setPointData(htInfo.hitArea)),this._oDisplayObject.hasChild()&&(!htInfo.useCache||this._oDisplayObject.isChanged()&&!this._oDisplayObject.isChanged(!0)))for(var aDisplayObjects=this._oDisplayObject.getChildren(),i=0,len=aDisplayObjects.length;len>i;i++)aDisplayObjects[i].update(nFrameDuration,htInfo.useCache||bUseTransform?0:nSavedX,htInfo.useCache||bUseTransform?0:nSavedY,nLayerWidth,nLayerHeight,bUseParentContext||htInfo.useCache?oContext:null),aDisplayObjects[i].unsetChanged(),aDisplayObjects[i]._resetDirty();htInfo.useCache&&(bUseParentContext?oParentContext:this._oContext).drawImage(oContext.canvas,0,0),this._oLayer.drawCount++,bUseTransform&&oTransformContext.restore()}}),collie.DisplayObjectDOM=collie.Class({$init:function(oDisplayObject){this._oDisplayObject=oDisplayObject,this._htInfo=this._oDisplayObject.get(),this._oLayer=null,this._elImage=null,this._aTransformValue=[],this._sTransformValue=null,this._sTransform=collie.util.getCSSPrefix("transform",!0),this._sOrigin=collie.util.getCSSPrefix("transform-origin",!0),this._bSupportCSS3=collie.util.getSupportCSS3(),this._bSupportCSS3d=collie.util.getSupportCSS3d(),this._bUseTransform=this._bSupportCSS3||this._bSupportCSS3d,this._htDeviceInfo=collie.util.getDeviceInfo(),this._bIsAndroid=!!this._htDeviceInfo.android,this._nAndroidVersion=this._htDeviceInfo.android,this._bIsIEUnder8=this._htDeviceInfo.ie&&this._htDeviceInfo.ie<9,this._bUseTranslateZ=!0,this._bIsRetinaDisplay=null,this._htEvent={},this._oEmptyObject={},this._sCacheTransformValue=null,this._initElement()},_initElement:function(){this._elContainer=document.createElement("div"),this._elContainer.id=collie.DisplayObjectDOM.ID+this._oDisplayObject.getId()+(this._htInfo.name?"_"+this._htInfo.name:""),this._elContainer.className=collie.DisplayObjectDOM.CLASSNAME,this._elContainerStyle=this._elContainer.style,this._elContainerStyle.position="absolute",this._bIsIEUnder8&&(this._elContainerStyle.width=this._htInfo.width+"px",this._elContainerStyle.height=this._htInfo.height+"px"),this._htInfo.useCache&&(this._elContainerStyle.overflow="hidden",this._elContainerStyle.width=this._htInfo.width+"px",this._elContainerStyle.height=this._htInfo.height+"px"),this._el=document.createElement("div"),this._elStyle=this._el.style,this._bSupportCSS3d&&(this._elStyle[this._sTransform]="translateZ(0)"),this._elStyle.position="absolute",this._elStyle.width=this._htInfo.width+"px",this._elStyle.height=this._htInfo.height+"px",this._elStyle.overflow="hidden",this._elContainer.appendChild(this._el)},load:function(){this._oLayer=this._oDisplayObject.getLayer(),this._oDisplayObject.getParent()?this._oDisplayObject.getParent().getDrawing().getElement().appendChild(this._elContainer):this._oLayer.getElement().appendChild(this._elContainer),this._bIsRetinaDisplay=collie.Renderer.isRetinaDisplay()},unload:function(){this._oLayer=null,this._elContainer.parentNode.removeChild(this._elContainer)},getElement:function(){return this._elContainer},getItemElement:function(){return this._el},draw:function(nFrameDuration,nX,nY){this._htEvent.displayObject=this,this._htEvent.element=this._el,this._htEvent.x=nX,this._htEvent.y=nY;{var htInfo=this._htInfo,htDirty=this._oDisplayObject.getDirty()||this._oEmptyObject,htOrigin=this._oDisplayObject.getOrigin();this._bIsRetinaDisplay?2:1}htDirty.visible&&(this._elContainerStyle.display=htInfo.visible?"block":"none"),htDirty.width&&(this._elStyle.width=htInfo.width+"px",this._bIsIEUnder8&&(this._elContainerStyle.width=htInfo.width+"px")),htDirty.height&&(this._elStyle.height=htInfo.height+"px"),htDirty.opacity&&(this._bIsIEUnder8?this._elContainerStyle.filter="alpha(opacity="+100*htInfo.opacity+")":(this._elContainerStyle.opacity=htInfo.opacity,this._elImage&&this._nAndroidVersion&&this._nAndroidVersion>=4.1&&(this._elImage.style.opacity=htInfo.opacity))),htDirty.zIndex&&(this._elContainerStyle.zIndex=htInfo.zIndex),htDirty.backgroundColor&&(this._elStyle.backgroundColor=htInfo.backgroundColor),this._bUseTransform?this._aTransformValue.push(this._makeTranslate(htInfo.x,htInfo.y,htInfo.zIndex)):(htDirty.x||htDirty.y)&&(this._elContainerStyle.left=htInfo.x+"px",this._elContainerStyle.top=htInfo.y+"px"),this._bUseTransform&&((htDirty.originX||htDirty.originY||htDirty.width||htDirty.height)&&(this._elContainerStyle[this._sOrigin]=htOrigin.x+"px "+htOrigin.y+"px"),0!==htInfo.angle&&this._aTransformValue.push("rotate",this._bSupportCSS3d&&!this._bIsAndroid?"Z":"","(",htInfo.angle,"deg) "),(1!==htInfo.scaleX||1!==htInfo.scaleY)&&this._aTransformValue.push("scale(",htInfo.scaleX,", ",htInfo.scaleY,") ")),this._bUseTransform&&this._applyTransform(),this._drawImage(htInfo,htDirty),"onDOMDraw"in this._oDisplayObject&&this._oDisplayObject.onDOMDraw(this._htEvent),this._oLayer.drawCount++},_drawImage:function(htInfo,htDirty){var elSourceImage=this._oDisplayObject.getImage(),bUseRepeat=htInfo.backgroundRepeat&&"no-repeat"!==htInfo.backgroundRepeat,nImageWidth=0,nImageHeight=0;if(this._oDisplayObject._htOption.fitImage)nImageWidth=this._oDisplayObject._htOption.width,nImageHeight=this._oDisplayObject._htOption.height;else{var htImageSize=this._oDisplayObject.getImageSize();nImageWidth=htImageSize.width,nImageHeight=htImageSize.height}if((htDirty.backgroundImage||htDirty.backgroundRepeat)&&(null!==this._elImage&&(!htInfo.backgroundImage||htInfo.backgroundRepeat&&"no-repeat"!==htInfo.backgroundRepeat)&&(this._el.removeChild(this._elImage),this._elImage=null),htInfo.backgroundImage&&elSourceImage))if(!bUseRepeat&&htInfo.backgroundImage){var elImageStyle;null===this._elImage?(this._elImage=elSourceImage.cloneNode(),elImageStyle=this._elImage.style,elImageStyle.position="absolute",elImageStyle.top=0,elImageStyle.left=0,elImageStyle.width=nImageWidth+"px",elImageStyle.height=nImageHeight+"px",elImageStyle.visibility="visible",this._nAndroidVersion&&this._nAndroidVersion>=4.1&&(elImageStyle.opacity=htInfo.opacity),this._bSupportCSS3d&&this._bUseTranslateZ&&(elImageStyle[this._sTransform]="translateZ(0)"),this._el.hasChildNodes()?this._el.insertBefore(this._elImage,this._el.childNodes[0]):this._el.appendChild(this._elImage)):(this._elImage.src=elSourceImage.src,elImageStyle=this._elImage.style,elImageStyle.width=nImageWidth+"px",elImageStyle.height=nImageHeight+"px",elImageStyle.visibility="visible")}else bUseRepeat&&(this._elStyle.backgroundImage='url("'+elSourceImage.src+'")',this._elStyle.backgroundRepeat=htInfo.backgroundRepeat);htInfo.backgroundImage&&null!==this._elImage&&(this._bIsRetinaDisplay&&bUseRepeat&&(htDirty.width||htDirth.height||htDirty.backgroundRepeat||htDirty.backgroundImage)&&(this._elStyle.backgroundSize=htInfo.width+"px "+htInfo.height+"px"),(htDirty.offsetX||htDirty.offsetY)&&(this._bUseTransform?this._elImage.style[this._sTransform]=this._makeTranslate(-htInfo.offsetX,-htInfo.offsetY,1):(this._elImage.style.left=-htInfo.offsetX+"px",this._elImage.style.top=-htInfo.offsetY+"px")))},_makeTranslate:function(nX,nY,nZ){var sTranslate="",bUseCSS3d=0!==this._htInfo.angle&&this._bIsAndroid?!1:this._bSupportCSS3d;return bUseCSS3d?sTranslate="translate3d("+nX+"px, "+nY+"px, "+nZ+"px) ":this._bSupportCSS3&&(sTranslate="translate("+nX+"px, "+nY+"px) "),sTranslate},_applyTransform:function(){var sValue=this._aTransformValue.join("");this._sCacheTransformValue!==sValue&&(this._elContainerStyle[this._sTransform]=sValue,this._sCacheTransformValue=sValue,this._bIsAndroid&&this._bUseTranslateZ&&0!==this._htInfo.angle?(this._elStyle[this._sTransform]="",this._elImage&&this._oDisplayObject.setChanged(),this._bUseTranslateZ=!1):this._bUseTranslateZ||0!==this._htInfo.angle&&this._bIsAndroid||!this._bSupportCSS3d||(this._elStyle[this._sTransform]="translateZ(0)",this._elImage&&this._oDisplayObject.setChanged(),this._bUseTranslateZ=!0)),this._aTransformValue=[]}},collie.Component),collie.DisplayObjectDOM.CLASSNAME="_collie_displayObject",collie.DisplayObjectDOM.ID="_collie_displayObject_",collie.DisplayObject=collie.Class({type:"displayobject",$init:function(htOption){this._bInitOption=!0,this._htOption={name:"",width:"auto",height:"auto",x:0,y:0,zIndex:0,opacity:1,angle:0,scaleX:1,scaleY:1,originX:"center",originY:"center",offsetX:0,offsetY:0,spriteX:null,spriteY:null,spriteLength:0,spriteSheet:null,rangeX:null,rangeY:null,positionRepeat:!1,backgroundColor:"",backgroundImage:"",backgroundRepeat:"no-repeat",hitArea:null,debugHitArea:!1,useCache:!1,useEvent:"auto",fitImage:!1,velocityX:0,velocityY:0,velocityRotate:0,forceX:0,forceY:0,forceRotate:0,mass:1,friction:0,useRealTime:!0,visible:!0},htOption&&this.option(htOption),this._htDirty={},this._htMatrix={},this._sId=++collie.DisplayObject._idx,this._elImage=null,this._aDisplayObjects=[],this._oLayer=null,this._oParent=null,this._oDrawing=null,this._bIsSetOption=!1,this._bChanged=!0,this._bChangedTransforms=!0,this._bCustomSize=!1,this._aChangedQueue=null,this._htGetImageData=null,this._htRelatedPosition={},this._htParentRelatedPosition={},this._htBoundary={},this._sRenderingMode=null,this._bRetinaDisplay=collie.Renderer.isRetinaDisplay(),this._oTimerMove=null,this._nPositionRight=null,this._nPositionBottom=null,this._nImageWidth=0,this._nImageHeight=0,this._htImageSize=null,this._htSpriteSheet=null,this._htOrigin={x:0,y:0},this.set(this._htOption),this._bIsSetOption=!0},set:function(vKey,vValue,bSkipSetter,bSkipChanged){if("object"==typeof vKey)for(var i in vKey)this.set(i,vKey[i]);else{if(this._bIsSetOption&&this._htOption[vKey]===vValue)return;("width"===vKey||"height"===vKey)&&("auto"!==vValue?this._bCustomSize=!0:vValue="auto"===vValue&&null!==this.getImage()?this.getImageSize()[vKey]:100),this._htOption[vKey]=vValue,this.setDirty(vKey),bSkipSetter||this._setter(vKey,vValue),bSkipChanged||this.setChanged("x"===vKey||"y"===vKey||"angle"===vKey||"scaleX"===vKey||"scaleY"===vKey||"opacity"===vKey?!0:!1)}return this},_setter:function(vKey,vValue){"zIndex"===vKey&&(this._oParent?this._oParent.changeDisplayObjectZIndex(this):this.getLayer()&&this._oLayer.changeDisplayObjectZIndex(this)),("x"===vKey||"y"===vKey)&&("string"==typeof vValue&&this.align("x"===vKey?vValue:!1,"y"===vKey?vValue:!1),this._fixPosition(),this.resetPositionCache()),"backgroundImage"===vKey&&this.setImage(vValue),("spriteX"===vKey||"spriteY"===vKey||"spriteSheet"===vKey)&&this._setSpritePosition(vKey,vValue),("width"===vKey||"height"===vKey)&&(null!==this._htOption.spriteX&&this._setSpritePosition("spriteX",this._htOption.spriteX),null!==this._htOption.spriteY&&this._setSpritePosition("spriteY",this._htOption.spriteY)),"hitArea"===vKey&&vValue instanceof Array&&this._makeHitAreaBoundary(),("width"===vKey||"height"===vKey||"originX"===vKey||"originY"===vKey)&&this._setOrigin(),"backgroundRepeat"===vKey&&"no-repeat"!==vValue&&this.set("useCache",!0),"useCache"===vKey&&null!==this._oDrawing&&this._oDrawing.loadCache&&(vValue?this._oDrawing.loadCache():this._oDrawing.unloadCache())},get:function(sKey){return sKey?this._htOption[sKey]:this._htOption},setDirty:function(sKey){if(null===this._htDirty&&(this._htDirty={}),"undefined"==typeof sKey)for(var i in this._htOption)this._htDirty[i]=!0;else this._htDirty[sKey]=!0},getDirty:function(sKey){return sKey?this._htDirty[sKey]?!0:!1:this._htDirty},_resetDirty:function(){this._htDirty=null},addChild:function(oDisplayObject){collie.util.pushWithSort(this._aDisplayObjects,oDisplayObject),oDisplayObject.setParent(this),null!==this._oLayer&&oDisplayObject.setLayer(this._oLayer),this.setChanged()},removeChild:function(oDisplayObject,nIdx){if("undefined"!=typeof nIdx)this._aDisplayObjects[nIdx].unsetLayer(),this._aDisplayObjects[nIdx].unsetParent(),this._aDisplayObjects.splice(nIdx,1);else for(var i=0,len=this._aDisplayObjects.length;len>i;i++)if(this._aDisplayObjects[i]===oDisplayObject){this._aDisplayObjects[i].unsetLayer(),this._aDisplayObjects[i].unsetParent(),this._aDisplayObjects.splice(i,1);break}this.setChanged()},changeDisplayObjectZIndex:function(oDisplayObject){this.removeChild(oDisplayObject),this.addChild(oDisplayObject)},addTo:function(oTarget){if(this._oLayer||this._oParent){if(this._oLayer===oTarget||this._oParent===oTarget)return this;this.leave()}return oTarget.addChild(this),this},hasChild:function(){return this._aDisplayObjects.length>0},getChildren:function(){return this._aDisplayObjects},getParent:function(){return this._oParent||!1},setParent:function(oDisplayObject){this._oParent=oDisplayObject},unsetParent:function(){this._oParent=null},leave:function(){var oParent=null;return null!==this._oParent?oParent=this._oParent:this._oLayer&&(oParent=this.getLayer()),oParent&&oParent.removeChild(this),this},getId:function(){return this._sId},getImage:function(){return this._elImage||null},getImageSize:function(){return this._htImageSize||!1},setImage:function(vImage){return"string"!=typeof vImage&&vImage?void(this._elImage&&this._elImage===vImage||(this._elImage=vImage,this._nImageWidth=vImage.width,this._nImageHeight=vImage.height,this._htImageSize={width:this._bRetinaDisplay?this._nImageWidth/2:this._nImageWidth,height:this._bRetinaDisplay?this._nImageHeight/2:this._nImageHeight},this._htSpriteSheet=collie.ImageManager.getSprite(this._htOption.backgroundImage),this._bCustomSize||this.set({width:this._htImageSize.width,height:this._htImageSize.height}),this._setSpritePosition("spriteSheet",this._htOption.spriteSheet),this._setSpritePosition("spriteX",this._htOption.spriteX),this._setSpritePosition("spriteY",this._htOption.spriteY),this.setDirty("backgroundImage"),this.setChanged())):(null!==this._htGetImageData&&this._htGetImageData.name!==vImage&&(collie.ImageManager.cancelGetImage(this._htGetImageData.name,this._htGetImageData.callback),this._htGetImageData=null),void(vImage?(this._htGetImageData={name:vImage,callback:function(elImage){this.setImage(elImage)
}.bind(this)},collie.ImageManager.getImage(this._htGetImageData.name,this._htGetImageData.callback)):(this._elImage=null,this.setChanged())))},getDrawing:function(){return this._oDrawing},setChanged:function(bChangedTransforms){this._bChanged||bChangedTransforms&&this._bChangedTransforms||(null!==this._oLayer&&this._oLayer.setChanged(),bChangedTransforms||(this._bChanged=!0),this._bChangedTransforms=!0,this._oParent&&this._oParent.setChanged(!1))},unsetChanged:function(){this._bChanged=!1,this._bChangedTransforms=!1},isChanged:function(bChangedOnlyTranforms){return bChangedOnlyTranforms?!this._bChanged&&this._bChangedTransforms:this._bChanged||this._bChangedTransforms},setLayer:function(oLayer){if(this._sId in collie.DisplayObject.htFactory)throw new Error("Exists DisplayObject Id "+this._sId);collie.DisplayObject.htFactory[this._sId]=this,this._oLayer=oLayer,this._sRenderingMode=this._oLayer.getRenderingMode(),this._makeDrawing(),this._oDrawing.load(),this.setChanged(),("string"==typeof this._htOption.x||"string"==typeof this._htOption.y)&&this.align("string"==typeof this._htOption.x?this._htOption.x:!1,"string"==typeof this._htOption.y?this._htOption.y:!1),null!==this._nPositionRight&&(this.right(this._nPositionRight),this._nPositionRight=null),null!==this._nPositionBottom&&(this.bottom(this._nPositionBottom),this._nPositionBottom=null);for(var i=0,len=this._aDisplayObjects.length;len>i;i++)this._aDisplayObjects[i].setLayer(oLayer)},unsetLayer:function(){if(this.getLayer()){for(var i=0,len=this._aDisplayObjects.length;len>i;i++)this._aDisplayObjects[i].unsetLayer();this._oDrawing.unload(),this.setDirty(),this.setChanged(),this._sRenderingMode=null,this._oDrawing=null,this._oLayer=null,delete collie.DisplayObject.htFactory[this._sId]}},_makeDrawing:function(){null===this._oDrawing&&(this._oDrawing="dom"===this._sRenderingMode?new collie.DisplayObjectDOM(this):new collie.DisplayObjectCanvas(this))},getLayer:function(){return this._oLayer||!1},addMatrix:function(vMatrix){if(vMatrix instanceof Array)for(var i=0,len=vMatrix.length;len>i;i++)this.addMatrix(vMatrix[i]);else this._htMatrix[vMatrix.name]=vMatrix,delete this._htMatrix[vMatrix.name].name},changeMatrix:function(sName){sName in this._htMatrix&&this.set(this._htMatrix[sName])},update:function(nFrameDuration,nX,nY,nLayerWidth,nLayerHeight,oContext){if(this._updateMovableOption(nFrameDuration),"canvas"===this._sRenderingMode&&!this._htOption.visible)return void this.unsetChanged();if(nX+=this._htOption.x,nY+=this._htOption.y,("dom"===this._sRenderingMode&&this.isChanged()||"canvas"===this._sRenderingMode&&(nX+this._htOption.width>=0||nLayerWidth>=nX||nY+this._htOption.height>=0||nLayerHeight>=nY))&&this._oDrawing.draw(nFrameDuration,nX,nY,nLayerWidth,nLayerHeight,oContext),this.unsetChanged(),this._resetDirty(),(0!==this._htOption.velocityX||0!==this._htOption.velocityY||0!==this._htOption.velocityRotate||0!==this._htOption.forceX||0!==this._htOption.forceY||0!==this._htOption.forceRotate)&&this.setChanged(!0),"canvas"!==this._sRenderingMode&&this._htOption.visible&&this.hasChild())for(var i=0,len=this._aDisplayObjects.length;len>i;i++)this._aDisplayObjects[i].update(nFrameDuration,nX,nY,nLayerWidth,nLayerHeight)},_updateMovableOption:function(nFrameDuration){if(0!==this._htOption.velocityX||0!==this._htOption.velocityY||0!==this._htOption.velocityRotate||0!==this._htOption.forceX||0!==this._htOption.forceY||0!==this._htOption.forceRotate){var nFrame=Math.max(17,nFrameDuration)/1e3;this._htOption.useRealTime||(nFrame=1);var nVelocityX=this._htOption.velocityX,nVelocityY=this._htOption.velocityY,nX=this._htOption.x,nY=this._htOption.y;nVelocityX+=this._htOption.forceX/this._htOption.mass*nFrame,nVelocityY+=this._htOption.forceY/this._htOption.mass*nFrame;var nForceFrictionX=this._htOption.friction*nVelocityX*this._htOption.mass*nFrame,nForceFrictionY=this._htOption.friction*nVelocityY*this._htOption.mass*nFrame;if(0!==nVelocityX&&(nVelocityX=Math.abs(nVelocityX)/nVelocityX!==Math.abs(nVelocityX-nForceFrictionX)/(nVelocityX-nForceFrictionX)?0:nVelocityX-nForceFrictionX),0!==nVelocityY&&(nVelocityY=Math.abs(nVelocityY)/nVelocityY!==Math.abs(nVelocityY-nForceFrictionY)/(nVelocityY-nForceFrictionY)?0:nVelocityY-nForceFrictionY),nX+=nVelocityX*nFrame,nY+=nVelocityY*nFrame,nVelocityX=Math.floor(1e3*nVelocityX)/1e3,nVelocityY=Math.floor(1e3*nVelocityY)/1e3,this._htOption.friction&&Math.abs(nVelocityX)<.05&&(nVelocityX=0),this._htOption.friction&&Math.abs(nVelocityY)<.05&&(nVelocityY=0),(nX!==this._htOption.x||nY!==this._htOption.y||nVelocityX!==this._htOption.velocityX||nVelocityY!==this._htOption.velocityY)&&(this.set("x",nX),this.set("y",nY),this.set("velocityX",nVelocityX),this.set("velocityY",nVelocityY)),0!==this._htOption.forceRotate&&this.set("velocityRotate",this._htOption.velocityRotate+this._htOption.forceRotate),0!==this._htOption.velocityRotate){var nAngleRad=collie.util.fixAngle(collie.util.toRad(this._htOption.angle+this._htOption.velocityRotate*nFrame));this.set("angle",Math.round(1e3*collie.util.toDeg(nAngleRad))/1e3)}}},getRelatedPosition:function(){if(null===this._htRelatedPosition.x&&(this._htRelatedPosition.x=this._htOption.x,this._htRelatedPosition.y=this._htOption.y,this._oParent)){var htPosition=this._oParent.getRelatedPosition();this._htRelatedPosition.x+=htPosition.x,this._htRelatedPosition.y+=htPosition.y}return this._htRelatedPosition},getBoundary:function(bWithRelatedPosition,bWithPoints){var htBoundary=collie.Transform.getBoundary(this,bWithPoints);if(this._htBoundary.left=htBoundary.left,this._htBoundary.right=htBoundary.right,this._htBoundary.top=htBoundary.top,this._htBoundary.bottom=htBoundary.bottom,this._htBoundary.isTransform=htBoundary.isTransform,this._htBoundary.points=htBoundary.points,bWithRelatedPosition){var htPos=this.getRelatedPosition();if(this._htBoundary.points)for(var i=0,l=this._htBoundary.points.length;l>i;i++)this._htBoundary.points[i][0]+=htPos.x,this._htBoundary.points[i][1]+=htPos.y;this._htBoundary.left+=htPos.x,this._htBoundary.right+=htPos.x,this._htBoundary.top+=htPos.y,this._htBoundary.bottom+=htPos.y}return this._htBoundary},resetPositionCache:function(){if(this._htRelatedPosition.x=null,this._htRelatedPosition.y=null,this.hasChild())for(var i=0,l=this._aDisplayObjects.length;l>i;i++)this._aDisplayObjects[i].resetPositionCache()},getHitAreaBoundary:function(){if(this._htOption.hitArea){if(this._htOption.hitArea instanceof Array){var aPoints=collie.Transform.points(this,collie.util.getBoundaryToPoints(this._htHitAreaBoundary)),htBoundary=collie.util.getBoundary(aPoints),htPos=this.getRelatedPosition();return{left:htBoundary.left+htPos.x,right:htBoundary.right+htPos.x,top:htBoundary.top+htPos.y,bottom:htBoundary.bottom+htPos.y}}return this._htOption.hitArea.getBoundary(!0)}return this.getBoundary(!0)},getOrigin:function(){return this._htOrigin},_setOrigin:function(){switch(this._htOption.originX){case"left":this._htOrigin.x=0;break;case"right":this._htOrigin.x=this._htOption.width;break;case"center":this._htOrigin.x=this._htOption.width/2;break;default:this._htOrigin.x=parseInt(this._htOption.originX,10)}switch(this._htOption.originY){case"top":this._htOrigin.y=0;break;case"bottom":this._htOrigin.y=this._htOption.height;break;case"center":this._htOrigin.y=this._htOption.height/2;break;default:this._htOrigin.y=parseInt(this._htOption.originY,10)}},_fixPosition:function(){var nMinX,nMaxX,nMinY,nMaxY,nX=this._htOption.x,nY=this._htOption.y;if(this._htOption.rangeX){if(nMinX=this._htOption.rangeX[0],nMaxX=this._htOption.rangeX[1],this._htOption.positionRepeat){if(nMinX>nX){do nX+=nMaxX-nMinX;while(nMinX>nX)}else if(nX>nMaxX)do nX-=nMaxX-nMinX;while(nX>nMaxX)}else nX=Math.max(nMinX,nX),nX=Math.min(nMaxX,nX);nX!==this._htOption.x&&this.set("x",nX,!0)}if(this._htOption.rangeY){if(nMinY=this._htOption.rangeY[0],nMaxY=this._htOption.rangeY[1],this._htOption.positionRepeat){if(nMinY>nY){do nY+=nMaxY-nMinY;while(nMinY>nY)}else if(nY>nMaxY)do nY-=nMaxY-nMinY;while(nY>nMaxY)}else nY=Math.max(nMinY,nY),nY=Math.min(nMaxY,nY);nY!==this._htOption.y&&this.set("y",nY,!0)}},_makeHitAreaBoundary:function(){this._htHitAreaBoundary=collie.util.getBoundary(this._htOption.hitArea)},align:function(sHorizontal,sVertical,oBaseObject){if(this.getLayer()){oBaseObject=oBaseObject||this.getParent();var nWidth=0,nHeight=0,nX=0,nY=0;oBaseObject?(nWidth=oBaseObject._htOption.width,nHeight=oBaseObject._htOption.height):(nWidth=this._oLayer._htOption.width,nHeight=this._oLayer._htOption.height),sHorizontal!==!1&&(nX="right"===sHorizontal?nWidth-this._htOption.width:nWidth/2-this._htOption.width/2,this.set("x",nX)),sVertical!==!1&&(nY="bottom"===sVertical?nHeight-this._htOption.height:nHeight/2-this._htOption.height/2,this.set("y",nY))}},right:function(nPosition){var nWidth=0;return this._oParent&&(nWidth=this._oParent._htOption.width),!nWidth&&this._oLayer&&(nWidth=this._oLayer._htOption.width),nWidth?this.set("x",nWidth-(this._htOption.width+nPosition)):this._nPositionRight=nPosition,this},bottom:function(nPosition){var nHeight=0;return this._oParent&&(nHeight=this._oParent.get("height")),!nHeight&&this._oLayer&&(nHeight=this._oLayer.option("height")),nHeight?this.set("y",nHeight-(this._htOption.height+nPosition)):this._nPositionBottom=nPosition,this},resizeFixedRatio:function(nWidth,nHeight){if(this.getImage()){var nImageWidth=this.getImage().width,nImageHeight=this.getImage().height;nWidth?nHeight=nWidth*(nImageHeight/nImageWidth):nHeight&&(nWidth=nHeight*(nImageWidth/nImageHeight)),this.set("width",Math.round(nWidth)),this.set("height",Math.round(nHeight))}},_setSpritePosition:function(sKey,nValue){if(this._elImage&&null!==nValue)if(null!==this._htOption.spriteSheet){var nOffsetX,nOffsetY,sheet=this._htSpriteSheet[this._htOption.spriteSheet];"spriteSheet"===sKey&&this._htSpriteSheet&&this._htSpriteSheet[nValue]?("undefined"!=typeof sheet[0][0]?null!==this._htOption.spriteX?(nOffsetX=sheet[this._htOption.spriteX][0],nOffsetY=sheet[this._htOption.spriteX][1]):(nOffsetX=sheet[0][0],nOffsetY=sheet[0][1]):(nOffsetX=sheet[0],nOffsetY=sheet[1]),this.set("offsetX",nOffsetX,!0),this.set("offsetY",nOffsetY,!0)):"spriteX"===sKey&&"undefined"!=typeof sheet[nValue]&&(this.set("offsetX",sheet[nValue][0],!0),this.set("offsetY",sheet[nValue][1],!0))}else{var htImageSize=this.getImageSize(),nWidth=this._htOption.width,nHeight=this._htOption.height,nSpriteLength=this._htOption.spriteLength-1,nMaxSpriteX=htImageSize.width/this._htOption.width-1,nMaxSpriteY=htImageSize.height/this._htOption.height-1,nMaxOffsetX=htImageSize.width-1,nMaxOffsetY=htImageSize.height-1;switch(nSpriteLength>=0&&nHeight<htImageSize.height&&(nMaxOffsetX=nMaxSpriteX*htImageSize.width,nMaxOffsetY=nMaxSpriteY*htImageSize.height),sKey){case"spriteX":var nOffsetX=0,nOffsetY=0;nSpriteLength>nMaxSpriteX&&nHeight<htImageSize.height?(nOffsetY=Math.floor(nValue/(nMaxSpriteX+1))*nHeight,nOffsetX=nValue%(nMaxSpriteX+1)*nWidth):nOffsetX=Math.min(nValue,nMaxSpriteX)*nWidth,this.set("offsetX",nOffsetX,!0),this.set("offsetY",nOffsetY,!0);break;case"spriteY":nValue=Math.min(nValue,nMaxSpriteY),this.set("offsetY",nValue*nHeight,!0)}}},hasAttachedHandler:function(){return this._htHandler&&"click"in this._htHandler&&this._htHandler.click.length>0||"mousedown"in this._htHandler&&this._htHandler.mousedown.length>0||"mouseup"in this._htHandler&&this._htHandler.mouseup.length>0?!0:!1},move:function(nX,nY,nVelocity,fCallback){var nCurrentX=this._htOption.x,nCurrentY=this._htOption.y,nDistance=collie.util.getDistance(nCurrentX,nCurrentY,nX,nY),nDuration=Math.round(nDistance/nVelocity*1e3);if(null!==this._oTimerMove&&(this._oTimerMove.stop(),this._oTimerMove=null),nVelocity&&!(nDuration<collie.Renderer.getInfo().fps)){var htOption={from:[nCurrentX,nCurrentY],to:[nX,nY],set:["x","y"]};return fCallback&&(htOption.onComplete=function(){fCallback(this)}),this._oTimerMove=collie.Timer.transition(this,nDuration,htOption),this._oTimerMove}this.set({x:nX,y:nY}),fCallback&&fCallback(this)},moveBy:function(nX,nY,nVelocity,fCallback){var nCurrentX=this._htOption.x,nCurrentY=this._htOption.y;return this.move(nCurrentX+nX,nCurrentY+nY,nVelocity,fCallback)},toString:function(){return"DisplayObject"+(this._htOption.name?" "+this._htOption.name:"")+" #"+this.getId()+(this.getImage()?"(image:"+this.getImage().src+")":"")},clone:function(bRecursive){var oDisplayObject=new this.constructor(this._htOption);if(bRecursive&&this._aDisplayObjects.length)for(var i=0,l=this._aDisplayObjects.length;l>i;i++)this._aDisplayObjects[i].clone(!0).addTo(oDisplayObject);return oDisplayObject}},collie.Component),collie.DisplayObject._idx=0,collie.DisplayObject.htFactory={},collie.MovableObject=collie.Class({$init:function(){}},collie.DisplayObject),collie.Rectangle=collie.Class({$init:function(){this.option({radius:0,strokeColor:"",strokeWidth:0,fillColor:"",fillImage:""},null,!0),this._sBorderRadius=collie.util.getCSSPrefix("border-radius",!0)},onDOMDraw:function(oEvent){this._bChanged&&(this._htOption.radius&&(oEvent.element.style[this._sBorderRadius]=this._htOption.radius+"px",oEvent.element.style.borderRadius=this._htOption.radius+"px"),this._htOption.fillImage?collie.ImageManager.getImage(this._htOption.fillImage,function(el){oEvent.element.style.backgroundImage="url('"+el.src+"')"}):this._htOption.fillColor&&(oEvent.element.style.backgroundColor=this._htOption.fillColor),this._htOption.strokeWidth&&(oEvent.element.style.border=this._htOption.strokeWidth+"px solid "+this._htOption.strokeColor),this._bChanged=!1)},onCanvasDraw:function(oEvent){var oContext=oEvent.context,nRadius=this._htOption.radius,bIsRetinaDisplay=collie.Renderer.isRetinaDisplay(),nWidth=this._htOption.width,nHeight=this._htOption.height,nStrokeWidth=this._htOption.strokeWidth;if(bIsRetinaDisplay&&(nWidth*=2,nHeight*=2,nRadius*=2,nStrokeWidth*=2),htInfo.fillImage){var el=collie.ImageManager.getImage(htInfo.fillImage);if(el){var pattern=oContext.createPattern(el,"repeat");oContext.fillStyle=pattern}else collie.ImageManager.getImage(htInfo.fillImage,function(){this.setChanged()}.bind(this))}else htInfo.fillColor&&(oContext.fillStyle=htInfo.fillColor);this._htOption.strokeColor&&(oContext.strokeStyle=this._htOption.strokeColor),this._htOption.strokeWidth&&(oContext.lineWidth=nStrokeWidth),nRadius?(oContext.save(),oContext.translate(oEvent.x,oEvent.y),oContext.beginPath(),oContext.moveTo(nRadius,0),oContext.lineTo(nWidth-nRadius,0),oContext.quadraticCurveTo(nWidth,0,nWidth,nRadius),oContext.lineTo(nWidth,nHeight-nRadius),oContext.quadraticCurveTo(nWidth,nHeight,nWidth-nRadius,nHeight),oContext.lineTo(nRadius,nHeight),oContext.quadraticCurveTo(0,nHeight,0,nHeight-nRadius),oContext.lineTo(0,nRadius),oContext.quadraticCurveTo(0,0,nRadius,0),oContext.closePath(),oContext.restore(),(this._htOption.fillColor||this._htOption.fillImage)&&oContext.fill(),this._htOption.strokeWidth&&oContext.stroke()):((this._htOption.fillColor||this._htOption.fillImage)&&oContext.fillRect(oEvent.x,oEvent.y,nWidth,nHeight),this._htOption.strokeWidth&&oContext.strokeRect(oEvent.x,oEvent.y,nWidth,nHeight)),this._bChanged=!1},toString:function(){return"Rectangle"+(this.get("name")?" "+this.get("name"):"")+" #"+this.getId()+(this.getImage()?"(image:"+this.getImage().src+")":"")}},collie.DisplayObject),collie.Circle=collie.Class({$init:function(){this.option({radius:0,strokeColor:"#000000",strokeWidth:0,fillColor:"",fillImage:"",startAngle:0,endAngle:360,closePath:!1,anticlockwise:!1,autoExpand:!0},null,!0),this._oPaper=null,this.optionSetter("radius",this._expandSize.bind(this)),this._expandSize()},_expandSize:function(){if(this._htOption.autoExpand&&this._htOption.radius){var size=2*this._htOption.radius+this._htOption.strokeWidth;this.set("width",size),this.set("height",size)}},onDOMDraw:function(oEvent){var el=oEvent.element;if("undefined"!=typeof Raphael){var circle,htInfo=this.get(),nStrokeWidth=htInfo.strokeWidth,nRadius=htInfo.radius,nWidth=htInfo.width,nHeight=htInfo.height,htDirty=this.getDirty();if(null===this._oPaper?(this._oPaper=Raphael(el,nWidth+nStrokeWidth,nHeight+nStrokeWidth),this._oPaper.canvas.style.zIndex=10):htDirty&&(htDirty.width||htDirty.height)&&this._oPaper.setSize(nWidth,nHeight),el.style.left=-(nStrokeWidth/2)+"px",el.style.top=-(nStrokeWidth/2)+"px",this._oPaper.clear(),nRadius){var rx=nRadius,ry=nRadius,x1=rx+nRadius*Math.cos(collie.util.toRad(htInfo.startAngle)),y1=ry+nRadius*Math.sin(collie.util.toRad(htInfo.startAngle)),x2=rx+nRadius*Math.cos(collie.util.toRad(htInfo.endAngle)),y2=ry+nRadius*Math.sin(collie.util.toRad(htInfo.endAngle)),angle=htInfo.anticlockwise?htInfo.startAngle-htInfo.endAngle:htInfo.endAngle-htInfo.startAngle;Math.abs(angle)>=360?angle=360:0>angle&&(angle+=360);var flag1=angle>180?1:0,flag2=htInfo.anticlockwise?0:1;circle=angle>=360?this._oPaper.circle(rx,ry,nRadius):this._oPaper.path("M"+x1+","+y1+"a"+nRadius+","+nRadius+",0,"+flag1+","+flag2+","+(x2-x1)+","+(y2-y1)+(htInfo.closePath?"L"+rx+","+ry+"L"+x1+","+y1+"Z":""))}circle&&(circle.transform("t"+nStrokeWidth/2+","+nStrokeWidth/2),htInfo.fillImage?collie.ImageManager.getImage(htInfo.fillImage,function(el){circle.attr("fill","url('"+el.src+"')")}):htInfo.fillColor&&circle.attr("fill",htInfo.fillColor),htInfo.strokeColor&&circle.attr("stroke",htInfo.strokeColor),circle.attr("stroke-width",htInfo.strokeWidth))}},onCanvasDraw:function(oEvent){var htInfo=this.get(),oContext=oEvent.context,nX=oEvent.x,nY=oEvent.y,bIsRetinaDispaly=collie.Renderer.isRetinaDisplay(),nRadius=htInfo.radius,nStrokeWidth=htInfo.strokeWidth,nWidth=htInfo.width,nHeight=htInfo.height;if(bIsRetinaDispaly&&(nWidth*=2,nHeight*=2,nRadius*=2,nStrokeWidth*=2),htInfo.fillImage){var el=collie.ImageManager.getImage(htInfo.fillImage);if(el){var pattern=oContext.createPattern(el,"repeat");oContext.fillStyle=pattern}else collie.ImageManager.getImage(htInfo.fillImage,function(){this.setChanged()}.bind(this))}else htInfo.fillColor&&(oContext.fillStyle=htInfo.fillColor);if(htInfo.strokeColor&&(oContext.strokeStyle=htInfo.strokeColor),nStrokeWidth&&(oContext.lineWidth=nStrokeWidth),nRadius){var rx=nX+nRadius,ry=nY+nRadius,bFullCircle=Math.abs(htInfo.startAngle-htInfo.endAngle)>=360;oContext.beginPath(),htInfo.closePath&&!bFullCircle&&oContext.moveTo(rx,ry),oContext.arc(rx,ry,nRadius,collie.util.toRad(htInfo.startAngle),collie.util.toRad(htInfo.endAngle),htInfo.anticlockwise),htInfo.closePath&&oContext.closePath(),(htInfo.fillColor||htInfo.fillImage)&&oContext.fill(),htInfo.strokeWidth&&oContext.stroke()}},center:function(nCenterX,nCenterY){return this.set("x",nCenterX-this._htOption.radius),this.set("y",nCenterY-this._htOption.radius),this},toString:function(){return"Circle"+(this._htOption.name?" "+this._htOption.name:"")+" #"+this.getId()+(this.getImage()?"(image:"+this.getImage().src+")":"")}},collie.DisplayObject),collie.Polyline=collie.Class({$init:function(){this.option({strokeColor:"#000000",strokeWidth:1,fillColor:"",fillImage:"",lineCap:"butt",lineJoin:"miter",miterLimit:10,dashArray:"",closePath:!1},null,!0),this._aPointData=[],this._oPaper=null,this._htPointBoundary={right:null,bottom:null}},setPointData:function(aPointData,bSkipExpandSize){this._aPointData=aPointData,this.setChanged(),bSkipExpandSize||this._expandBoundary(aPointData)},getPointData:function(){return this._aPointData},addPoint:function(nX,nY,bSkipExpandSize){this._aPointData.push([nX,nY]),this.setChanged(),bSkipExpandSize||this._expandBoundary(nX,nY)},moveTo:function(nX,nY){this._aPointData.push([nX,nY,!0])},lineTo:function(nX,nY,bSkipExpandSize){this.addPoint(nX,nY,bSkipExpandSize)},resetPointData:function(){this._aPointData=[],this._htPointBoundary={right:null,bottom:null},this.setChanged()},_expandBoundary:function(nX,nY,bSkipAdoptSize){if(nX instanceof Array)for(var i=0,len=nX.length;len>i;i++)this._expandBoundary(nX[i][0],nX[i][1],!0);else this._htPointBoundary.right=null===this._htPointBoundary.right?nX:Math.max(nX,this._htPointBoundary.right),this._htPointBoundary.bottom=null===this._htPointBoundary.bottom?nY:Math.max(nY,this._htPointBoundary.bottom);if(!bSkipAdoptSize){var nStrokeWidth=this._htOption.strokeWidth*(collie.Renderer.isRetinaDisplay()?2:1),nWidth=this._htPointBoundary.right+2*nStrokeWidth,nHeight=this._htPointBoundary.bottom+2*nStrokeWidth;this.set({width:nWidth,height:nHeight}),null!==this._oPaper&&this._oPaper.setSize(nWidth,nHeight)}},onDOMDraw:function(oEvent){var el=oEvent.element;if(!(this._aPointData.length<2)&&"undefined"!=typeof Raphael){var htInfo=this.get(),nStrokeWidth=htInfo.strokeWidth,htDirty=this.getDirty();null===this._oPaper?(this._oPaper=Raphael(el,htInfo.width,htInfo.height),this._oPaper.canvas.style.zIndex=10):htDirty&&(htDirty.width||htDirty.height)&&this._oPaper.setSize(htInfo.width,htInfo.height),el.style.left=-(nStrokeWidth/2)+"px",el.style.top=-(nStrokeWidth/2)+"px",this._oPaper.clear();for(var str="M"+this._aPointData[0][0]+","+this._aPointData[0][1],i=1,len=this._aPointData.length;len>i;i++)str+=(this._aPointData[i][2]?"M":"L")+this._aPointData[i][0]+","+this._aPointData[i][1];!htInfo.closePath||this._aPointData[0][0]===this._aPointData[this._aPointData.length-1][0]&&this._aPointData[0][1]===this._aPointData[this._aPointData.length-1][1]||(str+="L"+this._aPointData[0][0]+","+this._aPointData[0][1]);var line=this._oPaper.path(str+(htInfo.closePath?"Z":""));line.transform("t"+nStrokeWidth/2+","+nStrokeWidth/2),htInfo.fillImage?collie.ImageManager.getImage(htInfo.fillImage,function(el){line.attr("fill","url('"+el.src+"')")}):htInfo.fillColor&&line.attr("fill",htInfo.fillColor),htInfo.lineCap&&line.attr("stroke-linecap",htInfo.lineCap),htInfo.lineJoin&&line.attr("stroke-linejoin",htInfo.lineJoin),null!==htInfo.miterLimit&&line.attr("stroke-miterlimit",htInfo.miterLimit),htInfo.strokeColor&&line.attr("stroke",htInfo.strokeColor),line.attr("stroke-width",nStrokeWidth),htInfo.dashArray&&line.attr("stroke-dasharray",htInfo.dashArray)}},onCanvasDraw:function(oEvent){if(!(this._aPointData.length<2)){var htInfo=this.get(),oContext=oEvent.context,bIsRetinaDisplay=collie.Renderer.isRetinaDisplay(),nStrokeWidth=htInfo.strokeWidth,nRatio=bIsRetinaDisplay?2:1;if(oContext.save(),oContext.translate(oEvent.x,oEvent.y),bIsRetinaDisplay&&(nStrokeWidth*=2),htInfo.fillImage){var el=collie.ImageManager.getImage(htInfo.fillImage);if(el){var pattern=oContext.createPattern(el,"repeat");oContext.fillStyle=pattern}else collie.ImageManager.getImage(htInfo.fillImage,function(){this.setChanged()}.bind(this))}else htInfo.fillColor&&(oContext.fillStyle=htInfo.fillColor);if(htInfo.strokeColor&&(oContext.strokeStyle=htInfo.strokeColor),oContext.lineWidth=nStrokeWidth,htInfo.lineCap&&(oContext.lineCap=htInfo.lineCap),htInfo.lineJoin&&(oContext.lineJoin=htInfo.lineJoin),htInfo.miterLimit&&(oContext.miterLimit=htInfo.miterLimit),htInfo.dashArray){if(htInfo.fillColor||htInfo.fillImage){oContext.beginPath(),oContext.moveTo(this._aPointData[0][0]*nRatio,this._aPointData[0][1]*nRatio);for(var i=1,len=this._aPointData.length;len>i;i++)this._aPointData[i][2]?oContext.moveTo(this._aPointData[i][0]*nRatio,this._aPointData[i][1]*nRatio):oContext.lineTo(this._aPointData[i][0]*nRatio,this._aPointData[i][1]*nRatio);htInfo.closePath&&oContext.closePath(),oContext.fill()}oContext.resetDashedLine()}oContext.beginPath(),oContext.moveTo(this._aPointData[0][0]*nRatio,this._aPointData[0][1]*nRatio);for(var i=1,len=this._aPointData.length;len>i;i++)this._aPointData[i][2]?oContext.moveTo(this._aPointData[i][0]*nRatio,this._aPointData[i][1]*nRatio):htInfo.dashArray?oContext.dashedLine(this._aPointData[i-1][0]*nRatio,this._aPointData[i-1][1]*nRatio,this._aPointData[i][0]*nRatio,this._aPointData[i][1]*nRatio,collie.raphaelDashArray[htInfo.dashArray],nStrokeWidth):oContext.lineTo(this._aPointData[i][0]*nRatio,this._aPointData[i][1]*nRatio);htInfo.dashArray&&htInfo.closePath&&(this._aPointData[0][0]!==this._aPointData[this._aPointData.length-1][0]||this._aPointData[0][1]!==this._aPointData[this._aPointData.length-1][1])&&oContext.dashedLine(this._aPointData[i-1][0]*nRatio,this._aPointData[i-1][1]*nRatio,this._aPointData[0][0]*nRatio,this._aPointData[0][1]*nRatio,collie.raphaelDashArray[htInfo.dashArray],nStrokeWidth),htInfo.closePath&&oContext.closePath(),htInfo.dashArray||!htInfo.fillColor&&!htInfo.fillImage||oContext.fill(),htInfo.strokeWidth&&oContext.stroke(),oContext.restore()}},toString:function(){return"Polyline"+(this._htOption.name?" "+this._htOption.name:"")+" #"+this.getId()+(this.getImage()?"(image:"+this.getImage().src+")":"")}},collie.DisplayObject),collie.Text=collie.Class({$init:function(){this._sText="",this.option({fontFamily:"Arial",fontWeight:"",fontSize:12,fontColor:"#000000",lineHeight:"auto",textAlign:"left",padding:"0 0 0 0",ellipsisMaxLine:0,ellipsisString:"...",useEllipsis:!1,useCache:!0},null,!0),this._elText=null,this._nTextWidth=0,this._nRatio=1,this._aCallbackTextWidth=[]},_initElement:function(){null===this._elText&&(this._elText=document.createElement("div"),this._elText.style.display="inline",this.getDrawing().getItemElement().appendChild(this._elText))},onCanvasDraw:function(oEvent){this._nRatio="canvas"===this._sRenderingMode&&this._bRetinaDisplay?2:1,this._oContext=oEvent.context;var nMaxWidth=this._getMaxWidth();this._oContext.font=this._getFontText(),this._oContext.fillStyle=this._htOption.fontColor,this._oContext.textBaseline="top",this._fillTextMultiline(this._wordWrap(nMaxWidth).split("\n"),oEvent.x,oEvent.y),this._triggerGetTextWidth()},onDOMDraw:function(oEvent){this._initElement();var el=(this.getDrawing(),oEvent.element),sText=this._sText.replace(/\n/g,"<br />"),elStyle=el.style;elStyle.font=this._getFontText(),elStyle.color=this._htOption.fontColor,elStyle.padding=this._getPadding().replace(/ /g,"px ")+"px",elStyle.width=this._getMaxWidth()+"px",elStyle.height=this._getMaxHeight()+"px",elStyle.lineHeight=this._getLineHeight()+"px",elStyle.textAlign=this._htOption.textAlign,this._elText.innerHTML!=sText&&(this._elText.innerHTML=sText),this.unsetChanged(),this._getDOMTextWidth(),this._triggerGetTextWidth()},_getDOMTextWidth:function(){null!==this._elText&&(this._nTextWidth=this._elText.offsetWidth)},_getFontText:function(){return this._htOption.fontWeight+" "+this._htOption.fontSize*this._nRatio+"px "+this._htOption.fontFamily},_getLineHeight:function(){return"auto"===this._htOption.lineHeight?this._htOption.fontSize*this._nRatio:this._htOption.lineHeight*this._nRatio},_fillTextMultiline:function(aText,nX,nY){var nLeft=this._getPadding("left"),nMaxLine=this._htOption.ellipsisMaxLine;this._nTextWidth=0;for(var i=0;i<aText.length;i++){nMaxLine&&i>=nMaxLine-1&&aText.length>nMaxLine&&(aText[i]=this._insertEllipsisText(aText[i]),aText.splice(i+1,aText.length-(i+1)));var nTextWidth=this._oContext.measureText(aText[i]).width;"center"===this._htOption.textAlign?nLeft=this._getMaxWidth()/2-nTextWidth/2+this._getPadding("left"):"right"===this._htOption.textAlign&&(nLeft=this._htOption.width*this._nRatio-this._getPadding("right")-nTextWidth),this._oContext.fillText(aText[i],nX+nLeft,nY+this._getTopPosition(i+1)),this._nTextWidth=Math.max(this._nTextWidth,nTextWidth)}},_getMaxWidth:function(){return this._htOption.width*this._nRatio-(this._getPadding("left")+this._getPadding("right"))},_getMaxHeight:function(){return this._htOption.height*this._nRatio-(this._getPadding("top")+this._getPadding("bottom"))},_getTopPosition:function(nLine){return this._getLineHeight()*(nLine-1)+this._getPadding("top")},_getPadding:function(sPositionName){for(var sPadding=this._htOption.padding||"0 0 0 0",aPadding=sPadding.split(" "),i=0,len=aPadding.length;len>i;i++)aPadding[i]=parseInt(aPadding[i],10)*this._nRatio;switch(sPositionName){case"top":return aPadding[0];case"right":return aPadding[1];case"bottom":return aPadding[2];case"left":return aPadding[3];default:return aPadding.join(" ")}},_insertEllipsisText:function(sText){for(var nWidth=this._getMaxWidth(),sEllipsizedText="",i=sText.length;i>0;i--)if(sEllipsizedText=sText.substr(0,i)+this._htOption.ellipsisString,this._oContext.measureText(sEllipsizedText).width<=nWidth)return sEllipsizedText;return sText},_wordWrap:function(nWidth,sText){var sOriginalText=sText||this._sText,nCount=1;if(!sOriginalText)return"";for(sText=sOriginalText.substr(0,1);this._oContext.measureText(sText).width<=nWidth;){if(nCount++,nCount>sOriginalText.length)return sText;if(sText=sOriginalText.substr(0,nCount),"\n"===sOriginalText.substr(nCount-1,1))break}return nCount=Math.max(1,nCount-1),sText=sOriginalText.substr(0,nCount),"\n"===sOriginalText.substr(nCount,1)&&nCount++,sOriginalText.length>nCount&&(sText+="\n"+this._wordWrap(nWidth,sOriginalText.substr(nCount))),sText},text:function(sText){return this._nTextWidth=0,this._aCallbackTextWidth=[],this._sText=sText.toString(),this.setChanged(),this},getTextWidth:function(fCallback){return fCallback&&this._aCallbackTextWidth.push(fCallback),this._nTextWidth?(this._triggerGetTextWidth(),this._nTextWidth/this._nRatio):void 0},_triggerGetTextWidth:function(){if(this._aCallbackTextWidth.length>0){for(var i=0,len=this._aCallbackTextWidth.length;len>i;i++)this._aCallbackTextWidth[i](this._nTextWidth/this._nRatio);this._aCallbackTextWidth=[]}},toString:function(){return"Text"+(this._htOption.name?" "+this._htOption.name:"")+" #"+this.getId()+(this.getImage()?"(image:"+this.getImage().src+")":"")}},collie.DisplayObject),collie.Animation=collie.Class({$init:function(fCallback,nDuration,htOption){this._nId=++collie.Animation._idx,this._bIsPlaying=!1,this._fCallback=fCallback,this._oTimerList=null,this.option("useAutoStart",!0),this.option(("object"==typeof nDuration?nDuration:htOption)||{}),this.setDuration(nDuration),this.setOptionEvent(htOption)},setOptionEvent:function(htOption){if(htOption)for(var i in htOption)0===i.toString().indexOf("on")&&this.attach(i.toString().replace(/^on/,"").toLowerCase(),htOption[i])},triggerCallback:function(htParam){if("function"!=typeof this._fCallback&&this._htOption.set){var htOption={};if(this._htOption.set instanceof Array)for(var i=0,len=this._htOption.set.length;len>i;i++)htOption[this._htOption.set[i]]=htParam.value instanceof Array?htParam.value[i]:htParam.value;else htOption[this._htOption.set]=htParam.value;if(this._fCallback instanceof Array)for(var j=0,len=this._fCallback.length;len>j;j++)this._fCallback[j].set(htOption);else this._fCallback.set(htOption)}else this._fCallback&&this._fCallback(htParam)},setDuration:function(nDuration){this._nDuration=parseInt(nDuration,10)},getDuration:function(){return this._nDuration},setTimerList:function(oTimerList){this._oTimerList=oTimerList,this._htOption.useAutoStart&&this.start()},getId:function(){return this._nId},run:function(){throw new Error("abstract method")},reset:function(){throw new Error("abstract method")},stop:function(bSkipEvent){this.isPlaying()&&(null!==this._oTimerList&&this._oTimerList.remove(this),this._bIsPlaying=!1,this.reset(),bSkipEvent||this.fireEvent("stop"))},pause:function(){this.isPlaying()&&(this._bIsPlaying=!1,this.fireEvent("pause"),null!==this._oTimerList&&this._oTimerList.remove(this))},start:function(){this.isPlaying()||(this._bIsPlaying=!0,null!==this._oTimerList&&this._oTimerList.add(this),this.fireEvent("start"))},isPlaying:function(){return this._bIsPlaying},complete:function(){this.isPlaying()&&(this._fCallbackComplete&&this._fCallbackComplete(),this.stop(!0),this.fireEvent("complete"))}},collie.Component),collie.Animation._idx=0,collie.AnimationTransition=collie.Class({$init:function(fCallback,nDuration,htOption){this.option({from:null,to:null,set:"",loop:1,effect:collie.Effect.linear}),this._htCallback={},this.option(htOption||{});var fReset=this.reset.bind(this);this.optionSetter("from",fReset),this.optionSetter("to",fReset),this._nCount=0,this._nCountCycle=0,this._nFrameAtRunLastest=null,this._nRunningTime=null,this._bIsArrayValue=!1},start:function(){null===this._htOption.from&&"function"!=typeof this._fCallback&&this._setDefaultFromValues(),null===this._nFrameAtRunLastest&&this.reset(),this.constructor.$super.start.call(this)
},_setDefaultFromValues:function(){var vFrom=null;if(this._htOption.set){if(this._htOption.set instanceof Array){vFrom=[];for(var i=0,len=this._htOption.set.length;len>i;i++)vFrom.push(this._fCallback.get(this._htOption.set[i]))}else vFrom=this._fCallback.get(this._htOption.set);this.option("from",vFrom)}},reset:function(){if(this._nFrameAtRunLastest=null,this._nRunningTime=null,this._nValue=this._htOption.from,this._bIsArrayValue=this._htOption.from instanceof Array,this._nCount=0,this._nCountCycle=0,this._bIsArrayValue){this._fEffect=[];for(var fEffect=null,i=0,len=this._htOption.from.length;len>i;i++)fEffect=this._htOption.effect instanceof Array?this._htOption.effect[i]:this._htOption.effect,this._fEffect[i]=fEffect(this._htOption.from[i],this._htOption.to[i])}else this._fEffect=this._htOption.effect(this._htOption.from,this._htOption.to)},setValue:function(vValue){this._nValue=vValue},getValue:function(){return this._nValue},run:function(nCurrentFrame,nFrameDuration){if(void 0===nCurrentFrame&&(nCurrentFrame=collie.Renderer.getInfo().frame),this._nFrameAtRunLastest>nCurrentFrame)return void this.reset();if(null===this._nFrameAtRunLastest&&(this._nFrameAtRunLastest=nCurrentFrame,this._nRunningTime=0,nFrameDuration=0),this._nRunningTime+=nFrameDuration,this._nCount++,this._nRunningTime>=this._nDuration)if(this._nCountCycle++,!this._isEndValue()&&this._htOption.loop&&this._htOption.loop<=this._nCountCycle)this._setEndValue();else{if(this._htOption.loop&&!(this._htOption.loop>this._nCountCycle))return void this.complete();this.fireEvent("end"),this._nFrameAtRunLastest=nCurrentFrame,this._nRunningTime=this._nRunningTime-this._nDuration,this._nValue=this._htOption.from,this._transitionValue(this._nRunningTime)}else this._nRunningTime>0&&this._transitionValue(this._nRunningTime);this._htCallback.timer=this,this._htCallback.frame=nCurrentFrame,this._htCallback.duration=this._nDuration,this._htCallback.cycle=this._nCountCycle,this._htCallback.runningTime=this._nRunningTime,this._htCallback.from=this._htOption.from,this._htCallback.to=this._htOption.to,this._htCallback.value=this._nValue,this.triggerCallback(this._htCallback),this._nRunningTime>0&&(this._nFrameAtRunLastest=nCurrentFrame)},_transitionValue:function(nCurrentRunningTime){if(this._bIsArrayValue){this._nValue=[];for(var i=0,len=this._htOption.from.length;len>i;i++)this._nValue[i]=parseFloat(this._fEffect[i](Math.max(0,Math.min(1,nCurrentRunningTime/this._nDuration))))}else this._nValue=parseFloat(this._fEffect(Math.max(0,Math.min(1,nCurrentRunningTime/this._nDuration))))},_isEndValue:function(){if(this._bIsArrayValue){for(var i=0,len=this._htOption.to.length;len>i;i++)if(this._nValue[i]!==parseFloat(this._fEffect[i](1)))return!1;return!0}return this._nValue===parseFloat(this._fEffect(1))},_setEndValue:function(){if(this._bIsArrayValue)for(var i=0,len=this._htOption.to.length;len>i;i++)this._nValue[i]=parseFloat(this._fEffect[i](1));else this._nValue=parseFloat(this._fEffect(1))}},collie.Animation),collie.AnimationRepeat=collie.Class({$init:function(fCallback,nDuration,htOption){this.option({beforeDelay:0,afterDelay:0,loop:0,useRealTime:!0}),this.option(htOption||{}),this.reset(),this.setDuration(nDuration),this._nFrameAtRunLastest=null},setDuration:function(nDuration){nDuration=parseInt(nDuration,10),nDuration<collie.Renderer.getDuration()&&(nDuration=collie.Renderer.getDuration()),this._nDuration=nDuration},reset:function(){this._nCount=0,this._nFrameAtRunLastest=null,this._nRunningTime=null,this._nRunLastestTime=null,this._nBeforeDelay=this._htOption.beforeDelay},run:function(nCurrentFrame,nFrameDuration){if(void 0===nCurrentFrame&&(nCurrentFrame=collie.Renderer.getInfo().frame),this._nFrameAtRunLastest>nCurrentFrame)return void this.reset();null===this._nFrameAtRunLastest&&(this._nFrameAtRunLastest=nCurrentFrame,this._nRunningTime=0,this._nRunLastestTime=0,nFrameDuration=0),this._nRunningTime+=nFrameDuration;var nSkippedCount=Math.max(1,Math.floor((this._nRunningTime-this._nRunLastestTime)/this._nDuration))-1;if(0===this._nCount&&this._nBeforeDelay)return void(this._nRunLastestTime+this._nBeforeDelay<=this._nRunningTime&&(this.reset(),this._nBeforeDelay=0));if(0===this._nRunningTime||this._nRunLastestTime+this._nDuration<=this._nRunningTime){if(this._nCount+=this._htOption.useRealTime?1+nSkippedCount:1,this._fCallback({timer:this,frame:nCurrentFrame,duration:this._nDuration,count:this._nCount,skippedCount:nSkippedCount,runningTime:this._nRunningTime}),this._htOption.loop&&this._htOption.loop<=this._nCount)return void this.complete();this._nFrameAtRunLastest=nCurrentFrame,this._nRunLastestTime=this._nRunningTime}}},collie.Animation),collie.AnimationCycle=collie.Class({$init:function(fCallback,nDuration,htOption){this._nFPS=null,this._htCallback={};var fSetterFPS=this._setterFPS.bind(this);this.optionSetter("valueSet",this._setterValueSet.bind(this)),this.optionSetter("to",fSetterFPS),this.optionSetter("from",fSetterFPS),this.option({delay:0,from:0,to:0,step:1,loop:0,set:"spriteX",useRealTime:!0,valueSet:null,start:null}),this.option(htOption||{}),this._nFrameAtRunLastest=null,this._nRunLastestTime=null,this._nRunningTime=null,this._nCountCycle=0,this._nCountCycleBefore=0,this.setDuration(nDuration),this.reset()},reset:function(){this._nCount=0,this._nCountCycle=0,this._nCountCycleBefore=0,this._nFrameAtRunLastest=null,this._nRunningTime=null,this._nRunLastestTime=null,this._nValue=(null!==this._htOption.start?this._htOption.start:this._htOption.from)-this._htOption.step},_setterValueSet:function(){var aValueSet=this._htOption.valueSet;aValueSet&&aValueSet instanceof Array&&this.option({from:0,to:aValueSet.length-1,step:1})},_setterFPS:function(){if(null!==this._nFPS&&"undefined"!=typeof this._htOption.to&&"undefined"!=typeof this._htOption.from){var nCount=this._htOption.to-this._htOption.from+1;this._nDuration=Math.round(1e3/this._nFPS*nCount)}},setDuration:function(nDuration){this._nDuration=parseInt(nDuration,10),/fps/i.test(nDuration)&&"undefined"!=typeof this._htOption.to&&"undefined"!=typeof this._htOption.from?(this._nFPS=parseInt(nDuration,10),this._setterFPS()):this._nFPS=null},setValue:function(vValue){this._nValue=vValue},getValue:function(){return this._htOption.valueSet?this._htOption.valueSet[this._nValue]:this._nValue},run:function(nCurrentFrame,nFrameDuration){if("undefined"==typeof nCurrentFrame&&(nCurrentFrame=collie.Renderer.getInfo().frame),this._nFrameAtRunLastest>nCurrentFrame)return void this.reset();null===this._nFrameAtRunLastest&&(this._nFrameAtRunLastest=nCurrentFrame,this._nRunLastestTime=0,this._nRunningTime=0,nFrameDuration=0),nFrameDuration||(nFrameDuration=0);var htOption=this._htOption,nDiff=htOption.to-htOption.from;this._nTotalCount=nDiff/htOption.step,this._nTerm=this._nDuration/this._nTotalCount,this._nRunningTime+=nFrameDuration;var nSkippedCount=htOption.useRealTime?Math.max(1,Math.floor((this._nRunningTime-this._nRunLastestTime)/this._nTerm))-1:0;if(0===this._nRunningTime||this._nRunLastestTime+this._nTerm<=this._nRunningTime){if(this._nCountCycleBefore!==this._nCountCycle&&this.fireEvent("end"),htOption.loop&&this._nCountCycle>=htOption.loop)return void this.complete();if(this._nValue===htOption.to&&(this._nValue=htOption.from-htOption.step),this._nValue+=htOption.step*(1+nSkippedCount),this._nCount+=1+nSkippedCount,this._nCountCycleBefore=this._nCountCycle,htOption.from<=htOption.to?this._nValue>=htOption.to:this._nValue<=htOption.to){var nOverCount=(this._nValue-htOption.to)/htOption.step,nOverCountCycle=Math.ceil(nOverCount/(this._nTotalCount+1));nOverCount%=this._nTotalCount+1,nOverCount?(this._nCountCycle+=nOverCountCycle,this._nValue=htOption.from+(nOverCount-1)*htOption.step):(this._nCountCycle+=1,this._nValue=htOption.to)}this._htCallback.timer=this,this._htCallback.frame=nCurrentFrame,this._htCallback.duration=this._nDuration,this._htCallback.count=this._nCount,this._htCallback.skippedCount=nSkippedCount,this._htCallback.runningTime=this._nRunningTime,this._htCallback.value=this.getValue(),this._htCallback.cycle=this._nCountCycle,this._htCallback.step=htOption.step,this._htCallback.from=htOption.from,this._htCallback.to=htOption.to,this.triggerCallback(this._htCallback),this._nFrameAtRunLastest=nCurrentFrame,this._nRunLastestTime=this._nRunningTime}}},collie.Animation),collie.AnimationDelay=collie.Class({$init:function(){this.reset()},reset:function(){this._nFrameAtRunLastest=null,this._nRunningTime=null,this._nRunLastestTime=null},run:function(nCurrentFrame,nFrameDuration){return void 0===nCurrentFrame&&(nCurrentFrame=collie.Renderer.getInfo().frame),this._nFrameAtRunLastest>nCurrentFrame?void this.reset():(null===this._nFrameAtRunLastest&&(this._nFrameAtRunLastest=nCurrentFrame,this._nRunLastestTime=0,this._nRunningTime=0,nFrameDuration=0),this._nRunningTime+=nFrameDuration,void(this._nRunLastestTime+this._nDuration<=this._nRunningTime&&(this._fCallback&&this._fCallback({timer:this,frame:nCurrentFrame,duration:this._nDuration,runningTime:this._nRunningTime}),this.complete())))}},collie.Animation),collie.AnimationTimeline=collie.Class({$init:function(aTimeline,htOption){if(this.option("loop",1),this.option(htOption||{}),this.setOptionEvent(htOption),this._htAnimations={},this._aTimeline=null,this._aRunningAnimation=null,this._nRunningTime=null,this._nCountCycle=0,aTimeline)for(var i=0,l=aTimeline.length;l>i;i++)this.addTimeline.apply(this,aTimeline[i]);this.reset()},add:function(nStartTime,vType,fCallback,nDuration,htOption){var oAnimation;switch(vType){case"delay":oAnimation=new collie.AnimationDelay(fCallback,nDuration,htOption);break;case"repeat":oAnimation=new collie.AnimationRepeat(fCallback,nDuration,htOption);break;case"transition":oAnimation=new collie.AnimationTransition(fCallback,nDuration,htOption);break;case"cycle":oAnimation=new collie.AnimationCycle(fCallback,nDuration,htOption);break;case"queue":oAnimation=new collie.AnimationQueue(fCallback);break;default:if(!(vType instanceof collie.Animation))throw new Error(vType+" timer is not defined");oAnimation=vType}return this._addTimeline(nStartTime,oAnimation),oAnimation},_addTimeline:function(nStartTime,oAnimation){nStartTime=parseInt(nStartTime,10),this._htAnimations[nStartTime]=this._htAnimations[nStartTime]||[],this._htAnimations[nStartTime].push(oAnimation),null!==this._aTimeline&&this.reset()},remove:function(nStartTime,oTimer){if(nStartTime=parseInt(nStartTime,10),this._htAnimations&&this._htAnimations[nStartTime]){for(var i=0;i<this._htAnimations[nStartTime].length&&("undefined"!=typeof oTimer&&oTimer!==this._htAnimations[nStartTime][i]||(this._htAnimations[nStartTime][i].stop(),this._htAnimations[nStartTime].splice(i,1),i--,"undefined"==typeof oTimer));i++);this._htAnimations[nStartTime].length<1&&(delete this._htAnimations[nStartTime],this._removeTimelineStartTime(nStartTime))}},_removeTimelineStartTime:function(nStartTime){if(this._aTimeline)for(var i=0,l=this._aTimeline.length;l>i;i++)if(this._aTimeline[i]===nStartTime){this._aTimeline.splice(i,1);break}},_initTimeline:function(){this._aTimeline=[],this._aRunningAnimation=[];for(var i in this._htAnimations)this._aTimeline.push(parseInt(i,10));this._aTimeline.sort(function(a,b){return a-b})},getAnimation:function(nStartTime){return nStartTime=parseInt(nStartTime,10),this._htAnimations&&this._htAnimations[nStartTime]?this._htAnimations[nStartTime]:!1},getRunningTime:function(){return this._nRunningTime||0},getCycle:function(){return this._nCountCycle||0},reset:function(){this._nFrameAtRunLastest=null,this._nRunningTime=null,this._aTimeline=null,this._aRunningAnimation=null,this._nCountCycle=0,this._initTimeline()},run:function(nCurrentFrame,nFrameDuration){if(void 0===nCurrentFrame&&(nCurrentFrame=collie.Renderer.getInfo().frame),this._nFrameAtRunLastest>nCurrentFrame)return void this.reset();if(null===this._nFrameAtRunLastest&&(this._nFrameAtRunLastest=nCurrentFrame,this._nRunningTime=0,nFrameDuration=0),this._nRunningTime+=nFrameDuration,this._aTimeline.length>0)for(;this._aTimeline[0]<=this._nRunningTime;)for(var nStartTime=this._aTimeline.shift(),i=0,l=this._htAnimations[nStartTime].length;l>i;i++)this._aRunningAnimation.push(this._htAnimations[nStartTime][i]),this._htAnimations[nStartTime][i].start();if(this._aRunningAnimation.length>0)for(var i=0;i<this._aRunningAnimation.length;i++)this._aRunningAnimation[i]&&this._aRunningAnimation[i].run(nCurrentFrame,nFrameDuration),this._aRunningAnimation[i]&&this._aRunningAnimation[i].isPlaying()||(this._aRunningAnimation[i]&&this._aRunningAnimation[i].reset(),this._aRunningAnimation.splice(i,1),i--,this._checkComplete())},_checkComplete:function(){this._aRunningAnimation.length<1&&this._aTimeline.length<1&&(this._nCountCycle++,this._htOption.loop&&this._htOption.loop<=this._nCountCycle?this.complete():(this.fireEvent("end"),this._nFrameAtRunLastest=null,this._nRunningTime=null,this._aTimeline=null,this._aRunningAnimation=null,this._initTimeline()))}},collie.Animation),collie.AnimationQueue=collie.Class({$init:function(htOption){this.option("loop",1),this.option(htOption||{}),this.setOptionEvent(htOption),this._aAnimations=[],this._fOnCompleteAnimation=this._onCompleteAnimation.bind(this),this.reset()},delay:function(fCallback,nDuration,htOption){return this._add(new collie.AnimationDelay(fCallback,nDuration,htOption)),this},repeat:function(fCallback,nDuration,htOption){return this._add(new collie.AnimationRepeat(fCallback,nDuration,htOption)),this},transition:function(fCallback,nDuration,htOption){return this._add(new collie.AnimationTransition(fCallback,nDuration,htOption)),this},cycle:function(fCallback,nDuration,htOption){return this._add(new collie.AnimationCycle(fCallback,nDuration,htOption)),this},getAnimation:function(nIdx){return this._aAnimations[nIdx]||!1},_add:function(oAnimation){oAnimation.attach("complete",this._fOnCompleteAnimation),this._aAnimations.push(oAnimation)},_onCompleteAnimation:function(){this.next()},next:function(){if(null===this._nAnimationIdx?this._nAnimationIdx=0:this._nAnimationIdx++,this._nAnimationIdx>=this._aAnimations.length){if(this._nCount++,this.fireEvent("end",{count:this._nCount}),this._htOption.loop&&!(this._htOption.loop>this._nCount))return void this.complete();this._nAnimationIdx=0}this._aAnimations[this._nAnimationIdx].stop(),this._aAnimations[this._nAnimationIdx].start()},reset:function(){this._nFrameAtRunLastest=null,this._nAnimationIdx=null,this._nCount=0},removeAll:function(){this._aAnimations=[],this.reset()},removeAfter:function(){if(this._nAnimationIdx+1<=this._aAnimations.length-1){var count=this._aAnimations.length-(this._nAnimationIdx+1);this._aAnimations.splice(this._nAnimationIdx+1,count)}},run:function(nCurrentFrame,nFrameDuration){if(!(this._aAnimations.length<1)){if(void 0===nCurrentFrame&&(nCurrentFrame=collie.Renderer.getInfo().frame),this._nFrameAtRunLastest>nCurrentFrame)return void this.reset();null===this._nFrameAtRunLastest&&(this._nFrameAtRunLastest=nCurrentFrame),null===this._nAnimationIdx&&this.next(),this._aAnimations[this._nAnimationIdx].run(nCurrentFrame,nFrameDuration)}}},collie.Animation),collie.TimerList=collie.Class({$init:function(){this._aList=[]},add:function(oAnimation){this._aList.unshift(oAnimation)},remove:function(oAnimation){for(var i=0,len=this._aList.length;len>i;i++)if(this._aList[i]===oAnimation){this._aList.splice(i,1);break}},removeAll:function(){this._aList=[]},stopAll:function(){for(var i=this._aList.length-1;i>=0;i--)this._aList[i].stop()},run:function(nCurrentFrame,nFrameDuration){for(var i=this._aList.length-1;i>=0;i--)this._aList[i]&&(this._aList[i].isPlaying()?this._aList[i].run(nCurrentFrame,nFrameDuration):this._aList.splice(i,1))}}),collie.Timer=collie.Timer||new(collie.Class({$init:function(){this._oList=new collie.TimerList},run:function(nCurrentFrame,nFrameDuration){this._oList.run(nCurrentFrame,nFrameDuration)},stopAll:function(){this._oList.stopAll()},removeAll:function(){this._oList.removeAll()},queue:function(htOption){var oAnimation=new collie.AnimationQueue(htOption);return oAnimation.setTimerList(this._oList),oAnimation},repeat:function(fCallback,nDuration,htOption){var oAnimation=new collie.AnimationRepeat(fCallback,nDuration,htOption);return oAnimation.setTimerList(this._oList),oAnimation},transition:function(fCallback,nDuration,htOption){var oAnimation=new collie.AnimationTransition(fCallback,nDuration,htOption);return oAnimation.setTimerList(this._oList),oAnimation},cycle:function(fCallback,nDuration,htOption){var oAnimation=new collie.AnimationCycle(fCallback,nDuration,htOption);return oAnimation.setTimerList(this._oList),oAnimation},delay:function(fCallback,nDuration,htOption){var oAnimation=new collie.AnimationDelay(fCallback,nDuration,htOption);return oAnimation.setTimerList(this._oList),oAnimation},timeline:function(aTimeline,htOption){var oAnimation=new collie.AnimationTimeline(aTimeline,htOption);return oAnimation.setTimerList(this._oList),oAnimation}})),collie.Renderer=collie.Renderer||new(collie.Class({DEFAULT_FPS:"60fps",RETINA_DISPLAY:!1,DEBUG_USE_DELAY:!1,DEBUG_MAX_DELAY:200,DEBUG_RENDERING_MODE:"auto",USE_AUTO_PAUSE:!0,DELAY_LIMIT:3e3,$init:function(){this._sVisibilityChange=this._getNamePageVisibility(),this._bPlaying=!1,this._bPause=!1,this._nFPS=0,this._nDuration=0,this._nCurrentFrame=0,this._nSkippedFrame=0,this._nBeforeFrameTime=null,this._nBeforeRenderingTime=0,this._aLayerList=[],this._fRender=this._render.bind(this),this._fCallback=null,this._htCallback={},this._elContainer=document.createElement("div"),this._elContainer.className="_collie_container",this._elContainer.style.position="relative",this._elContainer.style.overflow="hidden",this._elParent=null,this._nDebugDelayedTime=0,this._oRenderingTimer=null,this._bLoaded=!1,this._sRenderingMode=null,this._bUseRetinaDisplay=null,this._htEventStatus={},this._htPosition={},this._bIsPreventDefault=!0,this._htDeviceInfo=collie.util.getDeviceInfo(),this._fOnChangeVisibility=this._onChangeVisibility.bind(this),this._fOnPageShow=this._onPageShow.bind(this),this._fOnPageHide=this._onPageHide.bind(this),this._fRefresh=this.refresh.bind(this)},_onPageShow:function(){this.USE_AUTO_PAUSE&&!this.isPlaying()&&this._bPause&&this.resume()},_onPageHide:function(){this.USE_AUTO_PAUSE&&this.isPlaying()&&this.pause()},_onChangeVisibility:function(){if(this.USE_AUTO_PAUSE){var state=document.visibilityState||document.webkitVisibilityState||document.mozVisibilityState;"hidden"===state?this.pause():"visible"===state&&this.resume()}},refresh:function(){null!==this._elParent&&(this._htPosition=collie.util.getPosition(this._elParent))},getPosition:function(){return this._bLoaded?this._htPosition:!1},addLayer:function(oLayer){if(!(oLayer&&"type"in oLayer&&"layer"===oLayer.type))throw new Error("oLayer is not Layer instnace");for(var i=0,len=this._aLayerList.length;len>i;i++)if(this._aLayerList[i]===oLayer)return;this._aLayerList.push(oLayer),this._bLoaded&&(oLayer.load(this._elContainer,this._aLayerList.length),this.resetLayerEvent())},removeLayer:function(oLayer){for(var i=0,len=this._aLayerList.length;len>i;i++)if(this._aLayerList[i]===oLayer)return this._aLayerList[i].unload(),void this._aLayerList.splice(i,1)},removeAllLayer:function(){for(var i=this._aLayerList.length-1;i>=0;i--)this._aLayerList[i].unload();this._aLayerList=[]},getLayers:function(){return this._aLayerList},resetLayerEvent:function(){for(var i=0,len=this._aLayerList.length;len>i;i++)this._aLayerList[i].detachEvent();for(var i=this._aLayerList.length-1;i>=0;i--)this._aLayerList[i].attachEvent()},getElement:function(){return this._elContainer},getDuration:function(){return this._nDuration},getInfo:function(){return this._htCallback.frame=this._nCurrentFrame,this._htCallback.skippedFrame=this._nSkippedFrame,this._htCallback.fps=this._nFPS,this._htCallback.duration=this._nDuration,this._htCallback.renderingTime=this._nBeforeRenderingTime,this._htCallback.beforeFrameTime=this._nBeforeFrameTime,this._htCallback},getRenderingMode:function(){if(null===this._sRenderingMode){var htDeviceInfo=collie.util.getDeviceInfo();this._sRenderingMode=this.DEBUG_RENDERING_MODE,this._sRenderingMode&&"auto"!==this._sRenderingMode||(this._sRenderingMode=htDeviceInfo.android&&!htDeviceInfo.chrome&&(htDeviceInfo.android<4.2&&htDeviceInfo.android>=3||htDeviceInfo.android<2.2)||!htDeviceInfo.supportCanvas||htDeviceInfo.ios&&htDeviceInfo.ios<5?"dom":"canvas"),htDeviceInfo.supportCanvas||(this._sRenderingMode="dom")}return this._sRenderingMode},setRenderingMode:function(sMode){this.DEBUG_RENDERING_MODE=sMode.toString().toLowerCase(),this._sRenderingMode=null},isRetinaDisplay:function(){if(null===this._bUseRetinaDisplay){this._bUseRetinaDisplay="auto"!==this.RETINA_DISPLAY?this.RETINA_DISPLAY:window.devicePixelRatio>=2&&(!collie.util.getDeviceInfo().android||collie.util.getDeviceInfo().android>=4);var htDeviceInfo=collie.util.getDeviceInfo();htDeviceInfo.ie&&htDeviceInfo.ie<9&&(this._bUseRetinaDisplay=!1)}return this._bUseRetinaDisplay},setRetinaDisplay:function(vMode){this.RETINA_DISPLAY=vMode,this._bUseRetinaDisplay=null},_getNameAnimationFrame:function(bCancelName){return"undefined"!=typeof window.requestAnimationFrame?bCancelName?"cancelAnimationFrame":"requestAnimationFrame":"undefined"!=typeof window.webkitRequestAnimationFrame?bCancelName?"webkitCancelAnimationFrame":"webkitRequestAnimationFrame":"undefined"!=typeof window.msRequestAnimationFrame?bCancelName?"msCancelAnimationFrame":"msRequestAnimationFrame":"undefined"!=typeof window.mozRequestAnimationFrame?bCancelName?"mozCancelAnimationFrame":"mozRequestAnimationFrame":"undefined"!=typeof window.oRequestAnimationFrame?bCancelName?"oCancelAnimationFrame":"oRequestAnimationFrame":!1},_getNamePageVisibility:function(){return"hidden"in document?"visibilitychange":"webkitHidden"in document?"webkitvisibilitychange":"mozHidden"in document?"mozvisibilitychange":!1},load:function(elParent){if(this.unload(),this._bLoaded=!0,"string"==typeof elParent&&(elParent=document.getElementById(elParent)),this._elParent=elParent,this._elParent.appendChild(this._elContainer),this.refresh(),this._aLayerList.length){for(var i=0,len=this._aLayerList.length;len>i;i++)this._aLayerList[i].load(this._elContainer,i);for(var i=this._aLayerList.length-1;i>=0;i--)this._aLayerList[i].attachEvent()}this._sVisibilityChange?collie.util.addEventListener(document,this._sVisibilityChange,this._fOnChangeVisibility):this._htDeviceInfo.desktop||(collie.util.addEventListener(window,"pageshow",this._fOnPageShow),collie.util.addEventListener(window,"pagehide",this._fOnPageHide)),collie.util.addEventListener(window,"resize",this._fRefresh)},unload:function(){if(this._bLoaded){for(var i=0,len=this._aLayerList.length;len>i;i++)this._aLayerList[i].unload();this._elParent.removeChild(this._elContainer),this._elParent=null,this._bLoaded=!1,this._sVisibilityChange?collie.util.removeEventListener(document,this._sVisibilityChange,this._fOnChangeVisibility):this._htDeviceInfo.desktop||(collie.util.removeEventListener(window,"pageshow",this._fOnPageShow),collie.util.removeEventListener(window,"pagehide",this._fOnPageHide)),collie.util.removeEventListener(window,"resize",this._fRefresh)}},start:function(vDuration,fCallback){this._bPlaying||(vDuration=vDuration||this.DEFAULT_FPS,this._nDuration=/fps$/i.test(vDuration)?1e3/parseInt(vDuration,10):Math.max(16,vDuration),this._fCallback=fCallback||null,this._bPlaying=!0,this._nDuration<17?(this._sRequestAnimationFrameName=this._getNameAnimationFrame(),this._sCancelAnimationFrameName=this._getNameAnimationFrame(!0)):(this._sRequestAnimationFrameName=!1,this._sCancelAnimationFrameName=!1),this.fireEvent("start"),this._trigger(0))},_trigger:function(nDelay){!this._sVisibilityChange&&this.USE_AUTO_PAUSE&&window.screenTop<-3e4&&this.pause(),nDelay="undefined"==typeof nDelay?0:parseInt(nDelay,10),this._oRenderingTimer=this._sRequestAnimationFrameName!==!1&&!this.DEBUG_USE_DELAY&&this.USE_AUTO_PAUSE?window[this._sRequestAnimationFrameName](this._fRender):setTimeout(this._fRender,nDelay)},_render:function(nSkippedFrame,bForcePlay){if(this._bPlaying||bForcePlay){var nTime=this._getDate(),nRealDuration=0,nFrameStep=1;if(null!==this._nBeforeFrameTime){if(nRealDuration=nTime-this._nBeforeFrameTime,nFrameStep=nSkippedFrame||Math.max(1,Math.round(nRealDuration/this._nDuration)),nRealDuration>this.DELAY_LIMIT)return void this.pause();this._sRequestAnimationFrameName!==!1&&this.USE_AUTO_PAUSE&&(nSkippedFrame=0,nFrameStep=1),this._nSkippedFrame+=Math.max(0,nFrameStep-1),this._nFPS=Math.round(1e3/(nTime-this._nBeforeFrameTime))}this._nCurrentFrame+=nFrameStep;var htInfo=this.getInfo();if(null!==this._fCallback&&this._fCallback(htInfo)===!1||this.fireEvent("process",htInfo)===!1)this.stop();else{collie.Timer.run(this._nCurrentFrame,nRealDuration),this._update(nRealDuration);var nDebugDelayedTime=0;this.DEBUG_USE_DELAY&&(nDebugDelayedTime=Math.round(Math.random()*this.DEBUG_MAX_DELAY),this._nDebugDelayedTime+=nDebugDelayedTime),this._nBeforeRenderingTime=this._getDate()-nTime,this._nBeforeFrameTime=nTime,this._bPlaying&&this._trigger(Math.max(0,this._nDuration-this._nBeforeRenderingTime+2*nDebugDelayedTime))}}},draw:function(nSkippedFrame){this._fRender(nSkippedFrame,!0)},_getDate:function(){return+new Date+(this.DEBUG_USE_DELAY?this._nDebugDelayedTime:0)},stop:function(){this._bPlaying&&(this._bPlaying=!1,this._resetTimer(),this.fireEvent("stop",this.getInfo()),this._sRenderingMode=null,this._bUseRetinaDisplay=null,this._fCallback=null,this._nCurrentFrame=0,this._nBeforeRenderingTime=0,this._nSkippedFrame=0,this._nBeforeFrameTime=null)},_resetTimer:function(){null!==this._oRenderingTimer&&(this._sCancelAnimationFrameName!==!1?window[this._sCancelAnimationFrameName](this._oRenderingTimer):clearTimeout(this._oRenderingTimer),window.tempTimer=window.tempTimer||[],window.tempTimer.push(this._oRenderingTimer),this._oRenderingTimer=null)},pause:function(){this._bPlaying&&(this._bPlaying=!1,this._bPause=!0,this.fireEvent("pause",this.getInfo()),this._resetTimer())},resume:function(){this._bPause&&(this._nBeforeFrameTime=this._getDate(),this._nBeforeRenderingTime=0,this._bPlaying=!0,this._bPause=!1,this.fireEvent("resume",this.getInfo()),this._trigger(0))},isPlaying:function(){return this._bPlaying},_update:function(nFrameDuration){for(var i=0,len=this._aLayerList.length;len>i;i++)this._aLayerList[i].update(nFrameDuration)},_setEventStatusCount:0,setEventStatus:function(sEventType,bFiredOnTarget){this._htEventStatus.type==sEventType&&this._htEventStatus.firedOnTarget==bFiredOnTarget?this._setEventStatusCount+=1:(this._setEventStatusCount=1,this._htEventStatus={type:sEventType,firedOnTarget:bFiredOnTarget})},isStopEvent:function(sEventType){"click"===sEventType&&(sEventType="mouseup");var isEq=sEventType===this._htEventStatus.type&&this._htEventStatus.firedOnTarget;return this._setEventStatusCount<=1?(this._setEventStatusCount=0,isEq):(this._setEventStatusCount--,!1)},getEventStatus:function(){return this._htEventStatus},setPreventDefault:function(bPreventDefault){this._bIsPreventDefault=!!bPreventDefault},isPreventDefault:function(){return this._bIsPreventDefault},resize:function(nWidth,nHeight,bExpand){for(var i=0,len=this._aLayerList.length;len>i;i++)this._aLayerList[i].resize(nWidth,nHeight,bExpand)}},collie.Component));