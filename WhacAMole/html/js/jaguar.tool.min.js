collie.FPSConsole=collie.Class({$init:function(a){this.option({color:"gray",left:10,top:10,useConsole:!1,useDrawingCount:!1,visible:!0,limit:0,start:0,interval:60}),"undefined"!=typeof a&&this.option(a),this._elContainer=null,this._elParent=null,this._aList=[],this._bLoaded=!1,this._bStart=!1,this._nWidth=100,this._nHeight=13,this._nPadding=2,this._nLastUpdatedFrame=0,this._htData={},this._htInfo={},this._htFPS={average:0,min:null,max:null,total:0,count:0},this._htEvent={process:this._onProcess.bind(this),stop:this._onProcess.bind(this)},this.optionSetter("visible",function(a){this._elContainer.style.display=a?"block":"none"}.bind(this)),this._initElement()},_initElement:function(){this._elContainer=document.createElement("ul"),this._elContainer.id="__collie_fpsconsole",this._elContainer.style.position="absolute",this._elContainer.style.top=this.option("top")+"px",this._elContainer.style.left=this.option("left")+"px",this._elContainer.style.margin="0",this._elContainer.style.padding="0",this._elContainer.style.width=this._nWidth+"px",this._elContainer.style.height=this._nHeight+"px",this._elContainer.style.font="bold 0.75em Helvetica",this._elContainer.style.color=this.option("color"),this._elContainer.style.zIndex=9999,this._elContainer.style.display=this.option("console")?"none":"block",this.add("fps",0,"FPS"),this.add("mode","")},load:function(a){return"string"==typeof a&&(a=document.getElementById(a)),"undefined"!=typeof a&&(this._elParent=a,this._elParent.appendChild(this._elContainer)),collie.Renderer.attach(this._htEvent),this._bLoaded=!0,this},unload:function(){return this._bLoaded&&(null!==this._elParent&&(this._elParent.removeChild(this._elContainer),this._elParent=null),collie.Renderer.detach(this._htEvent),this._bLoaded=!1,this._bStart=!1),this},getElement:function(){return this._elContainer},add:function(a,b,c){if(a in this._htOption)throw new Error("Exists data name in FPSConsole");var d=document.createElement("li");d.style.listStyleType="none",d.style.height=this._nHeight+"px",d.style.paddingTop=this._nPadding+"px",d.innerHTML="undefined"!=typeof c?"<b>"+c+":</b> ":"";var e=document.createElement("span");e.style.fontWeight="bold",e.innerHTML=b,d.appendChild(e),this._elContainer.appendChild(d);var f=this._aList.push({name:a,value:b,element:e});return this._elContainer.style.height=f*this._nHeight+"px",this._htData[a]=f-1,this},change:function(a,b){if("undefined"!=typeof this._htData[a]){var c=this._aList[this._htData[a]];c.value=b,c.element.innerHTML=b}},_onProcess:function(a){this._htOption.start>a.frame||(this._bStart||(null===this._elParent&&(this._elParent=collie.Renderer.getElement(),this._elParent.appendChild(this._elContainer)),this.change("mode",this._setMode()),this._bStart=!0),this._setValue(a,"stop"===a.type),this._htOption.limit&&a.frame>this._htOption.limit&&collie.Renderer.stop())},_setMode:function(){var a=collie.Renderer.getRenderingMode()+(collie.Renderer.isRetinaDisplay()?"(retina)":"");return a=a.toUpperCase()},_setFPS:function(){return this._htInfo.fps},_setValue:function(a,b){return this._htInfo.frame=a.frame,this._htInfo.skippedFrame=a.skippedFrame,this._htInfo.fps=a.fps,this._htInfo.renderingTime=a.renderingTime,this._htFPS.total+=a.fps,this._htFPS.count++,this._htInfo.fpsAverage=Math.round(this._htFPS.total/this._htFPS.count*100)/100,this._htInfo.fpsMin=this._htFPS.min=null!==this._htFPS.min?Math.min(this._htFPS.min,a.fps):a.fps,this._htInfo.fpsMax=this._htFPS.max=null!==this._htFPS.max?Math.max(this._htFPS.max,a.fps):a.fps,this._nLastUpdatedFrame>a.frame&&(this._nLastUpdatedFrame=0),(b||this._nLastUpdatedFrame+this._htOption.interval<=a.frame)&&this._update(),this},_getValue:function(a){return a?this._htInfo[a]:this._htInfo},_update:function(){if(this.change("fps",this._setFPS()),this.option("visible")){if(this._bLoaded&&(this._nLastUpdatedFrame=this._htInfo.frame,this._htOption.useDrawingCount))for(var a=0,b=collie.Renderer._aLayerList.length;b>a;a++)this._addDrawingCount(a),this.change("layer"+a,collie.Renderer._aLayerList[a].drawCount)}else if(this.option("useConsole"))for(var a=0,b=this._aList.length;b>a;a++)console.log(this._aList[a].name+": "+this._aList[a].value)},_addDrawingCount:function(a){var b="layer"+a;this._htData[b]||this.add(b,0,"#"+a)}},collie.Component),function(){var a={},b=[],c=function(b){a[b]||(a[b]={name:b,startTime:null,totalTime:0,averageTime:0,count:0})},d=function(b){c(b),null===a[b].startTime&&(a[b].startTime=+new Date)},e=function(b){null!==a[b].startTime&&(a[b].totalTime+=+new Date-a[b].startTime,a[b].count++,a[b].averageTime=a[b].totalTime/a[b].count,a[b].startTime=null)},f=function(){for(var c in a)b.push(a[c]);b.sort(function(a,b){return b.totalTime-a.totalTime})};collie.Profiling={setConsole:function(a){this._oConsole=a,this._oConsole.option("useConsole",!1),this._oConsole.option("visible",!1)},load:function(a){a&&collie.Renderer.attach("process",function(b){b.frame>a&&collie.Profiling.getResults()});for(var b in collie){if("object"==typeof collie[b])for(var c in collie[b])c.toString().match(/^\$super/)||"constructor"===c||"prototype"===c||"function"!=typeof collie[b][c]||!function(a,b){var c=a+"_"+b,f=collie[a][b];collie[a][b]=function(){d(c);var a=f.apply(this,arguments);return e(c),a}}(b,c);if("object"!=typeof collie[b])for(var c in collie[b].prototype)c.toString().match(/^\$super/)||"constructor"===c||"prototype"===c||"$init"===c||"function"!=typeof collie[b].prototype[c]||!function(a,b){var c=a+"_"+b,f=collie[a].prototype[b];collie[a].prototype[b]=function(){d(c);var a=f.apply(this,arguments);return e(c),a}}(b,c)}},getResults:function(){collie.Renderer.stop(),f(),this._showPage()},_showPage:function(){var a=navigator.userAgent,c=window.devicePixelRatio,d={width:document.body.clientWidth,height:document.body.clientHeight},e=document.createElement("div");e.style.cssText="position:absolute;top:0;left:0;width:"+d.width+"px;height:100%;background-color:#fff;padding:10px;line-height:1.5;font:1em Helvetica;";var f=document.createElement("div");if(f.style.cssText="margin-bottom:15px;border-bottom:1px solid #aaa;padding-bottom:15px;",f.innerHTML='<h1 style="margin-bottom:10px;">Collie Profiling</h1><div style="font-size:0.75em;color:gray;">ratio : '+c+", agent : "+a+"</div>",e.appendChild(f),this._oConsole){this._oConsole.getElement().style.display="none";var g=document.createElement("ul");g.style.marginBottom="15px";var h=this._oConsole._getValue();for(var i in h)g.innerHTML+='<li style="list-style-type:none;padding:3px;margin-bottom:3px;font-size:0.8em;"><strong>'+i+'</strong> <span style="color:gray;">'+this._oConsole._getValue(i)+"</span></li>";e.appendChild(g)}for(var j=document.createElement("ul"),k=0,l=Math.min(b.length,100);l>k;k++){var m=b[k].name.replace(/_/,"."),n=Math.round(100*b[k].averageTime)/100+"ms / "+b[k].totalTime+"ms ("+b[k].count+")";j.innerHTML+='<li style="list-style-type:none;padding:3px;margin-bottom:3px;border-bottom:1px solid #aaa;font-size:0.75em;"><strong>'+m+'</strong> <span style="color:gray;">'+n+"</span></li>"}e.appendChild(j),document.body.appendChild(e)}}}();