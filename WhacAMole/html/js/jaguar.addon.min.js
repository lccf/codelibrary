!function(){if("undefined"!=typeof Box2D){{var a=Box2D.Common.Math.b2Vec2,b=(Box2D.Collision.b2AABB,Box2D.Dynamics.b2BodyDef),c=Box2D.Dynamics.b2Body,d=Box2D.Dynamics.b2FixtureDef,e=(Box2D.Dynamics.b2Fixture,Box2D.Dynamics.b2World),f=(Box2D.Collision.Shapes.b2MassData,Box2D.Collision.Shapes.b2PolygonShape),g=Box2D.Collision.Shapes.b2CircleShape,h=Box2D.Dynamics.b2DebugDraw,i=Box2D.Dynamics.Joints.b2RevoluteJointDef;Box2D.Dynamics.Joints.b2MouseJointDef}collie.Box2d=collie.Class({ITERATIONS_VELOCITY:6,ITERATIONS_POSITION:3,WIDTH_OF_WALL:10,$init:function(a,b,c){this._oDebugLayer=null,this._oDebugDraw=null,this._bIsLoaded=!1,this._bIsDebug=!1,this._nStep=60,this._nWidth=0,this._nHeight=0,this._htFixtures={},this._htBodies={},c="undefined"!=typeof c?c:c||10,this._htWall={},this._oWorld=this.createWorld(c),this._fOnProcess=this._onProcess.bind(this),this.resize(a,b)},getBody:function(a){var b=a.getId();return this._htBodies[b]||!1},getDisplayObjectByBody:function(a){for(var b in this._htBodies)if(this._htBodies[b]===a)return collie.util.getDisplayObjectById(b)},addFixture:function(a,b,c){c&&(b.shape=c);var d=this.createFixture(b);this._htFixtures[a]=d},removeFixture:function(a){delete this._htFixtures[a]},getFixture:function(a){if(this._htFixtures[a]){var b=new d;for(var c in this._htFixtures[a])b[c]=this._htFixtures[a][c];return b}return!1},createFixture:function(a){var b=new d;return b.density="undefined"!=typeof a.density?a.density:b.density,b.filter=a.filter||b.filter,b.friction="undefined"!=typeof a.friction?a.friction:b.friction,b.restitution="undefined"!=typeof a.restitution?a.restitution:b.restitution,b.isSensor=a.isSensor||b.isSensor,b.userData=a.userData||b.userData,b.shape=a.shape||b.shape,b},createBody:function(a){var d=new b;switch(d.active=a.active||d.active,d.allowSleep=a.allowSleep||d.allowSleep,d.angle=a.angle||d.angle,d.angularDamping=a.angularDamping||d.angularDamping,d.angularVelocity=a.angularVelocity||d.angularVelocity,d.awake=a.awake||d.awake,d.bullet=a.bullet||d.bullet,d.fixedRotation=a.fixedRotation||d.fixedRotation,d.inertiaScale=a.inertiaScale||d.inertiaScale,d.linearDamping=a.linearDamping||d.linearDamping,d.linearVelocity=a.linearVelocity||d.linearVelocity,d.position.x=a.x/collie.Box2d.SCALE||0,d.position.y=a.y/collie.Box2d.SCALE||0,a.type){case"static":d.type=c.b2_staticBody;break;case"kinematic":d.type=c.b2_kinematicBody;break;case"dynamic":default:d.type=c.b2_dynamicBody}return d.userData=a.userData||d.userData,d},createObject:function(a,b,c){var d=a.get(),e=a.getId();b.x=d.x+d.width/2,b.y=d.y+d.height/2;var f=this.createBody(b),g="string"==typeof c?this.getFixture(c):c;"groupIndex"in b&&(g.filter.groupIndex=b.groupIndex),g.shape||(g.shape=this._createShape(a,b));var h=this._oWorld.CreateBody(f);return this._htBodies[e]=h,h.CreateFixture(g),h._displayObjectId=e,h},createStaticObject:function(a,b){var c;a.type="static",a.x+=a.width/2,a.y+=a.height/2,c=b?"string"==typeof b?this.getFixture(b):b:new d,c.shape||(c.shape=this._createShape(null,a));var e=this.createBody(a),f=this._oWorld.CreateBody(e);return f.CreateFixture(c),f},createWall:function(a,b){var c;switch(a){case"left":c=this.createStaticObject({x:-this.WIDTH_OF_WALL,y:-this.WIDTH_OF_WALL,width:this.WIDTH_OF_WALL,height:this._nHeight+2*this.WIDTH_OF_WALL},b);break;case"right":c=this.createStaticObject({x:this._nWidth,y:-this.WIDTH_OF_WALL,width:this.WIDTH_OF_WALL,height:this._nHeight+2*this.WIDTH_OF_WALL},b);break;case"top":c=this.createStaticObject({x:-this.WIDTH_OF_WALL,y:-this.WIDTH_OF_WALL,width:this._nWidth+2*this.WIDTH_OF_WALL,height:this.WIDTH_OF_WALL},b);break;case"bottom":c=this.createStaticObject({x:-this.WIDTH_OF_WALL,y:this._nHeight,width:this._nWidth+2*this.WIDTH_OF_WALL,height:this.WIDTH_OF_WALL},b);break;default:throw new Error("not invalid direction")}return this._htWall[a]=c,c},removeObject:function(a,b){var c=a._displayObjectId;c&&(b&&collie.util.getDisplayObjectById(c).leave(),delete this._htBodies[c]),this._oWorld.DestroyBody(a)},_createShape:function(a,b){var c;return"width"in b&&"height"in b?c=this._createShapeBox(b.width/collie.Box2d.SCALE,b.height/collie.Box2d.SCALE):"radius"in b?c=this._createShapeCircle(b.radius/collie.Box2d.SCALE):a&&(c=a instanceof collie.Circle?this._createShapeCircle(a._htOption.radius/collie.Box2d.SCALE):this._createShapeBox(a._htOption.width/collie.Box2d.SCALE,a._htOption.height/collie.Box2d.SCALE)),c},_createShapeBox:function(a,b){var c=new f;return c.SetAsBox(a/2,b/2),c},_createShapeCircle:function(a){return new g(a)},createContact:function(a,b,c,d){var e=new Box2D.Dynamics.b2ContactListener;"undefined"!=typeof a&&(e.BeginContact=a),"undefined"!=typeof b&&(e.EndContact=b),"undefined"!=typeof c&&(e.PostSolve=c),"undefined"!=typeof d&&(e.PreSolve=d),this._oWorld.SetContactListener(e)},createRevoluteJoint:function(a,b,c,d){var e=new i;return d=d||{},e.Initialize(a,b,c),e.enableLimit="undefined"!=typeof d.enableLimit?d.enableLimit:e.enableLimit,e.enableMotor="undefined"!=typeof d.enableMotor?d.enableMotor:e.enableMotor,e.localAnchorA="undefined"!=typeof d.localAnchorA?d.localAnchorA:e.localAnchorA,e.localAnchorB="undefined"!=typeof d.localAnchorB?d.localAnchorB:e.localAnchorB,e.lowerAngle="undefined"!=typeof d.lowerAngle?d.lowerAngle:e.lowerAngle,e.maxMotorTorque="undefined"!=typeof d.maxMotorTorque?d.maxMotorTorque:e.maxMotorTorque,e.motorSpeed="undefined"!=typeof d.motorSpeed?d.motorSpeed:e.motorSpeed,e.referenceAngle="undefined"!=typeof d.referenceAngle?d.referenceAngle:e.referenceAngle,e.upperAngle="undefined"!=typeof d.upperAngle?d.upperAngle:e.upperAngle,this._oWorld.CreateJoint(e)},createDistanceJoint:function(a,b,c,d,e){var f=new Box2D.Dynamics.Joints.b2DistanceJointDef;return e=e||{},f.Initialize(a,b,c,d),f.dampingRatio="undefined"!=typeof e.dampingRatio?e.dampingRatio:f.dampingRatio,f.frequencyHz="undefined"!=typeof e.frequencyHz?e.frequencyHz:f.frequencyHz,f.length="undefined"!=typeof e.length?e.length:f.length,f.localAnchorA="undefined"!=typeof e.localAnchorA?e.localAnchorA:f.localAnchorA,f.localAnchorB="undefined"!=typeof e.localAnchorB?e.localAnchorB:f.localAnchorB,this._oWorld.CreateJoint(f)},createFrictionJoint:function(a,b,c,d){var e=new Box2D.Dynamics.Joints.b2FrictionJointDef;return d=d||{},e.Initialize(a,b,c),e.localAnchorA="undefined"!=typeof d.localAnchorA?d.localAnchorA:e.localAnchorA,e.localAnchorB="undefined"!=typeof d.localAnchorB?d.localAnchorB:e.localAnchorB,e.maxForce="undefined"!=typeof d.maxForce?d.maxForce:e.maxForce,e.maxTorque="undefined"!=typeof d.maxTorque?d.maxTorque:e.maxTorque,this._oWorld.CreateJoint(e)},createGearJoint:function(a,b,c){var d=new Box2D.Dynamics.Joints.b2GearJointDef;return d.joint1=b,d.joint2=b,d.ratio=c,this._oWorld.CreateJoint(d)},createLineJoint:function(a,b,c,d,e){var f=new Box2D.Dynamics.Joints.b2LineJointDef;return e=e||{},f.Initialize(a,b,c,d),f.enableLimit="undefined"!=typeof e.enableLimit?e.enableLimit:f.enableLimit,f.enableMotor="undefined"!=typeof e.enableMotor?e.enableMotor:f.enableMotor,f.localAnchorA="undefined"!=typeof e.localAnchorA?e.localAnchorA:f.localAnchorA,f.localAnchorB="undefined"!=typeof e.localAnchorB?e.localAnchorB:f.localAnchorB,f.localAxisA="undefined"!=typeof e.localAxisA?e.localAxisA:f.localAxisA,f.lowerTranslation="undefined"!=typeof e.lowerTranslation?e.lowerTranslation:f.lowerTranslation,f.maxMotorForce="undefined"!=typeof e.maxMotorForce?e.maxMotorForce:f.maxMotorForce,f.motorSpeed="undefined"!=typeof e.motorSpeed?e.motorSpeed:f.motorSpeed,f.upperTranslation="undefined"!=typeof e.upperTranslation?e.upperTranslation:f.upperTranslation,this._oWorld.CreateJoint(f)},createMouseJoint:function(a,b,c){var d=new Box2D.Dynamics.Joints.b2MouseJointDef;return c=c||{},d.bodyA=this._oWorld.GetGroundBody(),d.bodyB=a,d.target=b,d.dampingRatio="undefined"!=typeof c.dampingRatio?c.dampingRatio:d.dampingRatio,d.frequencyHz="undefined"!=typeof c.frequencyHz?c.frequencyHz:d.frequencyHz,d.maxForce="undefined"!=typeof c.maxForce?c.maxForce:d.maxForce,this._oWorld.CreateJoint(d)},createPrismaticJoint:function(a,b,c,d,e){var f=new Box2D.Dynamics.Joints.b2PrismaticJointDef;return e=e||{},f.Initialize(a,b,c,d),f.enableLimit="undefined"!=typeof e.enableLimit?e.enableLimit:f.enableLimit,f.enableMotor="undefined"!=typeof e.enableMotor?e.enableMotor:f.enableMotor,f.localAnchorA="undefined"!=typeof e.localAnchorA?e.localAnchorA:f.localAnchorA,f.localAnchorB="undefined"!=typeof e.localAnchorB?e.localAnchorB:f.localAnchorB,f.localAxisA="undefined"!=typeof e.localAxisA?e.localAxisA:f.localAxisA,f.lowerTranslation="undefined"!=typeof e.lowerTranslation?e.lowerTranslation:f.lowerTranslation,f.maxMotorForce="undefined"!=typeof e.maxMotorForce?e.maxMotorForce:f.maxMotorForce,f.motorSpeed="undefined"!=typeof e.motorSpeed?e.motorSpeed:f.motorSpeed,f.referenceAngle="undefined"!=typeof e.referenceAngle?e.referenceAngle:f.referenceAngle,f.upperTranslation="undefined"!=typeof e.upperTranslation?e.upperTranslation:f.upperTranslation,this._oWorld.CreateJoint(f)},createPulleyJoint:function(a,b,c,d,e,f,g,h){var i=new Box2D.Dynamics.Joints.b2PulleyJointDef;return h=h||{},i.Initialize(a,b,c,d,e,f,g),i.lengthA="undefined"!=typeof h.lengthA?h.lengthA:i.lengthA,i.lengthB="undefined"!=typeof h.lengthB?h.lengthB:i.lengthB,i.localAnchorA="undefined"!=typeof h.localAnchorA?h.localAnchorA:i.localAnchorA,i.localAnchorB="undefined"!=typeof h.localAnchorB?h.localAnchorB:i.localAnchorB,i.maxLengthA="undefined"!=typeof h.maxLengthA?h.maxLengthA:i.maxLengthA,i.maxLengthB="undefined"!=typeof h.maxLengthB?h.maxLengthB:i.maxLengthB,this._oWorld.CreateJoint(i)},createWeldJoint:function(a,b,c,d){var e=new Box2D.Dynamics.Joints.b2WeldJointDef;return d=d||{},e.Initialize(a,b,c),e.localAnchorA="undefined"!=typeof d.localAnchorA?d.localAnchorA:e.localAnchorA,e.localAnchorB="undefined"!=typeof d.localAnchorB?d.localAnchorB:e.localAnchorB,e.referenceAngle="undefined"!=typeof d.referenceAngle?d.referenceAngle:e.referenceAngle,this._oWorld.CreateJoint(e)},removeJoint:function(a){this._oWorld.DestroyJoint(a)},createWorld:function(b){return new e(new a(0,b),!0)},getWorld:function(){return this._oWorld},load:function(a){this._bIsLoaded||(this._bIsLoaded=!0,this._nStep=Math.round(1e3/collie.Renderer.getDuration()),a&&this._setDebug(this._nWidth,this._nHeight),collie.Renderer.attach("process",this._fOnProcess))},unload:function(){this._bIsLoaded&&(this._bIsLoaded=!1,collie.Renderer.detach("process",this._fOnProcess),this._unsetDebug())},resize:function(a,b){var c,d,e,f;if(this._nWidth=a,this._nHeight=b,this._htWall)for(var g in this._htWall){switch(g){case"left":c=-this.WIDTH_OF_WALL+this.WIDTH_OF_WALL/2,d=-this.WIDTH_OF_WALL+(this._nHeight+2*this.WIDTH_OF_WALL)/2,e=this.WIDTH_OF_WALL,f=this._nHeight+2*this.WIDTH_OF_WALL;break;case"right":c=this._nWidth+this.WIDTH_OF_WALL/2,d=-this.WIDTH_OF_WALL+(this._nHeight+2*this.WIDTH_OF_WALL)/2,e=this.WIDTH_OF_WALL,f=this._nHeight+2*this.WIDTH_OF_WALL;break;case"top":c=-this.WIDTH_OF_WALL+(this._nWidth+2*this.WIDTH_OF_WALL)/2,d=-this.WIDTH_OF_WALL+this.WIDTH_OF_WALL/2,e=this._nWidth+2*this.WIDTH_OF_WALL,f=this.WIDTH_OF_WALL;break;case"bottom":c=-this.WIDTH_OF_WALL+(this._nWidth+2*this.WIDTH_OF_WALL)/2,d=this._nHeight+this.WIDTH_OF_WALL/2,e=this._nWidth+2*this.WIDTH_OF_WALL,f=this.WIDTH_OF_WALL}c/=collie.Box2d.SCALE,d/=collie.Box2d.SCALE,e/=collie.Box2d.SCALE,f/=collie.Box2d.SCALE,this._htWall[g].SetPosition(collie.Box2d.vec2(c,d)),this._htWall[g].GetFixtureList().GetShape().SetAsBox(e/2,f/2)}},_setDebug:function(a,b){this._bIsDebug||(null===this._oDebugLayer?this._oDebugLayer=new collie.Layer({width:a,height:b}):this._oDebugLayer.resize(a,b),collie.Renderer.addLayer(this._oDebugLayer),null===this._oDebugDraw&&(this._oDebugDraw=new h,this._oDebugDraw.SetSprite(this._oDebugLayer.getContext()),this._oDebugDraw.SetDrawScale(30),this._oDebugDraw.SetFillAlpha(.3),this._oDebugDraw.SetLineThickness(1),this._oDebugDraw.SetFlags(h.e_shapeBit|h.e_jointBit),this._oWorld.SetDebugDraw(this._oDebugDraw)),this._bIsDebug=!0)},_unsetDebug:function(){this._bIsDebug&&(collie.Renderer.removeLayer(this._oDebugLayer),this._bIsDebug=!1)},_onProcess:function(){var a=1/this._nStep;this._oWorld.Step(a,this.ITERATIONS_VELOCITY,this.ITERATIONS_POSITION),this._oWorld.ClearForces();var b=this._oWorld.GetBodyList();if(b)do b.IsActive()&&b._displayObjectId&&this._update(b),b=b.GetNext();while(b);this._bIsDebug&&this._oWorld.DrawDebugData()},_update:function(a){var b=collie.util.getDisplayObjectById(a._displayObjectId);if(b){var c=b.get(),d=a.GetPosition();b.set("angle",collie.util.toDeg(a.GetAngle())),b.set("x",(d.x-c.width/collie.Box2d.SCALE/2)*collie.Box2d.SCALE),b.set("y",(d.y-c.height/collie.Box2d.SCALE/2)*collie.Box2d.SCALE)}else this._oWorld.DestroyBody(a)}}),collie.Box2d.vec2=function(b,c,d){return d&&(b/=collie.Box2d.SCALE,c/=collie.Box2d.SCALE),new a(b,c)},collie.Box2d.hasUserData=function(a){var b=a.GetUserData();return"undefined"!=typeof b&&null!==b},collie.Box2d.SCALE=30,collie.Box2d.BODY_TYPE={STATIC:"static",KINEMATIC:"kinematic",DYNAMIC:"dynamic"}}}(),collie.ImageNumber=collie.Class({$init:function(){this._aNumber=[],this._aComma=[],this._nIndexNumber=null,this._nIndexComma=null,this._nValue=null,this.option({textAlign:"left",letterSpacing:0,minDigit:0},null,!0)},setValue:function(a){this._nValue=Math.max(0,parseInt(a,10)),this._nIndexNumber=null,this._nIndexComma=null;var b=this._nValue.toString(),c=b.length;this._htOption.minDigit&&c<this._htOption.minDigit&&(b=new Array(this._htOption.minDigit-c+1).join("0")+b,c=this._htOption.minDigit);for(var d=this._getWidth(b),e=this._getStartPosition(d),f=e+d,g=0,h=!1,i=c-1;i>=0;i--)this._htOptionComma&&g%3===0&&0!==g&&(f-=this._htOptionComma.width+this._htOption.letterSpacing,this._getComma().set({x:f,visible:!0})),h=0===g&&"right"===this._htOption.textAlign||g===c&&"left"===this._htOption.textAlign,f-=this._htOptionNumber.width+this._htOption.letterSpacing*(h?0:1),this._getNumber().set({x:f,spriteX:parseInt(b.charAt(i),10),visible:!0}),g++;this._hideUnusedObject()},getValue:function(){return this._nValue},number:function(a){return this._htOptionNumber=a,this},comma:function(a){if(a){if(!("width"in a))throw new Error("comma method in ImageNumber requires a width property in options.");this._htOptionComma=a}else this._htOptionComma=null;return null!==this._nValue&&this.setValue(this._nValue),this},_getWidth:function(a){var b=a.toString(),c=b.length*(this._htOptionNumber.width+this._htOption.letterSpacing);return this._htOptionComma&&(c+=Math.max(0,Math.ceil(b.length/3-1))*(this._htOptionComma.width+this._htOption.letterSpacing)),c},_getStartPosition:function(a){switch(this._htOption.textAlign){case"right":return this._htOption.width-a;case"center":return this._htOption.width/2-a/2;case"left":default:return 0}},_getNumber:function(){var a=null===this._nIndexNumber?0:this._nIndexNumber+1;return this._aNumber.length<a+1&&this._aNumber.push(new collie.DisplayObject(this._htOptionNumber).addTo(this)),this._nIndexNumber=a,this._aNumber[a]},_getComma:function(){var a=null===this._nIndexComma?0:this._nIndexComma+1;return this._aComma.length<a+1&&this._aComma.push(new collie.DisplayObject(this._htOptionComma).addTo(this)),this._nIndexComma=a,this._aComma[a]},_hideUnusedObject:function(){for(var a=null!==this._nIndexComma?this._nIndexComma+1:0,b=this._aComma.length;b>a;a++)this._aComma[a].set("visible",!1);if(null!==this._nIndexNumber)for(var a=this._nIndexNumber+1,b=this._aNumber.length;b>a;a++)this._aNumber[a].set("visible",!1)},toString:function(){return"ImageNumber"+(this.get("name")?" "+this.get("name"):"")+" #"+this.getId()+(this.getImage()?"(image:"+this.getImage().src+")":"")}},collie.DisplayObject),collie.Pool=collie.Class({$init:function(a,b,c){this._nSize=a||0,this._htDefaultOption=b,this._aPool=[],this._fClass=c||collie.DisplayObject,this._nLengthActiveObject=0,this._allocate()},_allocate:function(){var a=this._nLengthActiveObject+this._aPool.length;if(this._nSize&&a<this._nSize)for(var b=a;b<this._nSize;b++)this._aPool.push(new this._fClass(this._htDefaultOption))},changeSize:function(a){this._nSize=a,this._allocate()},getSize:function(){return this._nSize},changeOption:function(a){this._htDefaultOption=a},get:function(){if(!this._aPool.length)throw new Error("The Pool is empty");var a=this._aPool.pop();return this._nLengthActiveObject++,a},release:function(a){a.leave(),this._nLengthActiveObject--,this._aPool.push(a)}}),collie.Sensor=collie.Class({RAY_SENSING_DISTANCE:10,$init:function(a){this.option({frequency:3,cacheSize:80,useDebug:!1,debugListenerColor:"red",debugColor:"yellow",debugOpacity:.5}),"undefined"!=typeof a&&this.option(a),this._nCurrentFrame=null,this._nAccumulateFrame=0,this._aListeners=[],this._htListenerCollision={},this._htObject={},this._htCacheMap={},this._htCustomAreaCircle={},this._htCustomAreaBox={},this._fUpdate=this._onProcess.bind(this)},update:function(a){if((null===this._nCurrentFrame||this._nCurrentFrame>a)&&(this._nCurrentFrame=a),this._nAccumulateFrame+=a-this._nCurrentFrame,this._nCurrentFrame=a,this._nAccumulateFrame>=this._htOption.frequency){this._nAccumulateFrame=0,this._makeCacheMap(),this._htListenerCollisionBefore=this._htListenerCollision,this._htListenerCollision={};for(var b=0,c=this._aListeners.length;c>b;b++){var d=this._aListeners[b],e=this._getBoundary(d.displayObject);this._makeCustomArea(d.displayObject,e),this.detect(d.displayObject,d.category,e,d.beginCallback,d.endCallback)}}},_getBoundary:function(a){var b,c=null,d=null,e=null,f=null;null!==a._htBoundary&&(c=a._htBoundary.left,e=a._htBoundary.top,f=a._htBoundary.bottom,d=a._htBoundary.right,b=a._htBoundary.points);var g=a.getBoundary(!0,!0);return null!==c&&(Math.abs(c-g.left)>=this.RAY_SENSING_DISTANCE||Math.abs(e-g.top)>=this.RAY_SENSING_DISTANCE)?(b.push(g.points[0]),b.push(g.points[1]),b.push(g.points[2]),b.push(g.points[3]),g.expanded={left:Math.min(c,g.left),right:Math.max(d,g.right),top:Math.min(e,g.top),bottom:Math.max(f,g.bottom),points:b,isExpanded:!0}):(g.expanded=g,g.expanded.isExpanded=!1),g},_makeCustomArea:function(a,b){var c=a.getId();if((this._htCustomAreaBox[c]||this._htCustomAreaCircle[c])&&(b.isTransform=!0,b.centerX=b.points[0][0]+(b.points[2][0]-b.points[0][0])/2,b.centerY=b.points[0][1]+(b.points[2][1]-b.points[0][1])/2,this._htCustomAreaBox[c])){for(var d=Number.MAX_VALUE,e=Number.MAX_VALUE,f=-Number.MAX_VALUE,g=-Number.MAX_VALUE,h=0,i=b.points.length;i>h;h++){var j=b.points[h],k=Math.atan2(b.centerY-j[1],b.centerX-j[0]);j[0]+=this._htCustomAreaBox[c]*Math.cos(k),j[1]+=this._htCustomAreaBox[c]*Math.sin(k),d=Math.min(d,j[0]),f=Math.max(f,j[0]),e=Math.min(e,j[1]),g=Math.max(g,j[1])}b.left=d,b.right=f,b.top=e,b.bottom=g}},_makeCacheMap:function(){var a,b,c,d,e;for(var f in this._htObject){this._htCacheMap[f]={};for(var g=0,h=this._htObject[f].length;h>g;g++){a=this._htObject[f][g];var i=this._getBoundary(a);b=Math.floor(i.expanded.left/this._htOption.cacheSize),d=Math.floor(i.expanded.right/this._htOption.cacheSize),c=Math.floor(i.expanded.top/this._htOption.cacheSize),e=Math.floor(i.expanded.bottom/this._htOption.cacheSize),this._makeCustomArea(a,i);for(var j=c;e>=j;j++){this._htCacheMap[f][j]=this._htCacheMap[f][j]||{};for(var k=b;d>=k;k++)this._htCacheMap[f][j][k]=this._htCacheMap[f][j][k]||[],this._htCacheMap[f][j][k].push(a)}}}},detect:function(a,b,c,d,e){if(-1!==b.indexOf(","))for(var f=b.split(","),g=0,h=f.length;h>g;g++)this.detect(a,f[g],c,d,e);else{var i=Math.floor(c.expanded.left/this._htOption.cacheSize),j=Math.floor(c.expanded.right/this._htOption.cacheSize),k=Math.floor(c.expanded.top/this._htOption.cacheSize),l=Math.floor(c.expanded.bottom/this._htOption.cacheSize),m=a.getId();if(this._htCacheMap[b]){for(var n=k;l>=n;n++)for(var o=i;j>=o;o++)if(this._htCacheMap[b][n]&&this._htCacheMap[b][n][o])for(var g=0,h=this._htCacheMap[b][n][o].length;h>g;g++){var p=this._htCacheMap[b][n][o][g],q=p.getId();if(!this._htListenerCollision[m]||!this._htListenerCollision[m][q]){var r=this._hitTest(a,p,c,p._htBoundary),s=this._htListenerCollisionBefore[m]&&this._htListenerCollisionBefore[m][q];r&&(this._htListenerCollision[m]=this._htListenerCollision[m]||{},this._htListenerCollision[m][q]=!0,s||d(a,p))}}for(var q in this._htListenerCollisionBefore[m])this._htListenerCollision[m]&&this._htListenerCollision[m][q]||e(a,collie.util.getDisplayObjectById(q))}}},_hitTest:function(a,b,c,d){var e=a.getId(),f=b.getId();if(c.expanded.left>d.expanded.right||d.expanded.left>c.expanded.right||c.expanded.top>d.expanded.bottom||d.expanded.top>c.expanded.bottom)return!1;if(c.isTransform||d.isTransform||c.expanded.isExpanded||d.expanded.isExpanded){if(!c.expanded.isExpanded&&!d.expanded.isExpanded&&(this._htCustomAreaCircle[e]||this._htCustomAreaCircle[f])){if(this._htCustomAreaCircle[e]&&this._htCustomAreaCircle[f])return collie.util.getDistance(c.centerX,c.centerY,d.centerX,d.centerY)<=this._htCustomAreaCircle[e]+this._htCustomAreaCircle[f];var g,h,i;this._htCustomAreaCircle[f]?(g=c,h=d,i=this._htCustomAreaCircle[f]):(g=d,h=c,i=this._htCustomAreaCircle[e]);for(var j=0,k=g.points.length;k>j;j++){var l=c.points[j],m=c.points[j===k-1?0:j+1],n=Math.atan((h.centerY-l[1])/(h.centerX-l[0]));if(n-=Math.atan((m[1]-l[1])/(m[0]-l[0])),Math.sin(n)*collie.util.getDistance(h.centerX,h.centerY,l[0],l[1])<=i)return!0}return!1}if(c.expanded.left<=d.expanded.left&&c.expanded.top<=d.expanded.top&&c.expanded.right>=d.expanded.right&&c.expanded.bottom>=d.expanded.bottom||c.expanded.left>d.expanded.left&&c.expanded.top>d.expanded.top&&c.expanded.right<d.expanded.right&&c.expanded.bottom<d.expanded.bottom)return!0;for(var j=0,k=c.expanded.points.length;k>j;j++)for(var l=c.expanded.points[j],m=c.expanded.points[j===k-1?0:j+1],o=0,p=d.expanded.points.length;p>o;o++){var q=d.expanded.points[o],r=d.expanded.points[o===p-1?0:o+1];if(this._isIntersectLine(l,m,q,r))return!0}return!1}return!0},_isIntersectLine:function(a,b,c,d){var e=(d[1]-c[1])*(b[0]-a[0])-(d[0]-c[0])*(b[1]-a[1]);if(0===e)return!1;var f=(d[0]-c[0])*(a[1]-c[1])-(d[1]-c[1])*(a[0]-c[0]),g=(b[0]-a[0])*(a[1]-c[1])-(b[1]-a[1])*(a[0]-c[0]),h=f/e,i=g/e;return 0>h||h>1||0>i||i>1||0===f&&0===g?!1:!0},addListener:function(a,b,c,d,e,f){this._aListeners.push({category:b,displayObject:a,beginCallback:c,endCallback:d}),this._addCustomArea(a,e,f),this._htOption.useDebug&&this._drawArea(a,!0,e,f)},add:function(a,b,c,d){if(-1!==b.indexOf(","))for(var e=b.split(","),f=0,g=e.length;g>f;f++)this.add(a,e[f],c,d);else this._htObject[b]=this._htObject[b]||[],this._htObject[b].push(a),this._addCustomArea(a,c,d),this._htOption.useDebug&&this._drawArea(a,!1,c,d)},remove:function(a,b){if(b){if(-1!==b.indexOf(","))for(var c=b.split(","),d=0,e=c.length;e>d;d++)this.remove(a,c[d]);else if(this._htObject[b])for(var d=0,e=this._htObject[b].length;e>d;d++)if(this._htObject[b][d]===a){this._htCustomAreaCircle[a.getId()]&&delete this._htCustomAreaCircle[a],this._htCustomAreaBox[a.getId()]&&delete this._htCustomAreaBox[a],this._htObject[b].splice(d,1);break}}else for(var d in this._htObject)this.remove(a,d)},_addCustomArea:function(a,b,c){"undefined"!=typeof c?this._htCustomAreaBox[a.getId()]=Math.sqrt(Math.pow(b,2)+Math.pow(c,2)):"undefined"!=typeof b&&(this._htCustomAreaCircle[a.getId()]=b)},start:function(){collie.Renderer.attach("process",this._fUpdate)},stop:function(){collie.Renderer.detach("process",this._fUpdate),this._nCurrentFrame=null,this._nAccumulateFrame=0},_onProcess:function(a){this.update(a.frame)},_drawArea:function(a,b,c,d){var e=b?this._htOption.debugListenerColor:this._htOption.debugColor,f=a.getId();if(this._htCustomAreaCircle[f]){var g=new collie.Circle({radius:this._htCustomAreaCircle[f],fillColor:e,opacity:this._htOption.debugOpacity}).addTo(a);g.center(a._htOption.width/2,a._htOption.height/2)}else this._htCustomAreaBox[f]?new collie.DisplayObject({x:c,y:d,width:a._htOption.width-2*c,height:a._htOption.height-2*d,backgroundColor:e,opacity:this._htOption.debugOpacity}).addTo(a):new collie.DisplayObject({width:a._htOption.width,height:a._htOption.height,backgroundColor:e,opacity:this._htOption.debugOpacity}).addTo(a)}},collie.Component),collie.Map=collie.Class({$init:function(a,b,c){this._oLayer=null,this._oObjectLayer=null,this._fOnMousemove=this._onMousemove.bind(this),this._fOnMouseup=this._onMouseup.bind(this),this._fOnMousedown=this._onMousedown.bind(this),this._fOnClick=this._onClick.bind(this),this._fOnResize=this._onResize.bind(this),this._nTileWidth=a,this._nTileHeight=b,this._nStartMouseX=null,this._nStartMouseY=null,this._nStartContainerX=null,this._nStartContainerY=null,this._bIsMousedown=!1,this._bLockScreen=!1,this._nRowLength=0,this._nColLength=0,this._aMapData=[],this._aTiles=[],this._htTile={},this._htObject={},this._htEventInfo={},this._sRenderingMode=null,this._oPool=new collie.Pool,this._oContainer=new collie.DisplayObject,this._htContainerInfo=this._oContainer.get(),this._oObjectContainer=new collie.DisplayObject,this._htLayerOption=null,this.option({cacheTileSize:1,useCache:!1,updateInterval:150,useLiveUpdate:!1,useEvent:!0,useLimitMoving:!0}),this._oTimerUpdate=collie.Timer.repeat(this._prepareTile.bind(this),this._htOption.updateInterval,{useAutoStart:!1}),this.optionSetter("useEvent",this._setterUseEvent.bind(this)),this.optionSetter("updateInterval",function(a){this._oTimerUpdate.setDuration(a)}.bind(this)),"undefined"!=typeof c&&this.option(c),this._setterUseEvent(this._htOption.useEvent)},addTo:function(a){return this.setLayer(a),this},addObjectTo:function(a){return this.setObjectLayer(a),this},setLayer:function(a){null!==this._oLayer&&this.unsetLayer(),this._oLayer=a,this._htLayerOption=this._oLayer._htOption,this._sRenderingMode=this._oLayer.getRenderingMode(),this._oLayer.attach("resize",this._fOnResize),this._htOption.useEvent&&(this._oLayer.attach("mousemove",this._fOnMousemove),this._oLayer.attach("mouseup",this._fOnMouseup),this._oLayer.attach("mousedown",this._fOnMousedown),this._oLayer.attach("click",this._fOnClick)),this._oContainer.addTo(a),this._prepareStage()},_prepareStage:function(){var a=this._htLayerOption.width,b=this._htLayerOption.height,c=!1,d=0;if(this._htOption.useCache&&"canvas"===this._sRenderingMode)a=this._nTileWidth*this._nColLength,b=this._nTileHeight*this._nRowLength,c=!0,d=this._nColLength*this._nRowLength;else{var e=Math.ceil(this._htLayerOption.width/this._nTileWidth)+2,f=Math.ceil(this._htLayerOption.height/this._nTileHeight)+2;d=(e+2*this._htOption.cacheTileSize)*(f+2*this._htOption.cacheTileSize)}this._oContainer.set({width:a,height:b,useCache:c}),this._oPool.changeSize(d),c?this._prepareTileWithCache():this._prepareTile()},unsetLayer:function(){null!==this._oLayer&&(this._oLayer.detach("resize",this._fOnResize),this._htOption.useEvent&&(this._oLayer.detach("mousemove",this._fOnMousemove),this._oLayer.detach("mouseup",this._fOnMouseup),this._oLayer.detach("mousedown",this._fOnMousedown),this._oLayer.detach("click",this._fOnClick)),this._oContainer.leave(),this._oLayer=null,this._sRenderingMode=null)},setObjectLayer:function(a){null!==this._oObjectLayer&&this.unsetObjectLayer(),this._oObjectLayer=a,this._oObjectContainer.addTo(this._oObjectLayer),this._oObjectContainer.set({width:this._oObjectLayer._htOption.width,height:this._oObjectLayer._htOption.height})},unsetObjectLayer:function(){null!==this._oObjectLayer&&(this._oObjectContainer.leave(),this._oObjectLayer=null)},getContainer:function(){return this._oContainer},getObjectContainer:function(){return this._oObjectContainer},setPosition:function(a,b){return this._bLockScreen?!1:(this._htOption.useLimitMoving&&(a=Math.max(-this._nColLength*this._nTileWidth+this._htLayerOption.width,a),b=Math.max(-this._nRowLength*this._nTileHeight+this._htLayerOption.height,b),a=Math.min(0,a),b=Math.min(0,b)),a=Math.round(a),b=Math.round(b),this._oContainer.set("x",a),this._oContainer.set("y",b),this._htEventInfo.x=a,this._htEventInfo.y=b,null!==this._oObjectLayer&&(this._oObjectContainer.set("x",a),this._oObjectContainer.set("y",b)),void 0)},getPosition:function(){return{x:this._htContainerInfo.x,y:this._htContainerInfo.y}},getTileXLength:function(){return this._nColLength},getTileYLength:function(){return this._nRowLength},setMapData:function(a){this._aMapData=a;for(var b=0,c=this._aMapData.length;c>b;b++)for(var d=0,e=this._aMapData[b].length;e>d;d++)this._appendTileOption(d,b,this._aMapData[b][d]);this._cacheTileLength(),this._prepareStage()},unsetMapData:function(){this._aMapData=null},addTile:function(a,b,c){c=c||{},this._aMapData[b]=this._aMapData[b]||[],this._aMapData[b][a]&&this.removeTile(a,b),this._appendTileOption(a,b,c),this._aMapData[b][a]=c,this._cacheTileLength()},_appendTileOption:function(a,b,c){c.width=this._nTileWidth,c.height=this._nTileHeight,c.x=a*this._nTileWidth,c.y=b*this._nTileHeight,c.tileX=a,c.tileY=b},addObject:function(a,b,c){"undefined"!=typeof c._htOption.tileX&&null!==c._htOption.tileX&&this.removeObject(c),c.set("mapObject",this),this._addObjectToTile(a,b,c)},isVisibleOffset:function(a,b){return this._htOption.useCache&&"canvas"===this._sRenderingMode||this._htEventInfo.startTileX<=a&&this._htEventInfo.endTileX>=a&&this._htEventInfo.startTileY<=b&&this._htEventInfo.endTileY>=b},_addObjectToTile:function(a,b,c){this._htObject[b]=this._htObject[b]||{},this._htObject[b][a]=this._htObject[b][a]||[],this._htObject[b][a].push(c),c.set("tileX",a),c.set("tileY",b),!c.getParent()&&this.isVisibleOffset(a,b)&&c.addTo(this._oObjectContainer)},moveObject:function(a,b,c){"undefined"!=typeof c._htOption.tileX&&null!==c._htOption.tileX&&(this._removeObjectFromTile(c,this.isVisibleOffset(a,b)),this._addObjectToTile(a,b,c))},removeObject:function(a){a.leave(),a.set("mapObject",null),this._removeObjectFromTile(a)},_removeObjectFromTile:function(a,b){var c=a._htOption.tileX,d=a._htOption.tileY;if(a.set("tileX",null),a.set("tileY",null),this._htObject[d]&&this._htObject[d][c])for(var e=0,f=this._htObject[d][c].length;f>e;e++)if(this._htObject[d][c][e]===a){this._htObject[d][c].splice(e,1);break}b||this.isVisibleOffset(c,d)||!a.getParent()||a.leave()},lock:function(){return this._bLockScreen=!0,this},unlock:function(){return this._bLockScreen=!1,this},_getTileZIndex:function(a,b){return 10+b},_cacheTileLength:function(){this._nRowLength=this._aMapData.length,this._nColLength=this._aMapData[this._nRowLength-1].length},removeTile:function(a,b){this._aMapData[b]&&this._aMapData[b][a]&&delete this._aMapData[b][a]},changeTile:function(a,b,c){var d=this.getTile(a,b);if(d&&c){for(var e in c)d[e]=c[e];this._htTile[b]&&this._htTile[b][a]&&this._htTile[b][a].set(c)}},getTile:function(a,b){return this._aMapData[b]&&this._aMapData[b][a]?this._aMapData[b][a]:!1},getSurroundedTiles:function(a,b){var c=[],d=this.getTile(a,b-1),e=this.getTile(a,b+1),f=this.getTile(a-1,b),g=this.getTile(a+1,b);return d&&c.push(d),g&&c.push(g),e&&c.push(e),f&&c.push(f),c},getObjects:function(a,b){return this._htObject[b]&&this._htObject[b][a]?this._htObject[b][a]:!1},getObject:function(a,b,c){if(this.hasObject(a,b))for(var d=0,e=this._htObject[b][a].length;e>d;d++)if(c(this._htObject[b][a][d])===!0)return this._htObject[b][a][d];return!1},hasObject:function(a,b,c){var d=this._htObject[b]&&this._htObject[b][a]&&this._htObject[b][a].length;if(d&&c){for(var e=0,f=this._htObject[b][a].length;f>e;e++)if(c(this._htObject[b][a][e])===!0)return!0;return!1}return d},_enterObject:function(a,b){var c=this.getObjects(a,b);if(c)for(var d=0,e=c.length;e>d;d++)c[d].addTo(this._oObjectContainer)},_leaveObject:function(a,b){var c=this.getObjects(a,b);if(c)for(var d=0,e=c.length;e>d;d++)c[d].leave()},getTileIndexToPos:function(a,b){return{x:a*this._nTileWidth,y:b*this._nTileHeight}},getPosToTileIndex:function(a,b){return{tileX:Math.floor(a/this._nTileWidth),tileY:Math.floor(b/this._nTileHeight)}},_setterUseEvent:function(a){null!==this._oLayer&&(a?(this._oLayer.attach("mousemove",this._fOnMousemove),this._oLayer.attach("mouseup",this._fOnMouseup),this._oLayer.attach("mousedown",this._fOnMousedown),this._oLayer.attach("click",this._fOnClick)):(this._oLayer.detach("mousemove",this._fOnMousemove),this._oLayer.detach("mouseup",this._fOnMouseup),this._oLayer.detach("mousedown",this._fOnMousedown),this._oLayer.detach("click",this._fOnClick)))
},_onMousemove:function(a){this._bIsMousedown&&this.fireEvent("mapmove",this._htEventInfo)!==!1&&this.setPosition(this._nStartContainerX+(a.x-this._nStartMouseX),this._nStartContainerY+(a.y-this._nStartMouseY))},_onMousedown:function(a){this._htEventInfo.eventX=a.x,this._htEventInfo.eventY=a.y,this.fireEvent("mapdown",this._htEventInfo)!==!1&&(this._bIsMousedown=!0,this._nStartMouseX=a.x,this._nStartMouseY=a.y,this._nStartContainerX=this._htContainerInfo.x,this._nStartContainerY=this._htContainerInfo.y,!this._htOption.useLiveUpdate||this._htOption.useCache&&"canvas"===this._sRenderingMode||this._oTimerUpdate.start())},_onMouseup:function(a){this._bIsMousedown&&(this._nStartMouseX=null,this._nStartMouseY=null,this._nStartContainerX=null,this._nStartContainerY=null,this._bIsMousedown=!1,this._htOption.useLiveUpdate?this._oTimerUpdate.pause():this._htOption.useCache&&"canvas"===this._sRenderingMode||this._prepareTile(),this._htEventInfo.eventX=a.x,this._htEventInfo.eventY=a.y,this.fireEvent("mapup",this._htEventInfo))},_onClick:function(a){var b=a.x-this._htContainerInfo.x,c=a.y-this._htContainerInfo.y,d=this.getPosToTileIndex(b,c);this._htEventInfo.eventX=a.x,this._htEventInfo.eventY=a.y,this._htEventInfo.tileX=d.tileX,this._htEventInfo.tileY=d.tileY,this.fireEvent("mapclick",this._htEventInfo)},_onResize:function(){null!==this._oObjectLayer&&this._oObjectContainer.set({width:this._oObjectLayer._htOption.width,height:this._oObjectLayer._htOption.height}),this._prepareStage()},_createTile:function(a,b){if((!this._htTile[b]||!this._htTile[b][a])&&this._aMapData[b]&&this._aMapData[b][a]){var c=this._oPool.get().addTo(this._oContainer);c.set(this._aMapData[b][a]),this._htTile[b]=this._htTile[b]||{},this._htTile[b][a]=this._htTile[b][a]=c,this._aTiles.push(c),this._enterObject(a,b)}},_releaseTiles:function(a,b,c,d){for(var e,f=!1,g=0;g<this._aTiles.length;g++)e=this._aTiles[g],(a>e._htOption.tileX||e._htOption.tileX>c||b>e._htOption.tileY||e._htOption.tileY>d)&&(delete this._htTile[e._htOption.tileY][e._htOption.tileX],this._oPool.release(e),this._aTiles.splice(g,1),this._leaveObject(e._htOption.tileX,e._htOption.tileY),g--,f=!0);return f},_prepareTileWithCache:function(){for(var a=0;a<this._nRowLength;a++)for(var b=0;b<this._nColLength;b++)this._createTile(b,a);this.fireEvent("mapchange",this._htEventInfo)},_prepareTile:function(){if(!this._aMapData.length)return!1;var a=Math.max(0,Math.floor(-this._htContainerInfo.x/this._nTileWidth)-this._htOption.cacheTileSize),b=Math.max(0,Math.floor(-this._htContainerInfo.y/this._nTileHeight)-this._htOption.cacheTileSize),c=Math.min(this._nColLength-1,Math.floor((-this._htContainerInfo.x+this._htLayerOption.width)/this._nTileWidth)+this._htOption.cacheTileSize),d=Math.min(this._nRowLength-1,Math.floor((-this._htContainerInfo.y+this._htLayerOption.height)/this._nTileHeight)+this._htOption.cacheTileSize);this._htEventInfo.startTileX=a,this._htEventInfo.startTileY=b,this._htEventInfo.endTileX=c,this._htEventInfo.endTileY=d;for(var e=this._releaseTiles(a,b,c,d),f=b;d>=f;f++)for(var g=a;c>=g;g++)this._createTile(g,f);e&&this.fireEvent("mapchange",this._htEventInfo)},getTileCountOnScreen:function(){var a=Math.ceil(this._htLayerOption.width/this._nTileWidth)+2,b=Math.ceil(this._htLayerOption.height/this._nTileHeight)+2;return a*b}},collie.Component),collie.PathFinding=collie.Class({$init:function(a,b){this._oMap=a,this._fBeforeMove=b},find:function(a,b,c,d){var e=Math.max(this._oMap.getTileCountOnScreen(),Math.pow(2*collie.util.getDistance(a,b,c,d),2)),f=0,g=a,h=b,i=[];for(this._sFilter="";g!==c||h!==d;){if(f++,f>e)return!1;for(var j=this._oMap.getSurroundedTiles(g,h),k=null,l=null,m=0,n=j.length;n>m;m++)if(j[m]&&this.beforeMove(j[m])&&!this._isInFilter(j[m])){var o=collie.util.getDistance(j[m].tileX,j[m].tileY,c,d);(null===l||k>o)&&(k=o,l=j[m])}if(null===l){if(this._sFilter+="["+g+","+h+"]",i.length>0){var p=i.pop();g=p[0],h=p[1];continue}return!1}g=l.tileX,h=l.tileY,i.push([g,h]),this._sFilter+="["+g+","+h+"]"}return i.length>0?i:!1},beforeMove:function(a){return this._fBeforeMove(a,this._oMap)===!1?!1:!0},getMap:function(){return this._oMap},_isInFilter:function(a){return-1!==this._sFilter.indexOf("["+a.tileX+","+a.tileY+"]")}},collie.Component);